UPDATE `{$p}emailtemplate`  
   SET `emailtemplate_vqmod` = '&lt;file name=&quot;admin/controller/sale/order.php&quot;&gt;\r\n	&lt;operation&gt;\r\n		&lt;search position=&quot;after&quot;&gt;&lt;![CDATA[\r\n            $this-&gt;data[''entry_notify''] = $this-&gt;language-&gt;get(''entry_notify''); ]]&gt;&lt;/search&gt;\r\n		&lt;add&gt;&lt;![CDATA[\r\n            $this-&gt;data[''entry_summary''] = $this-&gt;language-&gt;get(''entry_summary'');\r\n            $this-&gt;data[''entry_show_products''] = $this-&gt;language-&gt;get(''entry_show_products'');\r\n            $this-&gt;data[''entry_show_totals''] = $this-&gt;language-&gt;get(''entry_show_totals'');\r\n            $this-&gt;data[''entry_show_downloads''] = $this-&gt;language-&gt;get(''entry_show_downloads'');\r\n            $this-&gt;data[''entry_show_vouchers''] = $this-&gt;language-&gt;get(''entry_show_vouchers'');\r\n            $this-&gt;data[''entry_template''] = $this-&gt;language-&gt;get(''entry_template'');\r\n            $this-&gt;data[''entry_pdf_attach''] = $this-&gt;language-&gt;get(''entry_pdf_attach'');\r\n            $this-&gt;data[''text_select''] = $this-&gt;language-&gt;get(''text_select'');\r\n			$this-&gt;data[''text_preview''] = $this-&gt;language-&gt;get(''text_preview'');\r\n			$this-&gt;data[''warning_template_content''] = $this-&gt;language-&gt;get(''warning_template_content'');\r\n\r\n			$this-&gt;data[''language_id''] = $order_info[''language_id''];\r\n			$this-&gt;data[''store_id''] = $order_info[''store_id''];\r\n            \r\n			$this-&gt;load-&gt;model(''localisation/language'');\r\n			$this-&gt;load-&gt;model(''module/emailtemplate'');\r\n\r\n            $templates = $this-&gt;model_module_emailtemplate-&gt;getTemplates(array(\r\n				''emailtemplate_key'' =&gt; ''admin.order_update''\r\n			));\r\n\r\n			$this-&gt;data[''templates_options''] = array();\r\n\r\n			foreach($templates as $row){\r\n				$label = $row[''emailtemplate_label''];\r\n\r\n				if($row[''emailtemplate_default'']){\r\n					$label = $this-&gt;language-&gt;get(''text_default'') . '' - '' . $label;\r\n				}\r\n\r\n				$this-&gt;data[''templates_options''][] = array(\r\n					''value'' =&gt; $row[''emailtemplate_id''],\r\n					''label'' =&gt; $label\r\n				);\r\n			}\r\n\r\n            $this-&gt;data[''templates_action''] = $this-&gt;url-&gt;link(''module/emailtemplate/fetch_template'', ''output=comment&amp;token=''.$this-&gt;session-&gt;data[''token''], ''SSL'');\r\n \r\n			$this-&gt;data[''pdf_download''] = $this-&gt;url-&gt;link(''module/emailtemplate/preview_invoice'', ''token=''.$this-&gt;session-&gt;data[''token''].''&amp;order_id=''.$order_id, ''SSL''); ]]&gt;&lt;/add&gt;\r\n	&lt;/operation&gt;\r\n	&lt;operation error=&quot;skip&quot;&gt;\r\n		&lt;search position=&quot;replace&quot;&gt;&lt;![CDATA[\r\n            nl2br($result[''comment'']) ]]&gt;&lt;/search&gt;\r\n		&lt;add trim=&quot;true&quot;&gt;&lt;![CDATA[\r\n            (EmailTemplate::isHTML($result[''comment''])) ? html_entity_decode($result[''comment''], ENT_QUOTES, ''UTF-8'') : nl2br($result[''comment''], true) ]]&gt;&lt;/add&gt;\r\n	&lt;/operation&gt;\r\n	&lt;operation&gt;\r\n		&lt;search error=&quot;skip&quot; position=&quot;replace&quot;&gt;&lt;![CDATA[\r\n            nl2br($order_info[''comment'']) ]]&gt;&lt;/search&gt;\r\n		&lt;add trim=&quot;true&quot;&gt;&lt;![CDATA[\r\n            (EmailTemplate::isHTML($order_info[''comment''])) ? html_entity_decode($order_info[''comment''], ENT_QUOTES, ''UTF-8'') : nl2br($order_info[''comment''], true) ]]&gt;&lt;/add&gt;\r\n	&lt;/operation&gt;\r\n&lt;/file&gt;\r\n		\r\n&lt;file name=&quot;admin/view/template/sale/order_info.tpl&quot;&gt;\r\n	&lt;operation&gt;\r\n		&lt;search position=&quot;before&quot;&gt;&lt;![CDATA[\r\n            &lt;?php echo $footer; ?&gt; ]]&gt;&lt;/search&gt;\r\n		&lt;add&gt;&lt;![CDATA[			\r\n&lt;script type=&quot;text/javascript&quot; src=&quot;view/javascript/ckeditor/ckeditor.js&quot;&gt;&lt;/script&gt;\r\n&lt;script type=&quot;text/javascript&quot;&gt;&lt;!--\r\n(function($){\r\n\r\n	// Order history show/hide summary options\r\n	function showEmailOptions($row, $checkbox){\r\n		if($checkbox.is('':checked'')) { \r\n			$row.show(); \r\n		} else { \r\n			$row.hide(); \r\n		}\r\n	}				\r\n	\r\n	$(document).ready(function() {\r\n		$(''input[name=notify]'').eq(0).each(function(){\r\n			showEmailOptions($(''.emailOptions''), $(this));\r\n		}).change(function(){\r\n			showEmailOptions($(''.emailOptions''), $(this));\r\n		});\r\n		\r\n   		$(''select#field_templates'').change(function(){			\r\n			var val = $(this).val();\r\n			if (!val || !confirm(&quot;&lt;?php echo $warning_template_content; ?&gt;&quot;)) return;\r\n			$.ajax({\r\n				url: ''&lt;?php echo html_entity_decode($templates_action); ?&gt;'',\r\n	  			type: ''get'',\r\n				data: ''id='' + val + ''&amp;store_id=&lt;?php echo $store_id; ?&gt;'' + ''&amp;language_id=&lt;?php echo $language_id; ?&gt;'' + ''&amp;order_id=&lt;?php echo $order_id; ?&gt;'',\r\n				dataType: ''html'',\r\n	  			success: function(html) {\r\n					$(''textarea[name=comment]'').val(html);\r\n					if(typeof CKEDITOR !== &quot;undefined&quot;){\r\n						CKEDITOR.instances[''comment''].setData(html);\r\n					}\r\n				},\r\n				error: function(xhr, ajaxOptions, thrownError) {\r\n					console.log(thrownError + &quot;\\r\\n&quot; + xhr.statusText + &quot;\\r\\n&quot; + xhr.responseText);\r\n					alert(''Error. More details in console.'');\r\n				}\r\n			});	\r\n		});\r\n 	}); // doc.ready\r\n})(jQuery);		\r\n			\r\nif(typeof CKEDITOR !== &quot;undefined&quot;){\r\n	CKEDITOR.replace(''comment'', {\r\n		filebrowserImageBrowseUrl: ''index.php?route=common/filemanager&amp;token=&lt;?php echo $token; ?&gt;'',\r\n		filebrowserUploadUrl: ''index.php?route=common/filemanager&amp;token=&lt;?php echo $token; ?&gt;'',\r\n		filebrowserImageUploadUrl: ''index.php?route=common/filemanager&amp;token=&lt;?php echo $token; ?&gt;''\r\n	});\r\n\r\n	// Output dimensions of images as width and height\r\n	CKEDITOR.on(''instanceReady'', function (ev) {\r\n		ev.editor.dataProcessor.htmlFilter.addRules({\r\n			elements: {\r\n				$: function(element){                \r\n					if (element.name == ''img'') {\r\n						var style = element.attributes.style;\r\n\r\n						if (style) {\r\n							// Get the width from the style.\r\n							var match = /(?:^|\\s)width\\s*:\\s*(\\d+)px/i.exec(style),\r\n								width = match &amp;&amp; match[1];\r\n\r\n							// Get the height from the style.\r\n							match = /(?:^|\\s)height\\s*:\\s*(\\d+)px/i.exec(style);\r\n							var height = match &amp;&amp; match[1];\r\n\r\n							if (width) {\r\n								element.attributes.style = element.attributes.style.replace(/(?:^|\\s)width\\s*:\\s*(\\d+)px;?/i, '''');\r\n								element.attributes.width = width;\r\n							}\r\n\r\n							if (height) {\r\n								element.attributes.style = element.attributes.style.replace(/(?:^|\\s)height\\s*:\\s*(\\d+)px;?/i, '''');\r\n								element.attributes.height = height;\r\n							}\r\n						}\r\n					}\r\n\r\n					if (!element.attributes.style) delete element.attributes.style;\r\n\r\n					return element;\r\n				}\r\n			}\r\n		});\r\n	});\r\n} // CKEDITOR\r\n//--&gt;&lt;/script&gt; ]]&gt;&lt;/add&gt;\r\n	&lt;/operation&gt;\r\n	&lt;operation info=&quot;Add checkboxes into ajax post data&quot;&gt;\r\n		&lt;search position=&quot;replace&quot;&gt;&lt;![CDATA[\r\n            + ''&amp;notify='' ]]&gt;&lt;/search&gt;\r\n		&lt;add trim=&quot;true&quot;&gt;&lt;![CDATA[\r\n            &lt;?php if(!empty($products)){ ?&gt;+ ($(''input[name=\\''show_products\\'']'').attr(''checked'') ? ''&amp;show_products=1'' : '''')&lt;?php }\r\n            if(!empty($downloads)){ ?&gt;+ ($(''input[name=\\''show_downloads\\'']'').attr(''checked'') ? ''&amp;show_downloads=1'' : '''')&lt;?php }\r\n            if(!empty($vouchers)){ ?&gt;+ ($(''input[name=\\''show_vouchers\\'']'').attr(''checked'') ? ''&amp;show_vouchers=1'' : '''')&lt;?php } \r\n            if(!empty($totals)){ ?&gt;+ ($(''input[name=\\''show_totals\\'']'').attr(''checked'') ? ''&amp;show_totals=1'' : '''')&lt;?php } ?&gt;\r\n            + ($(''input[name=\\''attach_invoice_pdf\\'']'').attr(''checked'') ? ''&amp;attach_invoice_pdf=1'' : '''') \r\n			+ ($(''select[name=\\''field_template\\'']'').val() ? ''&amp;field_template='' + $(''select[name=\\''field_template\\'']'').val() : '''')\r\n			+ ''&amp;notify='' ]]&gt;&lt;/add&gt;\r\n	&lt;/operation&gt;\r\n	&lt;operation error=&quot;skip&quot;&gt;\r\n		&lt;search position=&quot;after&quot;&gt;&lt;![CDATA[\r\n            $(''#button-history'').live(''click'', function() { ]]&gt;&lt;/search&gt;\r\n		&lt;add&gt;&lt;![CDATA[            if(typeof CKEDITOR !== &quot;undefined&quot;)\r\n									CKEDITOR.instances.comment.updateElement(); ]]&gt;&lt;/add&gt;\r\n	&lt;/operation&gt;\r\n	&lt;operation error=&quot;skip&quot; info=&quot;Old versions opencart&quot;&gt;\r\n		&lt;search position=&quot;after&quot;&gt;&lt;![CDATA[\r\n            function history() { ]]&gt;&lt;/search&gt;\r\n		&lt;add&gt;&lt;![CDATA[            if(typeof CKEDITOR !== &quot;undefined&quot;) \r\n									CKEDITOR.instances.comment.updateElement(); ]]&gt;&lt;/add&gt;\r\n	&lt;/operation&gt;\r\n	&lt;operation error=&quot;skip&quot;&gt;\r\n		&lt;search position=&quot;before&quot;&gt;&lt;![CDATA[\r\n            $(''textarea[name=\\''comment\\'']'').val(''''); ]]&gt;&lt;/search&gt;\r\n		&lt;add&gt;&lt;![CDATA[            if(typeof CKEDITOR !== &quot;undefined&quot;)\r\n								  	CKEDITOR.instances.comment.setData('''');            \r\n            $(''.emailOptions input[type=checkbox], .emailOptions input[type=radio], input[name=notify]'').removeAttr(''checked'');\r\n           	$(''.emailOptions option'').removeAttr(''selected'');\r\n           	$(''.emailOptions'').hide(); ]]&gt;&lt;/add&gt;\r\n	&lt;/operation&gt;\r\n	&lt;operation info=&quot;Add order summary option&quot;&gt;\r\n		&lt;search position=&quot;after&quot;&gt;&lt;![CDATA[\r\n            &lt;td&gt;&lt;input type=&quot;checkbox&quot; name=&quot;notify&quot; value=&quot;1&quot; /&gt;&lt;/td&gt; ]]&gt;&lt;/search&gt;\r\n		&lt;add&gt;&lt;![CDATA[\r\n          &lt;/tr&gt;\r\n          &lt;tr class=&quot;emailOptions&quot; style=&quot;display: none&quot;&gt;\r\n            &lt;td&gt;&lt;?php echo $entry_summary; ?&gt;&lt;/td&gt;\r\n            &lt;td&gt;\r\n            	&lt;?php if(!empty($products)){ ?&gt;\r\n            		&lt;label&gt;&lt;input type=&quot;checkbox&quot; name=&quot;show_products&quot; value=&quot;1&quot; style=&quot;vertical-align: middle;&quot; /&gt; &lt;?php echo $entry_show_products; ?&gt;&lt;/label&gt;&lt;br /&gt;\r\n           		&lt;?php } ?&gt;\r\n            	&lt;?php if(!empty($totals)){ ?&gt;\r\n            		&lt;hr style=&quot;border-top: 1px dotted #ccc; background: none; border-bottom: none; border-left: none; border-right: none; margin: 0;&quot; /&gt;\r\n            		&lt;label&gt;&lt;input type=&quot;checkbox&quot; name=&quot;show_totals&quot; value=&quot;1&quot; style=&quot;vertical-align: middle;&quot; /&gt; &lt;?php echo $entry_show_totals; ?&gt;&lt;/label&gt;&lt;br /&gt;\r\n           		&lt;?php } ?&gt;\r\n	         	&lt;?php if(!empty($downloads)){ ?&gt;\r\n	         		&lt;hr style=&quot;border-top: 1px dotted #ccc; background: none; border-bottom: none; border-left: none; border-right: none; margin: 0;&quot; /&gt;\r\n	         		&lt;label&gt;&lt;input type=&quot;checkbox&quot; name=&quot;show_downloads&quot; value=&quot;1&quot; style=&quot;vertical-align: middle;&quot; /&gt; &lt;?php echo $entry_show_downloads; ?&gt;&lt;/label&gt;&lt;br /&gt;\r\n         		&lt;?php } ?&gt;\r\n	         	&lt;?php if(!empty($vouchers)){ ?&gt;\r\n	         		&lt;hr style=&quot;border-top: 1px dotted #ccc; background: none; border-bottom: none; border-left: none; border-right: none; margin: 0;&quot; /&gt;\r\n	         		&lt;label&gt;&lt;input type=&quot;checkbox&quot; name=&quot;show_vouchers&quot; value=&quot;1&quot; style=&quot;vertical-align: middle;&quot; /&gt; &lt;?php echo $entry_show_vouchers; ?&gt;&lt;/label&gt;\r\n         		&lt;?php } ?&gt;\r\n   			&lt;/td&gt;\r\n          &lt;/tr&gt;\r\n          &lt;tr class=&quot;emailOptions&quot; style=&quot;display: none&quot;&gt;\r\n            &lt;td&gt;\r\n            	&lt;?php echo $entry_pdf_attach; ?&gt;&lt;br /&gt;\r\n            	[&lt;a href=&quot;&lt;?php echo $pdf_download; ?&gt;&quot; target=&quot;_blank&quot;&gt;&lt;?php echo $text_preview; ?&gt;&lt;/a&gt;]\r\n           	&lt;/td&gt;\r\n            &lt;td&gt;\r\n         		&lt;label&gt;&lt;input type=&quot;checkbox&quot; name=&quot;attach_invoice_pdf&quot; value=&quot;1&quot; style=&quot;vertical-align: middle;&quot; /&gt;&lt;/label&gt;\r\n			&lt;/td&gt;   \r\n  	 	  &lt;?php if(!empty($templates_options)){ ?&gt;			\r\n          &lt;/tr&gt;\r\n          &lt;tr class=&quot;emailOptions&quot; style=&quot;display: none&quot;&gt;\r\n            &lt;td&gt;&lt;?php echo $entry_template; ?&gt;&lt;/td&gt;\r\n            &lt;td&gt;\r\n            	&lt;select id=&quot;field_templates&quot; name=&quot;field_template&quot;&gt;\r\n	 				&lt;option value=''''&gt;&lt;?php echo $text_select; ?&gt;&lt;/option&gt;\r\n	            	&lt;?php foreach($templates_options as $item){ ?&gt;\r\n	            		&lt;option value=&quot;&lt;?php echo $item[''value'']; ?&gt;&quot;&gt;&lt;?php echo $item[''label'']; ?&gt;&lt;/option&gt;\r\n	            	&lt;?php } ?&gt;\r\n            	&lt;/select&gt;\r\n 			&lt;/td&gt; \r\n		  &lt;?php } ?&gt; ]]&gt;&lt;/add&gt;\r\n	&lt;/operation&gt;\r\n&lt;/file&gt;\r\n\r\n&lt;file name=&quot;admin/model/sale/order.php&quot;&gt;\r\n	&lt;operation&gt;\r\n		&lt;search position=&quot;after&quot; index=&quot;1&quot;&gt;&lt;![CDATA[\r\n            $this-&gt;db-&gt;query(&quot;INSERT INTO &quot; . DB_PREFIX . &quot;order_history ]]&gt;&lt;/search&gt;\r\n		&lt;add&gt;&lt;![CDATA[		$order_history_id = $this-&gt;db-&gt;getLastId();]]&gt;&lt;/add&gt;\r\n	&lt;/operation&gt;\r\n	&lt;operation&gt;\r\n		&lt;search position=&quot;after&quot;&gt;&lt;![CDATA[\r\n            if ($data[''notify'']) ]]&gt;&lt;/search&gt;\r\n		&lt;add&gt;&lt;![CDATA[\r\n            $template = new EmailTemplate($this-&gt;request, $this-&gt;registry);\r\n     \r\n			$template-&gt;data[''payment_address''] = EmailTemplate::formatAddress($order_info, ''payment'', $order_info[''payment_address_format'']);\r\n			\r\n			$template-&gt;data[''shipping_address''] = EmailTemplate::formatAddress($order_info, ''shipping'', $order_info[''shipping_address_format'']);			\r\n			if($template-&gt;data[''shipping_address''] == ''''){\r\n				$template-&gt;data[''shipping_address''] = $template-&gt;data[''payment_address''];\r\n			}\r\n\r\n            $template-&gt;data[''products''] = array();  \r\n            if(isset($data[''show_products''])){ \r\n            	$this-&gt;load-&gt;model(''tool/image'');  \r\n            	$this-&gt;load-&gt;model(''catalog/product'');  \r\n				$products = $this-&gt;model_sale_order-&gt;getOrderProducts($this-&gt;request-&gt;get[''order_id'']);	\r\n				\r\n				foreach ($products as $product) {\r\n					$product = array_merge($this-&gt;model_catalog_product-&gt;getProduct($product[''product_id'']), $product);\r\n				\r\n					// Product Options\r\n					$option_data = array();	\r\n					$options = $this-&gt;model_sale_order-&gt;getOrderOptions($this-&gt;request-&gt;get[''order_id''], $product[''order_product_id'']);	\r\n					foreach ($options as $option) {\r\n						if ($option[''type''] != ''file'') {\r\n							$option_data[] = array(\r\n								''name''  =&gt; $option[''name''],\r\n								''value'' =&gt; $option[''value''],\r\n								''type''  =&gt; $option[''type'']\r\n							);\r\n						} else {\r\n							$option_data[] = array(\r\n								''name''  =&gt; $option[''name''],\r\n								''value'' =&gt; substr($option[''value''], 0, strrpos($option[''value''], ''.'')),\r\n								''type''  =&gt; $option[''type''],\r\n								''href''  =&gt; $this-&gt;url-&gt;link(''sale/order/download'', ''token='' . $this-&gt;session-&gt;data[''token''] . ''&amp;order_id='' . $this-&gt;request-&gt;get[''order_id''] . ''&amp;order_option_id='' . $option[''order_option_id''], ''SSL'')\r\n							);						\r\n						}\r\n					}\r\n					\r\n					if (isset($product[''image''])) {\r\n						$image = $this-&gt;model_tool_image-&gt;resize($product[''image''], 50, 50);\r\n					} else {\r\n						$image = '''';\r\n					}\r\n\r\n					$url = $order_info[''store_url''] . ''?route=product/product&amp;product_id=''.$product[''product_id''];\r\n	\r\n					$template-&gt;data[''products''][] = array(\r\n						''url''     		=&gt; $url,\r\n						''url_tracking'' 	=&gt; $template-&gt;getTracking($url),\r\n						''order_product_id'' =&gt; $product[''order_product_id''],\r\n						''product_id''       =&gt; $product[''product_id''],\r\n						''name''    	 	   =&gt; $product[''name''],\r\n						''model''    		   =&gt; $product[''model''],\r\n						''image''    		   =&gt; $image,\r\n						''option''   		   =&gt; $option_data,\r\n						''quantity''		   =&gt; $product[''quantity''],\r\n						''price''    		   =&gt; $this-&gt;currency-&gt;format($product[''price''] + ($this-&gt;config-&gt;get(''config_tax'') ? $product[''tax''] : 0), $order_info[''currency_code''], $order_info[''currency_value'']),\r\n						''total''    		   =&gt; $this-&gt;currency-&gt;format($product[''total''] + ($this-&gt;config-&gt;get(''config_tax'') ? ($product[''tax''] * $product[''quantity'']) : 0), $order_info[''currency_code''], $order_info[''currency_value'']),\r\n						''href''     		   =&gt; $this-&gt;url-&gt;link(''catalog/product/update'', ''token='' . $this-&gt;session-&gt;data[''token''] . ''&amp;product_id='' . $product[''product_id''], ''SSL'')\r\n					);\r\n				}\r\n			} // Products\r\n			\r\n			$template-&gt;data[''vouchers''] = array();\r\n			if(isset($data[''show_vouchers''])){\r\n				$vouchers = $this-&gt;model_sale_order-&gt;getOrderVouchers($this-&gt;request-&gt;get[''order_id'']);			 \r\n				foreach ($vouchers as $voucher) {\r\n					$template-&gt;data[''vouchers''][] = array(\r\n						''description'' =&gt; $voucher[''description''],\r\n						''amount''      =&gt; $this-&gt;currency-&gt;format($voucher[''amount''], $order_info[''currency_code''], $order_info[''currency_value'']),\r\n						''href''        =&gt; $this-&gt;url-&gt;link(''sale/voucher/update'', ''token='' . $this-&gt;session-&gt;data[''token''] . ''&amp;voucher_id='' . $voucher[''voucher_id''], ''SSL'')\r\n					);\r\n				}\r\n			} // Vouchers\r\n			\r\n			$template-&gt;data[''totals''] = array();\r\n			if(isset($data[''show_totals''])){\r\n				$template-&gt;data[''totals''] = $this-&gt;model_sale_order-&gt;getOrderTotals($this-&gt;request-&gt;get[''order_id'']);\r\n			} // Totals	\r\n			\r\n			$template-&gt;data[''downloads''] = array();\r\n			if(isset($data[''show_downloads''])){				\r\n				foreach ($products as $product) {\r\n					$results = $this-&gt;model_sale_order-&gt;getOrderDownloads($this-&gt;request-&gt;get[''order_id''], $product[''order_product_id'']);	\r\n					foreach ($results as $result) {\r\n						$template-&gt;data[''downloads''][] = array(\r\n							''name''      =&gt; $result[''name''],\r\n							''filename''  =&gt; $result[''mask''],\r\n							''remaining'' =&gt; $result[''remaining'']\r\n						);\r\n					}\r\n				}\r\n			} // Downloads	\r\n			\r\n			$attachments = array();\r\n			if(isset($data[''attach_invoice_pdf''])){\r\n				$this-&gt;load-&gt;model(''module/emailtemplate/invoice'');\r\n				$template-&gt;data[''emailtemplate_invoice_pdf''] = $this-&gt;model_module_emailtemplate_invoice-&gt;getInvoice($this-&gt;request-&gt;get[''order_id''], true);\r\n				$attachments[] = $template-&gt;data[''emailtemplate_invoice_pdf''];\r\n			} ]]&gt;&lt;/add&gt;\r\n	&lt;/operation&gt;\r\n	&lt;operation&gt;\r\n		&lt;search position=&quot;after&quot;&gt;&lt;![CDATA[\r\n            $message .= $language-&gt;get(''text_footer''); ]]&gt;&lt;/search&gt;\r\n		&lt;add&gt;&lt;![CDATA[  \r\n            if (!empty($template-&gt;data[''products''])) {\r\n            	$message .= &quot;\\n&quot; . $language-&gt;get(''text_products'') . &quot;\\n&quot;; \r\n	            foreach ($template-&gt;data[''products''] as $product) {\r\n	                $message .= $product[''quantity''] . ''x '' . $product[''name''] . '' ('' . $product[''model''] . '') '' . html_entity_decode($product[''total''], ENT_NOQUOTES, ''UTF-8'') . &quot;\\n&quot;;\r\n	                foreach ($product[''option''] as $option) {\r\n	                    $message .= chr(9) . ''-'' . $option[''name''] . '' '' . (strlen($option[''value'']) &gt; 20 ? substr($option[''value''], 0, 20) . ''..'' : $option[''value'']) . &quot;\\n&quot;;\r\n	                }\r\n            	}\r\n            }\r\n\r\n	        if (!empty($template-&gt;data[''vouchers''])) { \r\n	            foreach ($template-&gt;data[''vouchers''] as $voucher) {\r\n	                $message .= ''1x '' . $voucher[''description''] . '' '' . $this-&gt;currency-&gt;format($voucher[''amount''], $order_info[''currency_code''], $order_info[''currency_value'']);\r\n	            }\r\n            }\r\n            \r\n			if (!empty($template-&gt;data[''totals''])) {\r\n	            $message .= &quot;\\n&quot; . $language-&gt;get(''text_total'') . &quot;\\n&quot;;	\r\n	            foreach ($template-&gt;data[''totals''] as $total) {\r\n	                $message .= $total[''title''] . '': '' . html_entity_decode($total[''text''], ENT_NOQUOTES, ''UTF-8'') . &quot;\\n&quot;;\r\n	            }\r\n            }\r\n               \r\n            if (!empty($template-&gt;data[''downloads''])) {\r\n                $message .= &quot;\\n&quot; . $language-&gt;get(''text_download'') . &quot;\\n&quot;;\r\n                $message .= $order_info[''store_url''] . ''index.php?route=account/download'' . &quot;\\n\\n&quot;;\r\n            }\r\n\r\n			$template-&gt;addData($data);\r\n\r\n			$template-&gt;addData($order_info);\r\n             \r\n            $template-&gt;data[''new_comment''] = html_entity_decode($data[''comment''], ENT_QUOTES, ''UTF-8'');\r\n            $template-&gt;data[''invoice''] = html_entity_decode($order_info[''store_url''] . ''index.php?route=account/order/info&amp;order_id='' . $order_id, ENT_QUOTES, ''UTF-8'');\r\n			$template-&gt;data[''invoice_tracking''] = $template-&gt;getTracking($template-&gt;data[''invoice'']);\r\n\r\n			$template-&gt;data[''date_added''] = date($language-&gt;get(''date_format_short''), strtotime($order_info[''date_added'']));\r\n            \r\n			if ($order_status_query-&gt;num_rows) {\r\n            	$template-&gt;data[''order_status''] = $order_status_query-&gt;row[''name'']; \r\n			} ]]&gt;&lt;/add&gt;\r\n	&lt;/operation&gt;\r\n	&lt;operation&gt;\r\n		&lt;search position=&quot;replace&quot; index=&quot;1&quot;&gt;&lt;![CDATA[\r\n            $mail-&gt;send(); ]]&gt;&lt;/search&gt;\r\n		&lt;add&gt;&lt;![CDATA[			$template_data = array(''key'' =&gt;''admin.order_update'');\r\n			if(!empty($data[''field_template''])){\r\n				$template_data[''emailtemplate_id''] = $data[''field_template''];\r\n			}\r\n			if(!empty($data[''order_status_id''])){\r\n				$template_data[''order_status_id''] = $data[''order_status_id''];\r\n			}\r\n			if(isset($order_info[''store_id''])){\r\n				$template_data[''store_id''] = $order_info[''store_id''];\r\n			}\r\n			if(isset($order_info[''language_id''])){\r\n				$template_data[''language_id''] = $order_info[''language_id''];\r\n			}\r\n\r\n            $template-&gt;load($template_data);\r\n\r\n            $mail = $template-&gt;hook($mail);\r\n            foreach($attachments as $attachment){\r\n            	$mail-&gt;addAttachment($attachment);\r\n            } \r\n \r\n			$mail-&gt;send();\r\n\r\n			$template-&gt;sent(); ]]&gt;&lt;/add&gt;\r\n	&lt;/operation&gt;\r\n	&lt;operation error=&quot;skip&quot;&gt;\r\n		&lt;search position=&quot;replace&quot;&gt;&lt;![CDATA[\r\n            comment = ''&quot; . $this-&gt;db-&gt;escape(strip_tags($data[''comment''])) . &quot;'' ]]&gt;&lt;/search&gt;\r\n		&lt;add trim=&quot;true&quot;&gt;&lt;![CDATA[\r\n            comment = ''&quot; . $this-&gt;db-&gt;escape($data[''comment'']) . &quot;'' ]]&gt;&lt;/add&gt;\r\n	&lt;/operation&gt;\r\n    &lt;operation&gt;\r\n        &lt;search position=&quot;before&quot;&gt;&lt;![CDATA[\r\n            =&gt; $order_query-&gt;row[''payment_firstname''], ]]&gt;&lt;/search&gt;\r\n        &lt;add&gt;&lt;![CDATA[            	''invoice_filename'' 		   =&gt; $order_query-&gt;row[''invoice_filename''], ]]&gt;&lt;/add&gt;\r\n	&lt;/operation&gt;\r\n&lt;/file&gt;' 
 WHERE `emailtemplate_default` = 1 AND `emailtemplate_key` = 'admin.order_update';