UPDATE `{$p}emailtemplate`  
   SET `emailtemplate_vqmod` = '&lt;file name=&quot;catalog/model/account/customer.php&quot;&gt;\r\n	&lt;operation&gt;\r\n		&lt;search position=&quot;after&quot;&gt;&lt;![CDATA[ $this-&gt;language-&gt;load(''mail/customer''); ]]&gt;&lt;/search&gt;\r\n		&lt;add&gt;&lt;![CDATA[\r\n		$template = new EmailTemplate($this-&gt;request, $this-&gt;registry);\r\n					\r\n		$template-&gt;addData($data); \r\n\r\n		$template-&gt;data[''newsletter''] = $this-&gt;language-&gt;get((isset($data[''newsletter'']) &amp;&amp; $data[''newsletter''] == 1) ? ''text_yes'' : ''text_no'');\r\n		$template-&gt;data[''account_login''] = $this-&gt;url-&gt;link(''account/login'', ''email='' . $data[''email''], ''SSL'');\r\n		$template-&gt;data[''account_login_tracking''] = $template-&gt;getTracking($template-&gt;data[''account_login'']);\r\n		$template-&gt;data[''customer_group''] = (isset($customer_group_info[''name''])) ? $customer_group_info[''name''] : '''';\r\n\r\n		$this-&gt;load-&gt;model(''account/address'');\r\n		$customer_address = $this-&gt;model_account_address-&gt;getAddressNotLoggedIn($address_id, $customer_id);\r\n			\r\n		$template-&gt;data[''address''] = EmailTemplate::FormatAddress($customer_address, '''', $customer_address[''address_format'']);\r\n\r\n        if((isset($customer_group_info[''approval'']) &amp;&amp; $customer_group_info[''approval'']) || $this-&gt;config-&gt;get(''config_customer_approval'')){\r\n         	$template-&gt;data[''customer_text''] = $this-&gt;language-&gt;get(''text_approval''); // Backwards compatible with pre OC_ver 1.5.3\r\n        } else {\r\n           	$template-&gt;data[''customer_text''] = $this-&gt;language-&gt;get(''text_login'');\r\n        } ]]&gt;&lt;/add&gt;\r\n	&lt;/operation&gt;\r\n	&lt;operation&gt;\r\n		&lt;search position=&quot;replace&quot; index=&quot;1&quot;&gt;&lt;![CDATA[\r\n            $mail-&gt;send();]]&gt;&lt;/search&gt;\r\n		&lt;add&gt;&lt;![CDATA[        $template-&gt;load(''customer.register'');\r\n\r\n		$mail = $template-&gt;hook($mail);\r\n\r\n		$mail-&gt;send();\r\n\r\n		$template-&gt;sent(); ]]&gt;&lt;/add&gt;\r\n	&lt;/operation&gt;\r\n	&lt;operation&gt;\r\n		&lt;search position=&quot;before&quot;&gt;&lt;![CDATA[\r\n            public function editNewsletter($newsletter)]]&gt;&lt;/search&gt;\r\n	  	&lt;ignoreif&gt;&lt;![CDATA[ \r\n            public function editNewsletterUnsubscribe( ]]&gt;&lt;/ignoreif&gt;\r\n		&lt;add&gt;&lt;![CDATA[\r\n            public function editNewsletterUnsubscribe($email){\r\n            	$query = $this-&gt;db-&gt;query(&quot;SELECT * FROM &quot;.DB_PREFIX.&quot;customer WHERE MD5(email) = ''&quot; . $this-&gt;db-&gt;escape($email) . &quot;''&quot;);\r\n\r\n				if ($query-&gt;num_rows) {\r\n					$this-&gt;db-&gt;query(&quot;UPDATE &quot;.DB_PREFIX.&quot;customer SET newsletter = ''0'' WHERE customer_id = &quot; . (int)$query-&gt;row[''customer_id''] . &quot;&quot;);\r\n\r\n					return $query-&gt;row;\r\n				} else {\r\n					return false;\r\n				}\r\n            }\r\n		]]&gt;&lt;/add&gt;\r\n	&lt;/operation&gt;\r\n&lt;/file&gt;' 
 WHERE `emailtemplate_default` = 1 AND `emailtemplate_key` = 'customer.register';
 
UPDATE `{$p}emailtemplate`  
   SET `emailtemplate_vqmod` = '&lt;file name=&quot;catalog/model/account/customer.php&quot;&gt;\r\n	&lt;operation&gt;\r\n		&lt;search position=&quot;after&quot;&gt;&lt;![CDATA[\r\n            if ($this-&gt;config-&gt;get(''config_account_mail'')) {]]&gt;&lt;/search&gt;\r\n		&lt;add&gt;&lt;![CDATA[			if((isset($customer_group_info[''approval'']) &amp;&amp; $customer_group_info[''approval'']) || $this-&gt;config-&gt;get(''config_customer_approval'')){\r\n	            $template-&gt;data[''text_approve''] = $this-&gt;language-&gt;get(''text_approve'');\r\n	            $template-&gt;data[''account_approve''] = (defined(''HTTP_ADMIN'') ? HTTP_ADMIN : HTTP_SERVER.''admin/'') . ''index.php?route=sale/customer&amp;filter_approved=0'';\r\n            } ]]&gt;&lt;/add&gt;\r\n	&lt;/operation&gt;\r\n	&lt;operation&gt;\r\n		&lt;search position=&quot;replace&quot; index=&quot;2&quot;&gt;&lt;![CDATA[\r\n            $mail-&gt;send();]]&gt;&lt;/search&gt;\r\n		&lt;add&gt;&lt;![CDATA[			$template-&gt;load(''customer.register_admin'');\r\n			$template-&gt;build();\r\n\r\n			$template-&gt;fetch();\r\n\r\n			$mail = $template-&gt;hook($mail);\r\n \r\n			$mail-&gt;send();\r\n\r\n			$template-&gt;sent(); ]]&gt;&lt;/add&gt;\r\n	&lt;/operation&gt;	\r\n&lt;/file&gt;' 
 WHERE `emailtemplate_default` = 1 AND `emailtemplate_key` = 'customer.register_admin';
 
UPDATE `{$p}emailtemplate`  
   SET `emailtemplate_vqmod` = '&lt;file name=&quot;catalog/controller/account/forgotten.php&quot;&gt;\r\n	&lt;operation&gt;\r\n		&lt;search position=&quot;before&quot;&gt;&lt;![CDATA[\r\n           $mail = new Mail();]]&gt;&lt;/search&gt;\r\n		&lt;add&gt;&lt;![CDATA[\r\n			$template = new EmailTemplate($this-&gt;request, $this-&gt;registry);\r\n					\r\n			$template-&gt;addData($this-&gt;request-&gt;post);\r\n\r\n			$template-&gt;data[''password''] = $password;\r\n			$template-&gt;data[''account_login''] = $this-&gt;url-&gt;link(''account/login'', '''', ''SSL'');\r\n			$template-&gt;data[''account_login_tracking''] = $template-&gt;getTracking($template-&gt;data[''account_login'']); ]]&gt;&lt;/add&gt;\r\n	&lt;/operation&gt;\r\n	&lt;operation&gt;\r\n		&lt;search position=&quot;after&quot; index=&quot;1&quot;&gt;&lt;![CDATA[\r\n				$mail-&gt;setText(]]&gt;&lt;/search&gt;\r\n		&lt;add&gt;&lt;![CDATA[			$template-&gt;load(''customer.forgotten'');\r\n			$mail = $template-&gt;hook($mail); ]]&gt;&lt;/add&gt;\r\n	&lt;/operation&gt;\r\n	&lt;operation&gt;\r\n		&lt;search position=&quot;after&quot; index=&quot;1&quot;&gt;&lt;![CDATA[\r\n				$mail-&gt;send(); ]]&gt;&lt;/search&gt;\r\n		&lt;add&gt;&lt;![CDATA[			$template-&gt;sent(); ]]&gt;&lt;/add&gt;\r\n	&lt;/operation&gt;\r\n&lt;/file&gt;' 
 WHERE `emailtemplate_default` = 1 AND `emailtemplate_key` = 'customer.forgotten';
 
UPDATE `{$p}emailtemplate`  
   SET `emailtemplate_vqmod` = '&lt;file name=&quot;catalog/model/checkout/order.php&quot;&gt;\r\n	&lt;operation&gt;\r\n		&lt;search position=&quot;after&quot;&gt;&lt;![CDATA[ \r\n			''customer_id''             =&gt; $order_query-&gt;row[''customer_id''], ]]&gt;&lt;/search&gt;\r\n		&lt;ignoreif&gt;&lt;![CDATA[ \r\n			''customer_group_id'' =&gt; ]]&gt;&lt;/ignoreif&gt;\r\n		&lt;add&gt;&lt;![CDATA[				''customer_group_id'' =&gt; (isset($order_query-&gt;row[''customer_group_id''])) ? $order_query-&gt;row[''customer_group_id''] : '''',\r\n				''affiliate_id'' =&gt; (isset($order_query-&gt;row[''affiliate_id''])) ? $order_query-&gt;row[''affiliate_id''] : '''',]]&gt;&lt;/add&gt;\r\n	&lt;/operation&gt;\r\n	&lt;operation&gt;\r\n		&lt;search position=&quot;after&quot;&gt;&lt;![CDATA[\r\n			$order_product_query = $this-&gt;db-&gt;query(&quot;SELECT * FROM &quot; . DB_PREFIX . &quot;order_product WHERE order_id = ''&quot; . (int)$order_id . &quot;''&quot;);]]&gt;&lt;/search&gt;\r\n		&lt;add&gt;&lt;![CDATA[\r\n            $this-&gt;load-&gt;model(''tool/image'');\r\n			$this-&gt;load-&gt;model(''catalog/product'');\r\n\r\n            // Load Customer Group - check file exists for old versions of opencart\r\n            if(isset($order_info[''customer_group_id'']) &amp;&amp; $order_info[''customer_group_id''] &amp;&amp; file_exists(DIR_APPLICATION . ''model/account/customer_group.php'')){\r\n            	$this-&gt;load-&gt;model(''account/customer_group'');\r\n				$customer_group_info = $this-&gt;model_account_customer_group-&gt;getCustomerGroup($order_info[''customer_group_id'']);\r\n            }\r\n\r\n            // Load affiliate data into email\r\n            if(isset($order_info[''affiliate_id'']) &amp;&amp; $order_info[''affiliate_id'']){\r\n            	$this-&gt;load-&gt;model(''affiliate/affiliate'');\r\n				$affiliate_info = $this-&gt;model_affiliate_affiliate-&gt;getAffiliate($order_info[''affiliate_id'']);\r\n            } ]]&gt;&lt;/add&gt;\r\n	&lt;/operation&gt;\r\n	&lt;operation&gt;\r\n		&lt;search position=&quot;replace&quot; index=&quot;1&quot;&gt;&lt;![CDATA[ $template = new Template(); ]]&gt;&lt;/search&gt;\r\n		&lt;add&gt;&lt;![CDATA[		\r\n 			$template = new EmailTemplate($this-&gt;request, $this-&gt;registry);\r\n\r\n			$template-&gt;addData($this-&gt;request-&gt;post, ''post_data'');\r\n\r\n			$template-&gt;addData($order_info);\r\n\r\n			$template-&gt;data[''affiliate''] = (isset($affiliate_info)) ? $affiliate_info : false;\r\n\r\n			$template-&gt;data[''customer_group''] = (isset($customer_group_info)) ? $customer_group_info : false;\r\n\r\n			$template-&gt;data[''order_status_id''] = $order_status_id;\r\n			$template-&gt;data[''new_order_status''] = $order_status; ]]&gt;&lt;/add&gt;\r\n	&lt;/operation&gt;\r\n	&lt;operation&gt;\r\n		&lt;search position=&quot;after&quot; index=&quot;1&quot;&gt;&lt;![CDATA[ $template-&gt;data[''link''] = ]]&gt;&lt;/search&gt;\r\n		&lt;add&gt;&lt;![CDATA[			$template-&gt;data[''link_tracking''] = $template-&gt;getTracking($template-&gt;data[''link'']); ]]&gt;&lt;/add&gt;\r\n	&lt;/operation&gt;\r\n	&lt;operation&gt;\r\n		&lt;search position=&quot;after&quot; index=&quot;1&quot;&gt;&lt;![CDATA[ $template-&gt;data[''download''] = ]]&gt;&lt;/search&gt;\r\n		&lt;add&gt;&lt;![CDATA[			$template-&gt;data[''download_tracking''] = $template-&gt;getTracking($template-&gt;data[''download'']); ]]&gt;&lt;/add&gt;\r\n	&lt;/operation&gt;\r\n	&lt;operation&gt;\r\n		&lt;search position=&quot;replace&quot; index=&quot;1&quot;&gt;&lt;![CDATA[\r\n			$template-&gt;data[''products''][] = array( ]]&gt;&lt;/search&gt;\r\n		&lt;add&gt;&lt;![CDATA[$product_data = $this-&gt;model_catalog_product-&gt;getProduct($product[''product_id'']);\r\n\r\n				if (isset($product_data[''image''])) {\r\n					$image = $this-&gt;model_tool_image-&gt;resize($product_data[''image''], 50, 50);\r\n				} else {\r\n					$image = '''';\r\n				}\r\n\r\n				$url = $this-&gt;url-&gt;link(''product/product'', ''product_id=''.$product_data[''product_id''], ''SSL'');\r\n\r\n				$manufacturer_name = '''';\r\n				if(isset($product_data[''manufacturer_id'']) &amp;&amp; $product_data[''manufacturer_id'']){\r\n					$this-&gt;load-&gt;model(''catalog/manufacturer'');\r\n					$manufacturer_info = $this-&gt;model_catalog_manufacturer-&gt;getManufacturer($product_data[''manufacturer_id'']);\r\n					if($manufacturer_info){\r\n						$manufacturer_name = $manufacturer_info[''name''];\r\n					}\r\n				} \r\n\r\n				$template-&gt;data[''products''][] = array(\r\n					''url''     		=&gt; $url,\r\n					''url_tracking'' 	=&gt; $template-&gt;getTracking($url),\r\n					''image''     	=&gt; $image,\r\n					''order_product_id'' =&gt; $product[''order_product_id''],\r\n					''weight''		=&gt; $product_data[''weight''],\r\n					''weight_fvalue''	=&gt; $this-&gt;weight-&gt;format($product_data[''weight''], $product_data[''weight_class_id'']),\r\n					''sku''			=&gt; $product_data[''sku''],\r\n					''manufacturer''  =&gt; $manufacturer_name,\r\n					''stock_quantity''=&gt; ($product_data[''stock_quantity''] - $product_data[''quantity'']),]]&gt;&lt;/add&gt;\r\n	&lt;/operation&gt;\r\n	&lt;operation error=&quot;skip&quot; info=&quot;Remove logo, this gets handled via email template&quot;&gt;\r\n		&lt;search position=&quot;replace&quot; index=&quot;1&quot;&gt;&lt;![CDATA[\r\n			$template-&gt;data[''logo''] = $this-&gt;config-&gt;get(''config_url'') . ''image/'' . $this-&gt;config-&gt;get(''config_logo'');]]&gt;&lt;/search&gt;\r\n		&lt;add/&gt;\r\n	&lt;/operation&gt;\r\n	&lt;operation error=&quot;skip&quot;&gt;\r\n		&lt;search position=&quot;replace&quot; index=&quot;1&quot;&gt;&lt;![CDATA[\r\n			$template-&gt;data[''logo''] = HTTP_IMAGE . $this-&gt;config-&gt;get(''config_logo'');]]&gt;&lt;/search&gt;\r\n		&lt;add/&gt;\r\n	&lt;/operation&gt;\r\n	&lt;operation error=&quot;skip&quot;&gt;\r\n		&lt;search position=&quot;replace&quot; index=&quot;1&quot;&gt;&lt;![CDATA[\r\n			$template-&gt;data[''logo''] = $this-&gt;model_tool_image-&gt;get($this-&gt;config-&gt;get(''config_logo''));]]&gt;&lt;/search&gt;\r\n		&lt;add/&gt;\r\n	&lt;/operation&gt;\r\n	&lt;operation error=&quot;skip&quot; info=&quot;1.5.1.3.1&quot;&gt;\r\n		&lt;search position=&quot;replace&quot; index=&quot;1&quot;&gt;&lt;![CDATA[\r\n			$template-&gt;data[''logo''] = ''cid:'' . md5(basename($this-&gt;config-&gt;get(''config_logo'')));]]&gt;&lt;/search&gt;\r\n		&lt;add/&gt;\r\n	&lt;/operation&gt;\r\n	&lt;operation error=&quot;skip&quot; info=&quot;remove attachedment&quot;&gt;\r\n		&lt;search position=&quot;replace&quot;&gt;&lt;![CDATA[\r\n			$mail-&gt;addAttachment(DIR_IMAGE . $this-&gt;config-&gt;get(''config_logo''), md5(basename($this-&gt;config-&gt;get(''config_logo''))));]]&gt;&lt;/search&gt;\r\n		&lt;add/&gt;\r\n	&lt;/operation&gt;\r\n	&lt;operation error=&quot;skip&quot;&gt;\r\n		&lt;search position=&quot;replace&quot; offset=&quot;4&quot; index=&quot;1&quot;&gt;&lt;![CDATA[\r\n			if ($comment &amp;&amp; $notify) {]]&gt;&lt;/search&gt;\r\n		&lt;add&gt;&lt;![CDATA[\r\n            if ($order_info[''comment'']) {\r\n            	$template-&gt;data[''comment''] = str_replace(array(&quot;\\r\\n&quot;, &quot;\\r&quot;, &quot;\\n&quot;), &quot;&lt;br /&gt;&quot;, $order_info[''comment'']);\r\n            } else {\r\n            	$template-&gt;data[''comment''] = '''';\r\n            }\r\n\r\n            if ($comment &amp;&amp; $notify &amp;&amp; $template-&gt;data[''comment''] != $comment) {\r\n				$template-&gt;data[''instruction''] = str_replace(array(&quot;\\r\\n&quot;, &quot;\\r&quot;, &quot;\\n&quot;), &quot;&lt;br /&gt;&quot;, $comment);\r\n			} else {\r\n				$template-&gt;data[''instruction''] = '''';\r\n			}]]&gt;&lt;/add&gt;\r\n	&lt;/operation&gt;\r\n	&lt;operation info=&quot;offset causing too many issue with linebreaks&quot;&gt;\r\n		&lt;search position=&quot;replace&quot; index=&quot;1&quot;&gt;&lt;![CDATA[\r\n            $html = $template-&gt;fetch($this-&gt;config-&gt;get(''config_template'') . ''/template/mail/order.tpl'');]]&gt;&lt;/search&gt;\r\n		&lt;add/&gt;\r\n	&lt;/operation&gt;\r\n	&lt;operation&gt;\r\n    	&lt;search position=&quot;replace&quot; index=&quot;1&quot;&gt;&lt;![CDATA[\r\n            $html = $template-&gt;fetch(''default/template/mail/order.tpl'');]]&gt;&lt;/search&gt;\r\n		&lt;add/&gt;\r\n	&lt;/operation&gt;\r\n	&lt;operation&gt;\r\n		&lt;search position=&quot;after&quot;&gt;&lt;![CDATA[\r\n            $template-&gt;data[''customer_id''] = $order_info[''customer_id'']; ]]&gt;&lt;/search&gt;\r\n		&lt;add&gt;&lt;![CDATA[\r\n            $template-&gt;data[''customer_name''] = $order_info[''firstname''] . '' '' . $order_info[''lastname''];\r\n            $template-&gt;data[''customer_firstname''] = $order_info[''firstname''];\r\n            $template-&gt;data[''customer_lastname''] = $order_info[''lastname''];]]&gt;&lt;/add&gt;\r\n	&lt;/operation&gt;\r\n	&lt;operation&gt;\r\n		&lt;search position=&quot;replace&quot; index=&quot;1&quot;&gt;&lt;![CDATA[\r\n			$mail-&gt;setHtml($html);]]&gt;&lt;/search&gt;\r\n		&lt;add&gt;&lt;![CDATA[			$template_data = array(\r\n				''key'' =&gt; ''order.customer'',\r\n				''order_status_id'' =&gt; $order_status_id\r\n			);\r\n\r\n   			$template-&gt;load($template_data);\r\n\r\n			$mail = $template-&gt;hook($mail); \r\n\r\n			if($template-&gt;data[''emailtemplate''][''attach_invoice''] &amp;&amp; ($this-&gt;config-&gt;get(''config_complete_status_id'') == $order_status_id) &amp;&amp; $order_info &amp;&amp; !$order_info[''invoice_no'']) {\r\n				$query = $this-&gt;db-&gt;query(&quot;SELECT MAX(invoice_no) AS invoice_no FROM `&quot; . DB_PREFIX . &quot;order` WHERE invoice_prefix = ''&quot; . $this-&gt;db-&gt;escape($order_info[''invoice_prefix'']) . &quot;''&quot;);\r\n			\r\n				if ($query-&gt;row[''invoice_no'']) {\r\n					$invoice_no = $query-&gt;row[''invoice_no''] + 1;\r\n				} else {\r\n					$invoice_no = 1;\r\n				}\r\n				\r\n				$this-&gt;db-&gt;query(&quot;UPDATE `&quot; . DB_PREFIX . &quot;order` SET invoice_no = ''&quot; . (int)$invoice_no . &quot;'', invoice_prefix = ''&quot; . $this-&gt;db-&gt;escape($order_info[''invoice_prefix'']) . &quot;'' WHERE order_id = ''&quot; . (int)$order_id . &quot;''&quot;);\r\n					\r\n				$order_info[''invoice_no''] = $invoice_no;\r\n 			}]]&gt;&lt;/add&gt;\r\n	&lt;/operation&gt;\r\n	&lt;operation&gt;\r\n        &lt;search position=&quot;after&quot; index=&quot;1&quot;&gt;&lt;![CDATA[\r\n            $mail-&gt;send(); ]]&gt;&lt;/search&gt;\r\n		&lt;add&gt;&lt;![CDATA[            $template-&gt;sent(); ]]&gt;&lt;/add&gt;\r\n	&lt;/operation&gt;\r\n	&lt;operation error=&quot;skip&quot; info=&quot;1.5.5.1&quot;&gt;\r\n        &lt;search position=&quot;replace&quot;&gt;&lt;![CDATA[\r\n            ''value'' =&gt; (strlen($value) &gt; 20 ? substr($value, 0, 20) . ''..'' : $value)]]&gt;&lt;/search&gt;\r\n		&lt;add trim=&quot;true&quot;&gt;&lt;![CDATA[\r\n            ''value'' =&gt; (strlen($value) &gt; 120 ? substr($value, 0, 120) . ''..'' : $value)]]&gt;&lt;/add&gt;\r\n	&lt;/operation&gt;\r\n	&lt;operation error=&quot;skip&quot;&gt;\r\n		&lt;search position=&quot;replace&quot;&gt;&lt;![CDATA[\r\n            ''value'' =&gt; (strlen($value) &gt; 20 ? substr($value, 0, 20) . ''..'' : $value)]]&gt;&lt;/search&gt;\r\n		&lt;add trim=&quot;true&quot;&gt;&lt;![CDATA[\r\n            ''value'' =&gt; (strlen($value) &gt; 120 ? substr($value, 0, 120) . ''..'' : $value)]]&gt;&lt;/add&gt;\r\n	&lt;/operation&gt;\r\n	&lt;operation error=&quot;skip&quot; info=&quot;1.5.1.3&quot;&gt;\r\n		&lt;search position=&quot;replace&quot;&gt;&lt;![CDATA[\r\n            ''value'' =&gt; (strlen($option[''value'']) &gt; 20 ? substr($option[''value''], 0, 20) . ''..'' : $option[''value''])]]&gt;&lt;/search&gt;\r\n		&lt;add trim=&quot;true&quot;&gt;&lt;![CDATA[\r\n            ''value'' =&gt; (strlen($option[''value'']) &gt; 120 ? substr($option[''value''], 0, 120) . ''..'' : $option[''value''])]]&gt;&lt;/add&gt;\r\n	&lt;/operation&gt;\r\n	&lt;operation info=&quot;Add product option price&quot;&gt;\r\n		&lt;search position=&quot;replace&quot; index=&quot;1&quot;&gt;&lt;![CDATA[\r\n            $order_option_query = $this-&gt;db-&gt;query(&quot;SELECT * FROM &quot; . DB_PREFIX . &quot;order_option WHERE order_id = ''&quot; . (int)$order_id . &quot;'' AND order_product_id = ''&quot; . (int)$product[''order_product_id''] . &quot;''&quot;);]]&gt;&lt;/search&gt;\r\n		&lt;add trim=&quot;true&quot;&gt;&lt;![CDATA[\r\n            $order_option_query = $this-&gt;db-&gt;query(&quot;SELECT oo.*, pov.* FROM &quot; . DB_PREFIX . &quot;order_option oo LEFT JOIN &quot; . DB_PREFIX . &quot;product_option_value pov ON (pov.product_option_value_id = oo.product_option_value_id) WHERE oo.order_id = ''&quot; . (int)$order_id . &quot;'' AND oo.order_product_id = ''&quot; . (int)$product[''order_product_id''] . &quot;''&quot;);]]&gt;&lt;/add&gt;\r\n	&lt;/operation&gt;\r\n	&lt;operation info=&quot;Add product option price&quot;&gt;\r\n		&lt;search position=&quot;before&quot; index=&quot;1&quot;&gt;&lt;![CDATA[\r\n            $option_data[] = array(]]&gt;&lt;/search&gt;\r\n		&lt;add&gt;&lt;![CDATA[					$price = false;\r\n					if ((float)$option[''price'']) {\r\n						$price = $this-&gt;currency-&gt;format($option[''price''], $this-&gt;config-&gt;get(''config_currency''));\r\n					}]]&gt;&lt;/add&gt;\r\n	&lt;/operation&gt;\r\n	&lt;operation info=&quot;Add product option price&quot;&gt;\r\n		&lt;search position=&quot;after&quot; index=&quot;1&quot;&gt;&lt;![CDATA[\r\n            ''name''  =&gt; $option[''name''],]]&gt;&lt;/search&gt;\r\n		&lt;add&gt;&lt;![CDATA[						''price''  =&gt; $price,\r\n						''price_prefix''  =&gt; $option[''price_prefix''],]]&gt;&lt;/add&gt;\r\n	&lt;/operation&gt;\r\n&lt;/file&gt;' 
 WHERE `emailtemplate_default` = 1 AND `emailtemplate_key` = 'order.customer';
 
UPDATE `{$p}emailtemplate`  
   SET `emailtemplate_vqmod` = '&lt;file name=&quot;catalog/model/checkout/order.php&quot;&gt;\r\n	&lt;operation&gt;\r\n		&lt;search position=&quot;replace&quot; index=&quot;1&quot;&gt;&lt;![CDATA[\r\n            $subject = sprintf($language-&gt;get(''text_new_subject''), html_entity_decode($this-&gt;config-&gt;get(''config_name''), ENT_QUOTES, ''UTF-8''), $order_id);]]&gt;&lt;/search&gt;\r\n		&lt;add&gt;&lt;![CDATA[$subject = sprintf($language-&gt;get(''text_new_subject_admin''), $order_id, $template-&gt;data[''customer_name''], html_entity_decode($this-&gt;config-&gt;get(''config_name''), ENT_QUOTES, ''UTF-8''));\r\n				\r\n				$template-&gt;data[''order_link''] = (defined(''HTTP_ADMIN'') ? HTTP_ADMIN : HTTP_SERVER.''admin/'') . ''index.php?route=sale/order/info&amp;order_id='' . $order_id;\r\n				$template-&gt;data[''order_weight''] = $order_info[''weight''];\r\n				$template-&gt;data[''order_weight_fvalue''] = $this-&gt;weight-&gt;format($order_info[''weight''], $this-&gt;config-&gt;get(''config_weight_class_id''), $this-&gt;language-&gt;get(''decimal_point''), $this-&gt;language-&gt;get(''thousand_point''));\r\n]]&gt;&lt;/add&gt;\r\n	&lt;/operation&gt;\r\n	&lt;operation info=&quot;Admin email&quot;&gt;\r\n		&lt;search position=&quot;after&quot; index=&quot;2&quot;&gt;&lt;![CDATA[\r\n            $mail-&gt;setText(]]&gt;&lt;/search&gt;\r\n		&lt;add&gt;&lt;![CDATA[            	$template-&gt;load(''order.admin'');\r\n				$template-&gt;build();\r\n				$mail = $template-&gt;hook($mail);]]&gt;&lt;/add&gt;\r\n	&lt;/operation&gt;\r\n	&lt;operation&gt;\r\n		&lt;search position=&quot;after&quot; index=&quot;2&quot;&gt;&lt;![CDATA[\r\n            $mail-&gt;send(); ]]&gt;&lt;/search&gt;\r\n		&lt;add&gt;&lt;![CDATA[            	$template-&gt;sent();]]&gt;&lt;/add&gt;\r\n	&lt;/operation&gt;\r\n&lt;/file&gt;' 
 WHERE `emailtemplate_default` = 1 AND `emailtemplate_key` = 'order.admin';
 
UPDATE `{$p}emailtemplate`  
   SET `emailtemplate_vqmod` = '&lt;file name=&quot;catalog/model/checkout/order.php&quot;&gt;\r\n	&lt;operation info=&quot;Method:update&quot;&gt;\r\n		&lt;search position=&quot;after&quot; index=&quot;1&quot;&gt;&lt;![CDATA[\r\n			$subject = sprintf($language-&gt;get(''text_update_subject'')]]&gt;&lt;/search&gt;\r\n		&lt;add&gt;&lt;![CDATA[\r\n            	$template = new EmailTemplate($this-&gt;request, $this-&gt;registry);\r\n            	\r\n				$template-&gt;addData($order_info);\r\n				$template-&gt;addData(''comment'', $comment);\r\n\r\n				$template-&gt;data[''order_url''] = ($order_info[''customer_id'']) ? ($order_info[''store_url''] . ''index.php?route=account/order/info&amp;order_id='' . $order_id) : '''';\r\n				$template-&gt;data[''order_url_tracking''] = $template-&gt;getTracking($template-&gt;data[''order_url'']);\r\n				$template-&gt;data[''date_added''] = date($language-&gt;get(''date_format_short''), strtotime($order_info[''date_added'']));]]&gt;&lt;/add&gt;\r\n	&lt;/operation&gt;\r\n	&lt;operation info=&quot;Method:update&quot;&gt;\r\n		&lt;search position=&quot;after&quot;&gt;&lt;![CDATA[\r\n            $message .= $order_status_query-&gt;row[''name'']]]&gt;&lt;/search&gt;\r\n		&lt;add&gt;&lt;![CDATA[					$template-&gt;data[''order_status''] = $order_status_query-&gt;row[''name''];]]&gt;&lt;/add&gt;\r\n	&lt;/operation&gt;\r\n	&lt;operation info=&quot;Method:update&quot;&gt;\r\n		&lt;search position=&quot;after&quot; index=&quot;3&quot;&gt;&lt;![CDATA[\r\n            $mail-&gt;setText(]]&gt;&lt;/search&gt;\r\n		&lt;add&gt;&lt;![CDATA[				$template_data = array(\r\n					''key'' =&gt; ''order.customer_update'',\r\n					''order_status_id'' =&gt; $order_status_id\r\n				);\r\n\r\n				$template-&gt;load($template_data);\r\n				$mail = $template-&gt;hook($mail);]]&gt;&lt;/add&gt;\r\n	&lt;/operation&gt;\r\n	&lt;operation info=&quot;Method:update&quot;&gt;\r\n		&lt;search position=&quot;after&quot; index=&quot;3&quot;&gt;&lt;![CDATA[\r\n            $mail-&gt;send(); ]]&gt;&lt;/search&gt;\r\n		&lt;add&gt;&lt;![CDATA[				$template-&gt;sent();]]&gt;&lt;/add&gt;\r\n	&lt;/operation&gt;\r\n&lt;/file&gt;' 
 WHERE `emailtemplate_default` = 1 AND `emailtemplate_key` = 'order.customer_update';
 
UPDATE `{$p}emailtemplate`  
   SET `emailtemplate_vqmod` = '&lt;file name=&quot;catalog/controller/information/contact.php&quot;&gt;\r\n	&lt;operation&gt;\r\n		&lt;search position=&quot;before&quot;&gt;&lt;![CDATA[\r\n            $mail = new Mail();]]&gt;&lt;/search&gt;\r\n		&lt;add&gt;&lt;![CDATA[\r\n			$template = new EmailTemplate($this-&gt;request, $this-&gt;registry);\r\n			\r\n			$tracking = array();\r\n			$tracking[''ip_address''] = $this-&gt;request-&gt;server[''REMOTE_ADDR''];\r\n			$tracking[''user_agent''] = (isset($this-&gt;request-&gt;server[''HTTP_USER_AGENT''])) ? $this-&gt;request-&gt;server[''HTTP_USER_AGENT''] : '''';\r\n			$tracking[''accept_language''] = (isset($this-&gt;request-&gt;server[''HTTP_ACCEPT_LANGUAGE''])) ? $this-&gt;request-&gt;server[''HTTP_ACCEPT_LANGUAGE''] : '''';\r\n			if (!empty($this-&gt;request-&gt;server[''HTTP_X_FORWARDED_FOR''])) {\r\n				$tracking[''remote_host''] = $this-&gt;request-&gt;server[''HTTP_X_FORWARDED_FOR''];\r\n			} elseif(!empty($this-&gt;request-&gt;server[''HTTP_CLIENT_IP''])) {\r\n				$tracking[''remote_host''] = $this-&gt;request-&gt;server[''HTTP_CLIENT_IP''];\r\n			} else {\r\n				$tracking[''remote_host''] = '''';\r\n			}\r\n\r\n			$template-&gt;addData($this-&gt;request-&gt;post);\r\n\r\n			$template-&gt;data[''enquiry''] = html_entity_decode(str_replace(&quot;\\n&quot;, &quot;&lt;br /&gt;&quot;, $this-&gt;request-&gt;post[''enquiry'']), ENT_QUOTES, ''UTF-8'');\r\n			$template-&gt;data[''user_tracking''] = $tracking;]]&gt;&lt;/add&gt;\r\n	&lt;/operation&gt;\r\n	&lt;operation&gt;\r\n		&lt;search position=&quot;after&quot; index=&quot;1&quot;&gt;&lt;![CDATA[\r\n            $mail-&gt;setText(]]&gt;&lt;/search&gt;\r\n		&lt;add&gt;&lt;![CDATA[			$template-&gt;load(''information.contact'');\r\n			$mail = $template-&gt;hook($mail);]]&gt;&lt;/add&gt;\r\n	&lt;/operation&gt;\r\n	&lt;operation&gt;\r\n		&lt;search position=&quot;after&quot; index=&quot;1&quot;&gt;&lt;![CDATA[\r\n            $mail-&gt;send(); ]]&gt;&lt;/search&gt;\r\n		&lt;add&gt;&lt;![CDATA[			$template-&gt;sent(); ]]&gt;&lt;/add&gt;\r\n	&lt;/operation&gt;\r\n&lt;/file&gt;' 
 WHERE `emailtemplate_default` = 1 AND `emailtemplate_key` = 'information.contact';
 
UPDATE `{$p}emailtemplate`  
   SET `emailtemplate_vqmod` = '&lt;file name=&quot;catalog/controller/information/contact.php&quot;&gt;\r\n	&lt;operation&gt;\r\n		&lt;search position=&quot;before&quot; index=&quot;1&quot;&gt;&lt;![CDATA[\r\n            $this-&gt;redirect($this-&gt;url-&gt;link(''information/contact/success''));]]&gt;&lt;/search&gt;\r\n		&lt;add&gt;&lt;![CDATA[\r\n			if($template-&gt;load(''information.contact_customer'')){\r\n				$template-&gt;build();\r\n				$mail = $template-&gt;hook($mail);\r\n				$mail-&gt;send();\r\n				$template-&gt;sent();\r\n			}]]&gt;&lt;/add&gt;\r\n	&lt;/operation&gt;\r\n&lt;/file&gt;' 
 WHERE `emailtemplate_default` = 1 AND `emailtemplate_key` = 'information.contact_customer';
 
UPDATE `{$p}emailtemplate`  
   SET `emailtemplate_vqmod` = '&lt;file name=&quot;catalog/model/affiliate/affiliate.php&quot;&gt;\r\n	&lt;operation&gt;\r\n		&lt;search position=&quot;before&quot; index=&quot;1&quot;&gt;&lt;![CDATA[\r\n            $mail = new Mail();]]&gt;&lt;/search&gt;\r\n		&lt;add&gt;&lt;![CDATA[		$template = new EmailTemplate($this-&gt;request, $this-&gt;registry);\r\n		$template-&gt;data[''url_affiliate_login''] = $this-&gt;url-&gt;link(''affiliate/login'', '''', ''SSL'');\r\n		$template-&gt;data[''url_affiliate_login_tracking''] = $template-&gt;getTracking($template-&gt;data[''url_affiliate_login'']);\r\n		]]&gt;&lt;/add&gt;\r\n	&lt;/operation&gt;\r\n	&lt;operation&gt;\r\n		&lt;search position=&quot;replace&quot; index=&quot;1&quot;&gt;&lt;![CDATA[\r\n            $mail-&gt;send();]]&gt;&lt;/search&gt;\r\n		&lt;add&gt;&lt;![CDATA[		$template-&gt;load(''affiliate.register'');\r\n\r\n		$mail = $template-&gt;hook($mail);\r\n\r\n		$mail-&gt;send();\r\n		\r\n		$template-&gt;sent(); ]]&gt;&lt;/add&gt;\r\n	&lt;/operation&gt;\r\n&lt;/file&gt;' 
 WHERE `emailtemplate_default` = 1 AND `emailtemplate_key` = 'affiliate.register';
 
UPDATE `{$p}emailtemplate`  
   SET `emailtemplate_vqmod` = '&lt;file name=&quot;catalog/model/affiliate/affiliate.php&quot;&gt;\r\n	&lt;operation&gt;\r\n		&lt;search position=&quot;after&quot; index=&quot;1&quot;&gt;&lt;![CDATA[\r\n            $mail-&gt;send();]]&gt;&lt;/search&gt;\r\n		&lt;add&gt;&lt;![CDATA[\r\n		$template-&gt;addData($data);\r\n\r\n		$template-&gt;load(''affiliate.register_admin'');			\r\n\r\n		$template-&gt;build();\r\n\r\n		$mail = $template-&gt;hook($mail);\r\n\r\n		$mail-&gt;send();\r\n\r\n		$template-&gt;sent(); ]]&gt;&lt;/add&gt;\r\n	&lt;/operation&gt;\r\n&lt;/file&gt;' 
 WHERE `emailtemplate_default` = 1 AND `emailtemplate_key` = 'affiliate.register_admin';
 
UPDATE `{$p}emailtemplate`  
   SET `emailtemplate_vqmod` = '&lt;file name=&quot;catalog/controller/affiliate/forgotten.php&quot;&gt;\r\n	&lt;operation&gt;\r\n		&lt;search position=&quot;before&quot; index=&quot;1&quot;&gt;&lt;![CDATA[\r\n            $mail = new Mail();]]&gt;&lt;/search&gt;\r\n		&lt;add&gt;&lt;![CDATA[            $template = new EmailTemplate($this-&gt;request, $this-&gt;registry);\r\n			$template-&gt;data[''password''] = $password;\r\n			$template-&gt;data[''account_login''] = $this-&gt;url-&gt;link(''affiliate/login'', '''', ''SSL'');\r\n 			$template-&gt;data[''account_login_tracking''] = $template-&gt;getTracking($template-&gt;data[''account_login'']); ]]&gt;&lt;/add&gt;\r\n	&lt;/operation&gt;\r\n	&lt;operation&gt;\r\n		&lt;search position=&quot;replace&quot; index=&quot;1&quot;&gt;&lt;![CDATA[\r\n            $mail-&gt;send();]]&gt;&lt;/search&gt;\r\n		&lt;add&gt;&lt;![CDATA[			$template-&gt;load(''affiliate.forgotten'');			\r\n			$mail = $template-&gt;hook($mail);\r\n\r\n			$mail-&gt;send();\r\n\r\n			$template-&gt;sent(); ]]&gt;&lt;/add&gt;\r\n	&lt;/operation&gt;\r\n&lt;/file&gt;' 
 WHERE `emailtemplate_default` = 1 AND `emailtemplate_key` = 'affiliate.forgotten';
 
UPDATE `{$p}emailtemplate`  
   SET `emailtemplate_vqmod` = '&lt;file name=&quot;catalog/model/checkout/voucher.php&quot;&gt;\r\n	&lt;operation&gt;\r\n		&lt;search position=&quot;replace&quot; index=&quot;1&quot;&gt;&lt;![CDATA[\r\n            $template = new Template();]]&gt;&lt;/search&gt;\r\n		&lt;add&gt;&lt;![CDATA[$this-&gt;load-&gt;model(''tool/image'');\r\n            	$template = new EmailTemplate($this-&gt;request, $this-&gt;registry); ]]&gt;&lt;/add&gt;\r\n	&lt;/operation&gt;\r\n	&lt;operation error=&quot;skip&quot; info=&quot;1.5.0.5&quot;&gt;\r\n		&lt;search position=&quot;replace&quot;&gt;&lt;![CDATA[\r\n            $template-&gt;data[''image''] = ''cid:'' . basename($voucher[''image'']);]]&gt;&lt;/search&gt;\r\n		&lt;add trim=&quot;true&quot;&gt;&lt;![CDATA[\r\n            	$template-&gt;data[''image''] = $this-&gt;model_tool_image-&gt;get($voucher[''image'']);]]&gt;&lt;/add&gt;\r\n	&lt;/operation&gt;\r\n	&lt;operation error=&quot;skip&quot; info=&quot;1.5.1/1.5.1.3&quot;&gt;\r\n		&lt;search position=&quot;replace&quot;&gt;&lt;![CDATA[\r\n            $template-&gt;data[''image''] = ''cid:'' . md5(basename($voucher[''image'']));]]&gt;&lt;/search&gt;\r\n		&lt;add trim=&quot;true&quot;&gt;&lt;![CDATA[\r\n            	$template-&gt;data[''image''] = $this-&gt;model_tool_image-&gt;get($voucher[''image'']);]]&gt;&lt;/add&gt;\r\n	&lt;/operation&gt;\r\n	&lt;operation error=&quot;skip&quot; info=&quot;Remove attachment&quot;&gt;\r\n		&lt;search position=&quot;replace&quot;&gt;&lt;![CDATA[\r\n            $mail-&gt;addAttachment(DIR_IMAGE . $voucher[''image''], md5(basename($voucher[''image''])));]]&gt;&lt;/search&gt;\r\n		&lt;add&gt;&lt;/add&gt;\r\n	&lt;/operation&gt;\r\n	&lt;operation info=&quot;Less error prone to replace each line instead of using offset&quot;&gt;\r\n		&lt;search position=&quot;replace&quot;&gt;&lt;![CDATA[\r\n            $html = $template-&gt;fetch($this-&gt;config-&gt;get(''config_template'') . ''/template/mail/voucher.tpl'');]]&gt;&lt;/search&gt;\r\n		&lt;add&gt;&lt;/add&gt;\r\n	&lt;/operation&gt;\r\n    &lt;operation&gt;\r\n		&lt;search position=&quot;replace&quot;&gt;&lt;![CDATA[\r\n            $html = $template-&gt;fetch(''default/template/mail/voucher.tpl'');]]&gt;&lt;/search&gt;\r\n		&lt;add&gt;&lt;/add&gt;\r\n	&lt;/operation&gt;\r\n	&lt;operation&gt;\r\n		&lt;search position=&quot;replace&quot; index=&quot;1&quot;&gt;&lt;![CDATA[\r\n            $mail-&gt;setHtml($html);]]&gt;&lt;/search&gt;\r\n		&lt;add&gt;&lt;![CDATA[$template-&gt;load(''order.voucher'');\r\n			$mail = $template-&gt;hook($mail);]]&gt;&lt;/add&gt;\r\n	&lt;/operation&gt;\r\n	&lt;operation&gt;\r\n		&lt;search position=&quot;after&quot; index=&quot;1&quot;&gt;&lt;![CDATA[\r\n            $mail-&gt;send(); ]]&gt;&lt;/search&gt;\r\n		&lt;add&gt;&lt;![CDATA[			$template-&gt;sent(); ]]&gt;&lt;/add&gt;\r\n	&lt;/operation&gt;\r\n&lt;/file&gt;' 
 WHERE `emailtemplate_default` = 1 AND `emailtemplate_key` = 'order.voucher';
 
UPDATE `{$p}emailtemplate`  
   SET `emailtemplate_vqmod` = '&lt;file name=&quot;catalog/model/catalog/review.php&quot;&gt;\r\n	&lt;operation&gt;\r\n		&lt;search position=&quot;after&quot; offset=&quot;1&quot; info=&quot;Insert below query&quot;&gt;&lt;![CDATA[\r\n			public function addReview($product_id, $data) { ]]&gt;&lt;/search&gt;\r\n		&lt;add&gt;&lt;![CDATA[\r\n			$review_id = $this-&gt;db-&gt;getLastId();\r\n\r\n			$this-&gt;load-&gt;model(''catalog/product'');\r\n\r\n   			$product_info = $this-&gt;model_catalog_product-&gt;getProduct($product_id);\r\n			if(empty($product_info)) return false;\r\n\r\n			$template = new EmailTemplate($this-&gt;request, $this-&gt;registry);\r\n            \r\n			$template-&gt;addData($data, ''review'');\r\n			$template-&gt;addData($product_info, ''product'');\r\n\r\n			$template-&gt;data[''product_link''] = $this-&gt;url-&gt;link(''product/product'', ''product_id='' . $product_id);\r\n			$template-&gt;data[''product_link_tracking''] = $template-&gt;getTracking($template-&gt;data[''product_link'']);\r\n			$template-&gt;data[''review_approve''] = (defined(''HTTP_ADMIN'') ? HTTP_ADMIN : HTTP_SERVER.''admin/'') . ''index.php?route=catalog/review/update&amp;review_id='' . $review_id;\r\n\r\n			$template-&gt;load(''product.review'');\r\n\r\n			$template-&gt;send(); ]]&gt;&lt;/add&gt;\r\n	&lt;/operation&gt;\r\n&lt;/file&gt;' 
 WHERE `emailtemplate_default` = 1 AND `emailtemplate_key` = 'product.review';
 
UPDATE `{$p}emailtemplate`  
   SET `emailtemplate_vqmod` = '&lt;file name=&quot;catalog/model/account/return.php&quot;&gt;\r\n	&lt;operation&gt;\r\n		&lt;search position=&quot;after&quot; offset=&quot;1&quot; info=&quot;insert after query&quot;&gt;&lt;![CDATA[\r\n			public function addReturn($data) {]]&gt;&lt;/search&gt;\r\n		&lt;add&gt;&lt;![CDATA[\r\n			$return_id = $this-&gt;db-&gt;getLastId();\r\n			\r\n   			$this-&gt;language-&gt;load(''mail/return'');\r\n\r\n			$template = new EmailTemplate($this-&gt;request, $this-&gt;registry);\r\n            \r\n			$this-&gt;load-&gt;model(''localisation/return_reason'');\r\n\r\n			// Backwards compatabile with 1.5.1.3\r\n			if(isset($this-&gt;request-&gt;post[''return_product''])){\r\n\r\n				foreach ($this-&gt;request-&gt;post[''return_product''] as $return_product) {\r\n					$return_reason_info = $this-&gt;model_localisation_return_reason-&gt;getReturnReason($return_product[''return_reason_id'']);\r\n\r\n					if(isset($return_product[''product''])){\r\n						$name = $return_product[''product''];\r\n					} elseif(isset($return_product[''name''])){\r\n						$name = $return_product[''name''];\r\n					} else {\r\n						$name = '''';\r\n					}\r\n\r\n					$return_product = array(\r\n						''name'' =&gt; $name,\r\n						''model'' =&gt; $return_product[''model''],\r\n						''quantity'' =&gt; $return_product[''quantity''],\r\n						''reason'' =&gt; ($return_reason_info) ? $return_reason_info[''name''] : '''',\r\n						''opened'' =&gt; $return_product[''opened''] ? $this-&gt;language-&gt;get(''text_yes'') : $this-&gt;language-&gt;get(''text_no''),\r\n						''comment'' =&gt; (isset($return_product[''comment''])) ? nl2br($return_product[''comment'']) : ''''\r\n					);\r\n				}\r\n\r\n			} else {\r\n				$return_reason_info = $this-&gt;model_localisation_return_reason-&gt;getReturnReason($data[''return_reason_id'']);\r\n				$return_product = array(\r\n					''name'' =&gt; $data[''product''],\r\n					''model'' =&gt; $data[''model''],\r\n					''quantity'' =&gt; $data[''quantity''],\r\n					''reason'' =&gt; ($return_reason_info) ? $return_reason_info[''name''] : '''',\r\n					''opened'' =&gt; $data[''opened''] ? $this-&gt;language-&gt;get(''text_yes'') : $this-&gt;language-&gt;get(''text_no''),\r\n					''comment'' =&gt; (isset($data[''comment''])) ? nl2br($data[''comment'']) : ''''\r\n				);\r\n\r\n			}\r\n			\r\n			$template-&gt;addData($data);\r\n\r\n			$template-&gt;data[''text_greeting''] = sprintf($this-&gt;language-&gt;get(''text_greeting''), $this-&gt;config-&gt;get(''config_name''));\r\n			$template-&gt;data[''order_date''] = date($this-&gt;language-&gt;get(''date_format_short''), strtotime($data[''date_ordered'']));\r\n			$template-&gt;data[''comment''] = (isset($data[''comment''])) ? nl2br($data[''comment'']) : '''';\r\n			$template-&gt;data[''return_product''] = $return_product;\r\n			$template-&gt;data[''return_link''] = (defined(''HTTP_ADMIN'') ? HTTP_ADMIN : HTTP_SERVER.''admin/'') . ''index.php?route=sale/return/info&amp;return_id='' . $return_id;\r\n\r\n			$template-&gt;load(''account.return'');\r\n\r\n			$template-&gt;send(); ]]&gt;&lt;/add&gt;\r\n	&lt;/operation&gt;\r\n&lt;/file&gt;' 
 WHERE `emailtemplate_default` = 1 AND `emailtemplate_key` = 'account.return';
 
UPDATE `{$p}emailtemplate`  
   SET `emailtemplate_vqmod` = '&lt;file name=&quot;system/library/ebay.php&quot; error=&quot;skip&quot;&gt;\r\n	&lt;operation info=&quot;method::notifyAdmin&quot;&gt;\r\n		&lt;search position=&quot;before&quot; index=&quot;1&quot;&gt;&lt;![CDATA[\r\n			$mail-&gt;setText($message);]]&gt;&lt;/search&gt;\r\n		&lt;add&gt;&lt;![CDATA[		$template = new EmailTemplate($this-&gt;request, $this-&gt;registry);\r\n		$template-&gt;load(''ebay.admin'');\r\n		$template-&gt;build();\r\n		$template-&gt;fetch(null, $message);\r\n		$mail = $template-&gt;hook($mail);]]&gt;&lt;/add&gt;\r\n	&lt;/operation&gt;\r\n	&lt;operation info=&quot;method::notifyAdmin&quot;&gt;\r\n		&lt;search position=&quot;after&quot; index=&quot;1&quot;&gt;&lt;![CDATA[\r\n			$mail-&gt;send();]]&gt;&lt;/search&gt;\r\n		&lt;add&gt;&lt;![CDATA[		$template-&gt;sent();]]&gt;&lt;/add&gt;\r\n	&lt;/operation&gt;\r\n&lt;/file&gt;' 
 WHERE `emailtemplate_default` = 1 AND `emailtemplate_key` = 'ebay.admin';
 
UPDATE `{$p}emailtemplate`  
   SET `emailtemplate_vqmod` = '&lt;file name=&quot;system/library/openbay.php&quot; error=&quot;skip&quot;&gt;\r\n	&lt;operation info=&quot;method::newOrderAdminNotify&quot;&gt;\r\n		&lt;search position=&quot;after&quot;&gt;&lt;![CDATA[\r\n			$subject = sprintf($language-&gt;get(''text_new_subject'')]]&gt;&lt;/search&gt;\r\n		&lt;add&gt;&lt;![CDATA[\r\n		$template = new EmailTemplate($this-&gt;request, $this-&gt;registry, $order_info[''language_id'']);\r\n			\r\n		$template-&gt;addData($order_info);\r\n		$template-&gt;data[''order_status_id''] = $order_status_id;\r\n		$template-&gt;data[''new_order_status''] = $order_status;\r\n		$template-&gt;data[''comment''] = str_replace(array(&quot;\\r\\n&quot;, &quot;\\r&quot;, &quot;\\n&quot;), &quot;&lt;br /&gt;&quot;, $order_info[''comment'']);\r\n		$template-&gt;data[''date_added''] = date($language-&gt;get(''date_format_short''), strtotime($order_info[''date_added''])); ]]&gt;&lt;/add&gt;\r\n	&lt;/operation&gt;\r\n	&lt;operation&gt;\r\n		&lt;search position=&quot;replace&quot;&gt;&lt;![CDATA[\r\n			foreach ($order_product_query-&gt;rows as $product) {]]&gt;&lt;/search&gt;\r\n		&lt;add&gt;&lt;![CDATA[$template-&gt;data[''products''] = array();\r\n\r\n		foreach ($order_product_query-&gt;rows as $product) {\r\n			$product[''price''] = $this-&gt;currency-&gt;format($product[''price''] + ($this-&gt;config-&gt;get(''config_tax'') ? $product[''tax''] : 0), $order_info[''currency_code''], $order_info[''currency_value'']);\r\n			$product[''total''] = $this-&gt;currency-&gt;format($product[''total''] + ($this-&gt;config-&gt;get(''config_tax'') ? ($product[''tax''] * $product[''quantity'']) : 0), $order_info[''currency_code''], $order_info[''currency_value'']);\r\n			$product[''option''] = array();\r\n		]]&gt;&lt;/add&gt;\r\n	&lt;/operation&gt;\r\n	&lt;operation&gt;\r\n		&lt;search position=&quot;before&quot;&gt;&lt;![CDATA[\r\n			$text .= chr(9) . ''-'' . $option[''name''] ]]&gt;&lt;/search&gt;\r\n		&lt;add&gt;&lt;![CDATA[				$product[''option''][] = array(\r\n					''name''  =&gt; $option[''name''],			\r\n       				''value'' =&gt; (strlen($value) &gt; 120 ? substr($value, 0, 120) . ''..'' : $value)\r\n				);]]&gt;&lt;/add&gt;\r\n	&lt;/operation&gt;\r\n	&lt;operation info=&quot;Add to bottom of prducts loop&quot;&gt;\r\n		&lt;search position=&quot;after&quot; offset=&quot;1&quot;&gt;&lt;![CDATA[\r\n			$text .= chr(9) . ''-'' . $option[''name''] ]]&gt;&lt;/search&gt;\r\n		&lt;add&gt;&lt;![CDATA[			$product[''url''] = $template-&gt;data[''store_url''] . ''?route=product/product&amp;product_id=''.$product[''product_id''];\r\n			$product[''url_tracking''] = $template-&gt;getTracking($product[''url'']);\r\n\r\n			$template-&gt;data[''products''][] = $product;]]&gt;&lt;/add&gt;\r\n	&lt;/operation&gt;\r\n	&lt;operation&gt;\r\n		&lt;search position=&quot;replace&quot;&gt;&lt;![CDATA[\r\n			foreach ($order_voucher_query-&gt;rows as $voucher) {]]&gt;&lt;/search&gt;\r\n		&lt;add&gt;&lt;![CDATA[$template-&gt;data[''vouchers''] = array();\r\n		foreach ($order_voucher_query-&gt;rows as $voucher) {\r\n				$voucher[''price''] = $this-&gt;currency-&gt;format($voucher[''amount''], $order_info[''currency_code''], $order_info[''currency_value'']);\r\n				$template-&gt;data[''vouchers''][] = $voucher; ]]&gt;&lt;/add&gt;\r\n	&lt;/operation&gt;\r\n	&lt;operation&gt;\r\n		&lt;search position=&quot;replace&quot;&gt;&lt;![CDATA[\r\n			foreach ($order_total_query-&gt;rows as $total) {]]&gt;&lt;/search&gt;\r\n		&lt;add&gt;&lt;![CDATA[$template-&gt;data[''totals''] = array();\r\n		foreach ($order_total_query-&gt;rows as $total) {\r\n				$template-&gt;data[''totals''][] = $total; ]]&gt;&lt;/add&gt;\r\n	&lt;/operation&gt;\r\n	&lt;operation&gt;\r\n		&lt;search position=&quot;after&quot;&gt;&lt;![CDATA[\r\n			$mail-&gt;setText( ]]&gt;&lt;/search&gt;\r\n		&lt;add&gt;&lt;![CDATA[			$template-&gt;load(''openbay.admin'');\r\n			$mail = $template-&gt;hook($mail); ]]&gt;&lt;/add&gt;\r\n	&lt;/operation&gt;\r\n	&lt;operation&gt;\r\n		&lt;search position=&quot;after&quot; index=&quot;1&quot;&gt;&lt;![CDATA[\r\n			$mail-&gt;send(); ]]&gt;&lt;/search&gt;\r\n		&lt;add&gt;&lt;![CDATA[			$template-&gt;sent(); ]]&gt;&lt;/add&gt;\r\n	&lt;/operation&gt;\r\n&lt;/file&gt;' 
 WHERE `emailtemplate_default` = 1 AND `emailtemplate_key` = 'openbay.admin';
 
UPDATE `{$p}emailtemplate`  
   SET `emailtemplate_vqmod` = '&lt;file name=&quot;catalog/model/ebay/order.php&quot; error=&quot;skip&quot;&gt;\r\n	&lt;operation info=&quot;method:update&quot;&gt;\r\n		&lt;search position=&quot;after&quot;&gt;&lt;![CDATA[\r\n			$subject = sprintf($language-&gt;get(''text_update_subject'')]]&gt;&lt;/search&gt;\r\n		&lt;add&gt;&lt;![CDATA[				$template = new EmailTemplate($this-&gt;request, $this-&gt;registry);		\r\n				$template-&gt;addData($order_info);]]&gt;&lt;/add&gt;\r\n	&lt;/operation&gt;\r\n	&lt;operation info=&quot;method:update&quot;&gt;\r\n		&lt;search position=&quot;after&quot;&gt;&lt;![CDATA[\r\n			$message .= $language-&gt;get(''text_update_footer'');]]&gt;&lt;/search&gt;\r\n		&lt;add&gt;&lt;![CDATA[				$template-&gt;data[''comment''] = str_replace(array(&quot;\\r\\n&quot;, &quot;\\r&quot;, &quot;\\n&quot;), &quot;&lt;br /&gt;&quot;, $comment);\r\n				$template-&gt;data[''order_status_id''] = $order_status_id;\r\n				$template-&gt;data[''new_order_status''] = ($order_status_query-&gt;num_rows) ? $order_status_query-&gt;row[''name''] : '''';\r\n				$template-&gt;data[''order_url''] = $order_info[''store_url''] . ''index.php?route=account/order/info&amp;order_id='' . $order_id;\r\n				$template-&gt;data[''order_url_tracking''] = $template-&gt;getTracking($template-&gt;data[''order_url'']);\r\n				$template-&gt;data[''date_added''] = date($language-&gt;get(''date_format_short''), strtotime($order_info[''date_added''])); ]]&gt;&lt;/add&gt;\r\n	&lt;/operation&gt;\r\n	&lt;operation info=&quot;method:update&quot;&gt;\r\n		&lt;search position=&quot;after&quot; index=&quot;1&quot;&gt;&lt;![CDATA[\r\n			$mail-&gt;setText(]]&gt;&lt;/search&gt;\r\n		&lt;add&gt;&lt;![CDATA[			$template-&gt;load(array(\r\n				''key'' =&gt; ''ebay.update'',\r\n				''language_id'' =&gt; $order_info[''language_id'']\r\n			));	\r\n			$mail = $template-&gt;hook($mail);]]&gt;&lt;/add&gt;\r\n	&lt;/operation&gt;\r\n	&lt;operation info=&quot;method:update&quot;&gt;\r\n		&lt;search position=&quot;after&quot; index=&quot;1&quot;&gt;&lt;![CDATA[\r\n			$mail-&gt;send(); ]]&gt;&lt;/search&gt;\r\n		&lt;add&gt;&lt;![CDATA[   				$template-&gt;sent(); ]]&gt;&lt;/add&gt;\r\n	&lt;/operation&gt;\r\n&lt;/file&gt;' 
 WHERE `emailtemplate_default` = 1 AND `emailtemplate_key` = 'ebay.update';
 
UPDATE `{$p}emailtemplate`  
   SET `emailtemplate_vqmod` = '&lt;file name=&quot;catalog/model/ebay/order.php&quot; error=&quot;skip&quot;&gt;\r\n	&lt;operation info=&quot;method:confirm&quot;&gt;\r\n		&lt;search position=&quot;replace&quot;&gt;&lt;![CDATA[\r\n			$template = new Template();]]&gt;&lt;/search&gt;\r\n		&lt;add&gt;&lt;![CDATA[\r\n			$template = new EmailTemplate($this-&gt;request, $this-&gt;registry, $order_info[''language_id'']);\r\n			$template-&gt;data[''new_order_status''] = $order_status; ]]&gt;&lt;/add&gt;\r\n	&lt;/operation&gt;\r\n	&lt;operation&gt;\r\n		&lt;search position=&quot;replace&quot; index=&quot;1&quot;&gt;&lt;![CDATA[\r\n			$template-&gt;data[''products''][] = array( ]]&gt;&lt;/search&gt;\r\n		&lt;add&gt;&lt;![CDATA[if (isset($product[''image''])) {\r\n					$image = $this-&gt;model_tool_image-&gt;resize($product[''image''], 50, 50);\r\n				} else {\r\n					$image = '''';\r\n				}\r\n\r\n				$template-&gt;data[''products''][] = array(\r\n					''image''     	=&gt; $image,\r\n					''order_product_id''	=&gt; $product[''order_product_id''],]]&gt;&lt;/add&gt;\r\n	&lt;/operation&gt;\r\n	&lt;operation info=&quot;method:confirm&quot;&gt;\r\n		&lt;search position=&quot;replace&quot;&gt;&lt;![CDATA[\r\n			$html = $template-&gt;fetch($this-&gt;config-&gt;get(''config_template'') . ''/template/mail/order.tpl'');]]&gt;&lt;/search&gt;\r\n		&lt;add&gt;&lt;![CDATA[ $html = '''';]]&gt;&lt;/add&gt;\r\n	&lt;/operation&gt;\r\n	&lt;operation info=&quot;method:confirm&quot;&gt;\r\n		&lt;search position=&quot;replace&quot;&gt;&lt;![CDATA[\r\n			$html = $template-&gt;fetch(''default/template/mail/order.tpl'');]]&gt;&lt;/search&gt;\r\n		&lt;add&gt;&lt;![CDATA[ $html = '''';]]&gt;&lt;/add&gt;\r\n	&lt;/operation&gt;\r\n	&lt;operation info=&quot;method:confirm&quot;&gt;\r\n		&lt;search position=&quot;after&quot; index=&quot;2&quot;&gt;&lt;![CDATA[\r\n			$mail-&gt;setText(]]&gt;&lt;/search&gt;\r\n		&lt;add&gt;&lt;![CDATA[				$template-&gt;load(''ebay.order'');\r\n				$mail = $template-&gt;hook($mail);]]&gt;&lt;/add&gt;\r\n	&lt;/operation&gt;\r\n	&lt;operation info=&quot;method:confirm&quot;&gt;\r\n		&lt;search position=&quot;after&quot; index=&quot;2&quot;&gt;&lt;![CDATA[\r\n			$mail-&gt;send(); ]]&gt;&lt;/search&gt;\r\n		&lt;add&gt;&lt;![CDATA[   				$template-&gt;sent(); ]]&gt;&lt;/add&gt;\r\n	&lt;/operation&gt;\r\n&lt;/file&gt;' 
 WHERE `emailtemplate_default` = 1 AND `emailtemplate_key` = 'ebay.order';
 
UPDATE `{$p}emailtemplate`  
   SET `emailtemplate_vqmod` = '&lt;file name=&quot;catalog/model/play/order.php&quot; error=&quot;skip&quot;&gt;\r\n	&lt;operation info=&quot;method:update&quot;&gt;\r\n		&lt;search position=&quot;after&quot;&gt;&lt;![CDATA[\r\n			$subject = sprintf($language-&gt;get(''text_update_subject'')]]&gt;&lt;/search&gt;\r\n		&lt;add&gt;&lt;![CDATA[\r\n				$template = new EmailTemplate($this-&gt;request, $this-&gt;registry, $order_info[''language_id'']);\r\n				$template-&gt;addData($order_info);]]&gt;&lt;/add&gt;\r\n	&lt;/operation&gt;\r\n	&lt;operation info=&quot;method:update&quot;&gt;\r\n		&lt;search position=&quot;after&quot;&gt;&lt;![CDATA[\r\n			$message .= $language-&gt;get(''text_update_footer'');]]&gt;&lt;/search&gt;\r\n		&lt;add&gt;&lt;![CDATA[\r\n				$template-&gt;data[''order_id''] = $order_id;\r\n				$template-&gt;data[''order_status_id''] = $order_status_id;\r\n				$template-&gt;data[''comment''] = str_replace(array(&quot;\\r\\n&quot;, &quot;\\r&quot;, &quot;\\n&quot;), &quot;&lt;br /&gt;&quot;, $comment);\r\n				$template-&gt;data[''new_order_status''] = $order_id;\r\n				$template-&gt;data[''link''] = $order_info[''store_url''] . ''index.php?route=account/order/info&amp;order_id='' . $order_id;\r\n				$template-&gt;data[''link_tracking''] = $template-&gt;getTracking($template-&gt;data[''link'']);\r\n				$template-&gt;data[''date_added''] = date($language-&gt;get(''date_format_short''), strtotime($order_info[''date_added''])); ]]&gt;&lt;/add&gt;\r\n	&lt;/operation&gt;\r\n	&lt;operation info=&quot;method:update&quot;&gt;\r\n		&lt;search position=&quot;after&quot; index=&quot;1&quot;&gt;&lt;![CDATA[\r\n			$mail-&gt;setText(]]&gt;&lt;/search&gt;\r\n		&lt;add&gt;&lt;![CDATA[   				$template-&gt;load(''play.order'');\r\n						$mail = $template-&gt;hook($mail);]]&gt;&lt;/add&gt;\r\n	&lt;/operation&gt;\r\n	&lt;operation info=&quot;method:update&quot;&gt;\r\n		&lt;search position=&quot;after&quot; index=&quot;1&quot;&gt;&lt;![CDATA[\r\n			$mail-&gt;send(); ]]&gt;&lt;/search&gt;\r\n		&lt;add&gt;&lt;![CDATA[   				$template-&gt;sent(); ]]&gt;&lt;/add&gt;\r\n	&lt;/operation&gt;\r\n&lt;/file&gt;' 
 WHERE `emailtemplate_default` = 1 AND `emailtemplate_key` = 'play.order';
 
UPDATE `{$p}emailtemplate`  
   SET `emailtemplate_vqmod` = '&lt;file name=&quot;admin/controller/sale/order.php&quot;&gt;\r\n	&lt;operation&gt;\r\n		&lt;search position=&quot;after&quot;&gt;&lt;![CDATA[\r\n            $this-&gt;data[''entry_notify''] = $this-&gt;language-&gt;get(''entry_notify''); ]]&gt;&lt;/search&gt;\r\n		&lt;add&gt;&lt;![CDATA[\r\n            $this-&gt;data[''entry_summary''] = $this-&gt;language-&gt;get(''entry_summary'');\r\n            $this-&gt;data[''entry_show_products''] = $this-&gt;language-&gt;get(''entry_show_products'');\r\n            $this-&gt;data[''entry_show_totals''] = $this-&gt;language-&gt;get(''entry_show_totals'');\r\n            $this-&gt;data[''entry_show_downloads''] = $this-&gt;language-&gt;get(''entry_show_downloads'');\r\n            $this-&gt;data[''entry_show_vouchers''] = $this-&gt;language-&gt;get(''entry_show_vouchers'');\r\n            $this-&gt;data[''entry_template''] = $this-&gt;language-&gt;get(''entry_template'');\r\n            $this-&gt;data[''entry_pdf_attach''] = $this-&gt;language-&gt;get(''entry_pdf_attach'');\r\n            $this-&gt;data[''text_select''] = $this-&gt;language-&gt;get(''text_select'');\r\n			$this-&gt;data[''text_preview''] = $this-&gt;language-&gt;get(''text_preview'');\r\n			$this-&gt;data[''warning_template_content''] = $this-&gt;language-&gt;get(''warning_template_content'');\r\n\r\n			$this-&gt;data[''language_id''] = $order_info[''language_id''];\r\n			$this-&gt;data[''store_id''] = $order_info[''store_id''];\r\n            \r\n			$this-&gt;load-&gt;model(''localisation/language'');\r\n			$this-&gt;load-&gt;model(''module/emailtemplate'');\r\n\r\n            $templates = $this-&gt;model_module_emailtemplate-&gt;getTemplates(array(\r\n				''emailtemplate_key'' =&gt; ''admin.order_update''\r\n			));\r\n\r\n			$this-&gt;data[''templates_options''] = array();\r\n\r\n			foreach($templates as $row){\r\n				$label = $row[''emailtemplate_label''];\r\n\r\n				if($row[''emailtemplate_default'']){\r\n					$label = $this-&gt;language-&gt;get(''text_default'') . '' - '' . $label;\r\n				}\r\n\r\n				$this-&gt;data[''templates_options''][] = array(\r\n					''value'' =&gt; $row[''emailtemplate_id''],\r\n					''label'' =&gt; $label\r\n				);\r\n			}\r\n\r\n            $this-&gt;data[''templates_action''] = $this-&gt;url-&gt;link(''module/emailtemplate/fetch_template'', ''output=comment&amp;token=''.$this-&gt;session-&gt;data[''token''], ''SSL'');\r\n \r\n			$this-&gt;data[''pdf_download''] = $this-&gt;url-&gt;link(''module/emailtemplate/preview_invoice'', ''token=''.$this-&gt;session-&gt;data[''token''].''&amp;order_id=''.$order_id, ''SSL''); ]]&gt;&lt;/add&gt;\r\n	&lt;/operation&gt;\r\n	&lt;operation error=&quot;skip&quot;&gt;\r\n		&lt;search position=&quot;replace&quot;&gt;&lt;![CDATA[\r\n            nl2br($result[''comment'']) ]]&gt;&lt;/search&gt;\r\n		&lt;add trim=&quot;true&quot;&gt;&lt;![CDATA[\r\n            (EmailTemplate::isHTML($result[''comment''])) ? html_entity_decode($result[''comment''], ENT_QUOTES, ''UTF-8'') : nl2br($result[''comment''], true) ]]&gt;&lt;/add&gt;\r\n	&lt;/operation&gt;\r\n	&lt;operation&gt;\r\n		&lt;search error=&quot;skip&quot; position=&quot;replace&quot;&gt;&lt;![CDATA[\r\n            nl2br($order_info[''comment'']) ]]&gt;&lt;/search&gt;\r\n		&lt;add trim=&quot;true&quot;&gt;&lt;![CDATA[\r\n            (EmailTemplate::isHTML($order_info[''comment''])) ? html_entity_decode($order_info[''comment''], ENT_QUOTES, ''UTF-8'') : nl2br($order_info[''comment''], true) ]]&gt;&lt;/add&gt;\r\n	&lt;/operation&gt;\r\n&lt;/file&gt;\r\n		\r\n&lt;file name=&quot;admin/view/template/sale/order_info.tpl&quot;&gt;\r\n	&lt;operation&gt;\r\n		&lt;search position=&quot;before&quot;&gt;&lt;![CDATA[\r\n            &lt;?php echo $footer; ?&gt; ]]&gt;&lt;/search&gt;\r\n		&lt;add&gt;&lt;![CDATA[			\r\n&lt;script type=&quot;text/javascript&quot; src=&quot;view/javascript/ckeditor/ckeditor.js&quot;&gt;&lt;/script&gt;\r\n&lt;script type=&quot;text/javascript&quot;&gt;&lt;!--\r\n(function($){\r\n\r\n	// Order history show/hide summary options\r\n	function showEmailOptions($row, $checkbox){\r\n		if($checkbox.is('':checked'')) { \r\n			$row.show(); \r\n		} else { \r\n			$row.hide(); \r\n		}\r\n	}				\r\n	\r\n	$(document).ready(function() {\r\n		$(''input[name=notify]'').eq(0).each(function(){\r\n			showEmailOptions($(''.emailOptions''), $(this));\r\n		}).change(function(){\r\n			showEmailOptions($(''.emailOptions''), $(this));\r\n		});\r\n		\r\n   		$(''select#field_templates'').change(function(){			\r\n			var val = $(this).val();\r\n			if (!val || !confirm(&quot;&lt;?php echo $warning_template_content; ?&gt;&quot;)) return;\r\n			$.ajax({\r\n				url: ''&lt;?php echo html_entity_decode($templates_action); ?&gt;'',\r\n	  			type: ''get'',\r\n				data: ''id='' + val + ''&amp;store_id=&lt;?php echo $store_id; ?&gt;'' + ''&amp;language_id=&lt;?php echo $language_id; ?&gt;'' + ''&amp;order_id=&lt;?php echo $order_id; ?&gt;'',\r\n				dataType: ''html'',\r\n	  			success: function(html) {\r\n					$(''textarea[name=comment]'').val(html);\r\n					if(typeof CKEDITOR !== &quot;undefined&quot;){\r\n						CKEDITOR.instances[''comment''].setData(html);\r\n					}\r\n				},\r\n				error: function(xhr, ajaxOptions, thrownError) {\r\n					console.log(thrownError + &quot;\\r\\n&quot; + xhr.statusText + &quot;\\r\\n&quot; + xhr.responseText);\r\n					alert(''Error. More details in console.'');\r\n				}\r\n			});	\r\n		});\r\n 	}); // doc.ready\r\n})(jQuery);		\r\n			\r\nif(typeof CKEDITOR !== &quot;undefined&quot;){\r\n	CKEDITOR.replace(''comment'', {\r\n		filebrowserImageBrowseUrl: ''index.php?route=common/filemanager&amp;token=&lt;?php echo $token; ?&gt;'',\r\n		filebrowserUploadUrl: ''index.php?route=common/filemanager&amp;token=&lt;?php echo $token; ?&gt;'',\r\n		filebrowserImageUploadUrl: ''index.php?route=common/filemanager&amp;token=&lt;?php echo $token; ?&gt;''\r\n	});\r\n\r\n	// Output dimensions of images as width and height\r\n	CKEDITOR.on(''instanceReady'', function (ev) {\r\n		ev.editor.dataProcessor.htmlFilter.addRules({\r\n			elements: {\r\n				$: function(element){                \r\n					if (element.name == ''img'') {\r\n						var style = element.attributes.style;\r\n\r\n						if (style) {\r\n							// Get the width from the style.\r\n							var match = /(?:^|\\s)width\\s*:\\s*(\\d+)px/i.exec(style),\r\n								width = match &amp;&amp; match[1];\r\n\r\n							// Get the height from the style.\r\n							match = /(?:^|\\s)height\\s*:\\s*(\\d+)px/i.exec(style);\r\n							var height = match &amp;&amp; match[1];\r\n\r\n							if (width) {\r\n								element.attributes.style = element.attributes.style.replace(/(?:^|\\s)width\\s*:\\s*(\\d+)px;?/i, '''');\r\n								element.attributes.width = width;\r\n							}\r\n\r\n							if (height) {\r\n								element.attributes.style = element.attributes.style.replace(/(?:^|\\s)height\\s*:\\s*(\\d+)px;?/i, '''');\r\n								element.attributes.height = height;\r\n							}\r\n						}\r\n					}\r\n\r\n					if (!element.attributes.style) delete element.attributes.style;\r\n\r\n					return element;\r\n				}\r\n			}\r\n		});\r\n	});\r\n} // CKEDITOR\r\n//--&gt;&lt;/script&gt; ]]&gt;&lt;/add&gt;\r\n	&lt;/operation&gt;\r\n	&lt;operation info=&quot;Add checkboxes into ajax post data&quot;&gt;\r\n		&lt;search position=&quot;replace&quot;&gt;&lt;![CDATA[\r\n            + ''&amp;notify='' ]]&gt;&lt;/search&gt;\r\n		&lt;add trim=&quot;true&quot;&gt;&lt;![CDATA[\r\n            &lt;?php if(!empty($products)){ ?&gt;+ ($(''input[name=\\''show_products\\'']'').attr(''checked'') ? ''&amp;show_products=1'' : '''')&lt;?php }\r\n            if(!empty($downloads)){ ?&gt;+ ($(''input[name=\\''show_downloads\\'']'').attr(''checked'') ? ''&amp;show_downloads=1'' : '''')&lt;?php }\r\n            if(!empty($vouchers)){ ?&gt;+ ($(''input[name=\\''show_vouchers\\'']'').attr(''checked'') ? ''&amp;show_vouchers=1'' : '''')&lt;?php } \r\n            if(!empty($totals)){ ?&gt;+ ($(''input[name=\\''show_totals\\'']'').attr(''checked'') ? ''&amp;show_totals=1'' : '''')&lt;?php } ?&gt;\r\n            + ($(''input[name=\\''attach_invoice_pdf\\'']'').attr(''checked'') ? ''&amp;attach_invoice_pdf=1'' : '''') \r\n			+ ($(''select[name=\\''field_template\\'']'').val() ? ''&amp;field_template='' + $(''select[name=\\''field_template\\'']'').val() : '''')\r\n			+ ''&amp;notify='' ]]&gt;&lt;/add&gt;\r\n	&lt;/operation&gt;\r\n	&lt;operation error=&quot;skip&quot;&gt;\r\n		&lt;search position=&quot;after&quot;&gt;&lt;![CDATA[\r\n            $(''#button-history'').live(''click'', function() { ]]&gt;&lt;/search&gt;\r\n		&lt;add&gt;&lt;![CDATA[            if(typeof CKEDITOR !== &quot;undefined&quot;)\r\n									CKEDITOR.instances.comment.updateElement(); ]]&gt;&lt;/add&gt;\r\n	&lt;/operation&gt;\r\n	&lt;operation error=&quot;skip&quot; info=&quot;Old versions opencart&quot;&gt;\r\n		&lt;search position=&quot;after&quot;&gt;&lt;![CDATA[\r\n            function history() { ]]&gt;&lt;/search&gt;\r\n		&lt;add&gt;&lt;![CDATA[            if(typeof CKEDITOR !== &quot;undefined&quot;) \r\n									CKEDITOR.instances.comment.updateElement(); ]]&gt;&lt;/add&gt;\r\n	&lt;/operation&gt;\r\n	&lt;operation error=&quot;skip&quot;&gt;\r\n		&lt;search position=&quot;before&quot;&gt;&lt;![CDATA[\r\n            $(''textarea[name=\\''comment\\'']'').val(''''); ]]&gt;&lt;/search&gt;\r\n		&lt;add&gt;&lt;![CDATA[            if(typeof CKEDITOR !== &quot;undefined&quot;)\r\n								  	CKEDITOR.instances.comment.setData('''');            \r\n            $(''.emailOptions input[type=checkbox], .emailOptions input[type=radio], input[name=notify]'').removeAttr(''checked'');\r\n           	$(''.emailOptions option'').removeAttr(''selected'');\r\n           	$(''.emailOptions'').hide(); ]]&gt;&lt;/add&gt;\r\n	&lt;/operation&gt;\r\n	&lt;operation info=&quot;Add order summary option&quot;&gt;\r\n		&lt;search position=&quot;after&quot;&gt;&lt;![CDATA[\r\n            &lt;td&gt;&lt;input type=&quot;checkbox&quot; name=&quot;notify&quot; value=&quot;1&quot; /&gt;&lt;/td&gt; ]]&gt;&lt;/search&gt;\r\n		&lt;add&gt;&lt;![CDATA[\r\n          &lt;/tr&gt;\r\n          &lt;tr class=&quot;emailOptions&quot; style=&quot;display: none&quot;&gt;\r\n            &lt;td&gt;&lt;?php echo $entry_summary; ?&gt;&lt;/td&gt;\r\n            &lt;td&gt;\r\n            	&lt;?php if(!empty($products)){ ?&gt;\r\n            		&lt;label&gt;&lt;input type=&quot;checkbox&quot; name=&quot;show_products&quot; value=&quot;1&quot; style=&quot;vertical-align: middle;&quot; /&gt; &lt;?php echo $entry_show_products; ?&gt;&lt;/label&gt;&lt;br /&gt;\r\n           		&lt;?php } ?&gt;\r\n            	&lt;?php if(!empty($totals)){ ?&gt;\r\n            		&lt;hr style=&quot;border-top: 1px dotted #ccc; background: none; border-bottom: none; border-left: none; border-right: none; margin: 0;&quot; /&gt;\r\n            		&lt;label&gt;&lt;input type=&quot;checkbox&quot; name=&quot;show_totals&quot; value=&quot;1&quot; style=&quot;vertical-align: middle;&quot; /&gt; &lt;?php echo $entry_show_totals; ?&gt;&lt;/label&gt;&lt;br /&gt;\r\n           		&lt;?php } ?&gt;\r\n	         	&lt;?php if(!empty($downloads)){ ?&gt;\r\n	         		&lt;hr style=&quot;border-top: 1px dotted #ccc; background: none; border-bottom: none; border-left: none; border-right: none; margin: 0;&quot; /&gt;\r\n	         		&lt;label&gt;&lt;input type=&quot;checkbox&quot; name=&quot;show_downloads&quot; value=&quot;1&quot; style=&quot;vertical-align: middle;&quot; /&gt; &lt;?php echo $entry_show_downloads; ?&gt;&lt;/label&gt;&lt;br /&gt;\r\n         		&lt;?php } ?&gt;\r\n	         	&lt;?php if(!empty($vouchers)){ ?&gt;\r\n	         		&lt;hr style=&quot;border-top: 1px dotted #ccc; background: none; border-bottom: none; border-left: none; border-right: none; margin: 0;&quot; /&gt;\r\n	         		&lt;label&gt;&lt;input type=&quot;checkbox&quot; name=&quot;show_vouchers&quot; value=&quot;1&quot; style=&quot;vertical-align: middle;&quot; /&gt; &lt;?php echo $entry_show_vouchers; ?&gt;&lt;/label&gt;\r\n         		&lt;?php } ?&gt;\r\n   			&lt;/td&gt;\r\n          &lt;/tr&gt;\r\n          &lt;tr class=&quot;emailOptions&quot; style=&quot;display: none&quot;&gt;\r\n            &lt;td&gt;\r\n            	&lt;?php echo $entry_pdf_attach; ?&gt;&lt;br /&gt;\r\n            	[&lt;a href=&quot;&lt;?php echo $pdf_download; ?&gt;&quot; target=&quot;_blank&quot;&gt;&lt;?php echo $text_preview; ?&gt;&lt;/a&gt;]\r\n           	&lt;/td&gt;\r\n            &lt;td&gt;\r\n         		&lt;label&gt;&lt;input type=&quot;checkbox&quot; name=&quot;attach_invoice_pdf&quot; value=&quot;1&quot; style=&quot;vertical-align: middle;&quot; /&gt;&lt;/label&gt;\r\n			&lt;/td&gt;   \r\n  	 	  &lt;?php if(!empty($templates_options)){ ?&gt;			\r\n          &lt;/tr&gt;\r\n          &lt;tr class=&quot;emailOptions&quot; style=&quot;display: none&quot;&gt;\r\n            &lt;td&gt;&lt;?php echo $entry_template; ?&gt;&lt;/td&gt;\r\n            &lt;td&gt;\r\n            	&lt;select id=&quot;field_templates&quot; name=&quot;field_template&quot;&gt;\r\n	 				&lt;option value=''''&gt;&lt;?php echo $text_select; ?&gt;&lt;/option&gt;\r\n	            	&lt;?php foreach($templates_options as $item){ ?&gt;\r\n	            		&lt;option value=&quot;&lt;?php echo $item[''value'']; ?&gt;&quot;&gt;&lt;?php echo $item[''label'']; ?&gt;&lt;/option&gt;\r\n	            	&lt;?php } ?&gt;\r\n            	&lt;/select&gt;\r\n 			&lt;/td&gt; \r\n		  &lt;?php } ?&gt; ]]&gt;&lt;/add&gt;\r\n	&lt;/operation&gt;\r\n&lt;/file&gt;\r\n\r\n&lt;file name=&quot;admin/model/sale/order.php&quot;&gt;\r\n	&lt;operation&gt;\r\n		&lt;search position=&quot;after&quot; index=&quot;1&quot;&gt;&lt;![CDATA[\r\n            $this-&gt;db-&gt;query(&quot;INSERT INTO &quot; . DB_PREFIX . &quot;order_history ]]&gt;&lt;/search&gt;\r\n		&lt;add&gt;&lt;![CDATA[		$order_history_id = $this-&gt;db-&gt;getLastId();]]&gt;&lt;/add&gt;\r\n	&lt;/operation&gt;\r\n	&lt;operation&gt;\r\n		&lt;search position=&quot;after&quot;&gt;&lt;![CDATA[\r\n            if ($data[''notify'']) ]]&gt;&lt;/search&gt;\r\n		&lt;add&gt;&lt;![CDATA[\r\n            $template = new EmailTemplate($this-&gt;request, $this-&gt;registry);\r\n     \r\n			$template-&gt;data[''payment_address''] = EmailTemplate::formatAddress($order_info, ''payment'', $order_info[''payment_address_format'']);\r\n			\r\n			$template-&gt;data[''shipping_address''] = EmailTemplate::formatAddress($order_info, ''shipping'', $order_info[''shipping_address_format'']);			\r\n			if($template-&gt;data[''shipping_address''] == ''''){\r\n				$template-&gt;data[''shipping_address''] = $template-&gt;data[''payment_address''];\r\n			}\r\n\r\n            $template-&gt;data[''products''] = array();  \r\n            if(isset($data[''show_products''])){ \r\n            	$this-&gt;load-&gt;model(''tool/image'');  \r\n            	$this-&gt;load-&gt;model(''catalog/product'');  \r\n				$products = $this-&gt;model_sale_order-&gt;getOrderProducts($this-&gt;request-&gt;get[''order_id'']);	\r\n				\r\n				foreach ($products as $product) {\r\n					$product = array_merge($this-&gt;model_catalog_product-&gt;getProduct($product[''product_id'']), $product);\r\n				\r\n					// Product Options\r\n					$option_data = array();	\r\n					$options = $this-&gt;model_sale_order-&gt;getOrderOptions($this-&gt;request-&gt;get[''order_id''], $product[''order_product_id'']);	\r\n					foreach ($options as $option) {\r\n						if ($option[''type''] != ''file'') {\r\n							$option_data[] = array(\r\n								''name''  =&gt; $option[''name''],\r\n								''value'' =&gt; $option[''value''],\r\n								''type''  =&gt; $option[''type'']\r\n							);\r\n						} else {\r\n							$option_data[] = array(\r\n								''name''  =&gt; $option[''name''],\r\n								''value'' =&gt; substr($option[''value''], 0, strrpos($option[''value''], ''.'')),\r\n								''type''  =&gt; $option[''type''],\r\n								''href''  =&gt; $this-&gt;url-&gt;link(''sale/order/download'', ''token='' . $this-&gt;session-&gt;data[''token''] . ''&amp;order_id='' . $this-&gt;request-&gt;get[''order_id''] . ''&amp;order_option_id='' . $option[''order_option_id''], ''SSL'')\r\n							);						\r\n						}\r\n					}\r\n					\r\n					if (isset($product[''image''])) {\r\n						$image = $this-&gt;model_tool_image-&gt;resize($product[''image''], 50, 50);\r\n					} else {\r\n						$image = '''';\r\n					}\r\n\r\n					$url = $order_info[''store_url''] . ''?route=product/product&amp;product_id=''.$product[''product_id''];\r\n	\r\n					$template-&gt;data[''products''][] = array(\r\n						''url''     		=&gt; $url,\r\n						''url_tracking'' 	=&gt; $template-&gt;getTracking($url),\r\n						''order_product_id'' =&gt; $product[''order_product_id''],\r\n						''product_id''       =&gt; $product[''product_id''],\r\n						''name''    	 	   =&gt; $product[''name''],\r\n						''model''    		   =&gt; $product[''model''],\r\n						''image''    		   =&gt; $image,\r\n						''option''   		   =&gt; $option_data,\r\n						''quantity''		   =&gt; $product[''quantity''],\r\n						''price''    		   =&gt; $this-&gt;currency-&gt;format($product[''price''] + ($this-&gt;config-&gt;get(''config_tax'') ? $product[''tax''] : 0), $order_info[''currency_code''], $order_info[''currency_value'']),\r\n						''total''    		   =&gt; $this-&gt;currency-&gt;format($product[''total''] + ($this-&gt;config-&gt;get(''config_tax'') ? ($product[''tax''] * $product[''quantity'']) : 0), $order_info[''currency_code''], $order_info[''currency_value'']),\r\n						''href''     		   =&gt; $this-&gt;url-&gt;link(''catalog/product/update'', ''token='' . $this-&gt;session-&gt;data[''token''] . ''&amp;product_id='' . $product[''product_id''], ''SSL'')\r\n					);\r\n				}\r\n			} // Products\r\n			\r\n			$template-&gt;data[''vouchers''] = array();\r\n			if(isset($data[''show_vouchers''])){\r\n				$vouchers = $this-&gt;model_sale_order-&gt;getOrderVouchers($this-&gt;request-&gt;get[''order_id'']);			 \r\n				foreach ($vouchers as $voucher) {\r\n					$template-&gt;data[''vouchers''][] = array(\r\n						''description'' =&gt; $voucher[''description''],\r\n						''amount''      =&gt; $this-&gt;currency-&gt;format($voucher[''amount''], $order_info[''currency_code''], $order_info[''currency_value'']),\r\n						''href''        =&gt; $this-&gt;url-&gt;link(''sale/voucher/update'', ''token='' . $this-&gt;session-&gt;data[''token''] . ''&amp;voucher_id='' . $voucher[''voucher_id''], ''SSL'')\r\n					);\r\n				}\r\n			} // Vouchers\r\n			\r\n			$template-&gt;data[''totals''] = array();\r\n			if(isset($data[''show_totals''])){\r\n				$template-&gt;data[''totals''] = $this-&gt;model_sale_order-&gt;getOrderTotals($this-&gt;request-&gt;get[''order_id'']);\r\n			} // Totals	\r\n			\r\n			$template-&gt;data[''downloads''] = array();\r\n			if(isset($data[''show_downloads''])){				\r\n				foreach ($products as $product) {\r\n					$results = $this-&gt;model_sale_order-&gt;getOrderDownloads($this-&gt;request-&gt;get[''order_id''], $product[''order_product_id'']);	\r\n					foreach ($results as $result) {\r\n						$template-&gt;data[''downloads''][] = array(\r\n							''name''      =&gt; $result[''name''],\r\n							''filename''  =&gt; $result[''mask''],\r\n							''remaining'' =&gt; $result[''remaining'']\r\n						);\r\n					}\r\n				}\r\n			} // Downloads	\r\n			\r\n			$attachments = array();\r\n			if(isset($data[''attach_invoice_pdf''])){\r\n				$this-&gt;load-&gt;model(''module/emailtemplate/invoice'');\r\n				$template-&gt;data[''emailtemplate_invoice_pdf''] = $this-&gt;model_module_emailtemplate_invoice-&gt;getInvoice($this-&gt;request-&gt;get[''order_id''], true);\r\n				$attachments[] = $template-&gt;data[''emailtemplate_invoice_pdf''];\r\n			} ]]&gt;&lt;/add&gt;\r\n	&lt;/operation&gt;\r\n	&lt;operation&gt;\r\n		&lt;search position=&quot;after&quot;&gt;&lt;![CDATA[\r\n            $message .= $language-&gt;get(''text_footer''); ]]&gt;&lt;/search&gt;\r\n		&lt;add&gt;&lt;![CDATA[  \r\n            if (!empty($template-&gt;data[''products''])) {\r\n            	$message .= &quot;\\n&quot; . $language-&gt;get(''text_products'') . &quot;\\n&quot;; \r\n	            foreach ($template-&gt;data[''products''] as $product) {\r\n	                $message .= $product[''quantity''] . ''x '' . $product[''name''] . '' ('' . $product[''model''] . '') '' . html_entity_decode($product[''total''], ENT_NOQUOTES, ''UTF-8'') . &quot;\\n&quot;;\r\n	                foreach ($product[''option''] as $option) {\r\n	                    $message .= chr(9) . ''-'' . $option[''name''] . '' '' . (strlen($option[''value'']) &gt; 20 ? substr($option[''value''], 0, 20) . ''..'' : $option[''value'']) . &quot;\\n&quot;;\r\n	                }\r\n            	}\r\n            }\r\n\r\n	        if (!empty($template-&gt;data[''vouchers''])) { \r\n	            foreach ($template-&gt;data[''vouchers''] as $voucher) {\r\n	                $message .= ''1x '' . $voucher[''description''] . '' '' . $this-&gt;currency-&gt;format($voucher[''amount''], $order_info[''currency_code''], $order_info[''currency_value'']);\r\n	            }\r\n            }\r\n            \r\n			if (!empty($template-&gt;data[''totals''])) {\r\n	            $message .= &quot;\\n&quot; . $language-&gt;get(''text_total'') . &quot;\\n&quot;;	\r\n	            foreach ($template-&gt;data[''totals''] as $total) {\r\n	                $message .= $total[''title''] . '': '' . html_entity_decode($total[''text''], ENT_NOQUOTES, ''UTF-8'') . &quot;\\n&quot;;\r\n	            }\r\n            }\r\n               \r\n            if (!empty($template-&gt;data[''downloads''])) {\r\n                $message .= &quot;\\n&quot; . $language-&gt;get(''text_download'') . &quot;\\n&quot;;\r\n                $message .= $order_info[''store_url''] . ''index.php?route=account/download'' . &quot;\\n\\n&quot;;\r\n            }\r\n\r\n			$template-&gt;addData($data);\r\n\r\n			$template-&gt;addData($order_info);\r\n             \r\n            $template-&gt;data[''new_comment''] = html_entity_decode($data[''comment''], ENT_QUOTES, ''UTF-8'');\r\n            $template-&gt;data[''invoice''] = html_entity_decode($order_info[''store_url''] . ''index.php?route=account/order/info&amp;order_id='' . $order_id, ENT_QUOTES, ''UTF-8'');\r\n			$template-&gt;data[''invoice_tracking''] = $template-&gt;getTracking($template-&gt;data[''invoice'']);\r\n\r\n			$template-&gt;data[''date_added''] = date($language-&gt;get(''date_format_short''), strtotime($order_info[''date_added'']));\r\n            \r\n			if ($order_status_query-&gt;num_rows) {\r\n            	$template-&gt;data[''order_status''] = $order_status_query-&gt;row[''name'']; \r\n			} ]]&gt;&lt;/add&gt;\r\n	&lt;/operation&gt;\r\n	&lt;operation&gt;\r\n		&lt;search position=&quot;replace&quot; index=&quot;1&quot;&gt;&lt;![CDATA[\r\n            $mail-&gt;send(); ]]&gt;&lt;/search&gt;\r\n		&lt;add&gt;&lt;![CDATA[			$template_data = array(''key'' =&gt;''admin.order_update'');\r\n			if(!empty($data[''field_template''])){\r\n				$template_data[''emailtemplate_id''] = $data[''field_template''];\r\n			}\r\n			if(!empty($data[''order_status_id''])){\r\n				$template_data[''order_status_id''] = $data[''order_status_id''];\r\n			}\r\n			if(isset($order_info[''store_id''])){\r\n				$template_data[''store_id''] = $order_info[''store_id''];\r\n			}\r\n			if(isset($order_info[''language_id''])){\r\n				$template_data[''language_id''] = $order_info[''language_id''];\r\n			}\r\n\r\n            $template-&gt;load($template_data);\r\n\r\n            $mail = $template-&gt;hook($mail);\r\n            foreach($attachments as $attachment){\r\n            	$mail-&gt;addAttachment($attachment);\r\n            } \r\n \r\n			$mail-&gt;send();\r\n\r\n			$template-&gt;sent(); ]]&gt;&lt;/add&gt;\r\n	&lt;/operation&gt;\r\n	&lt;operation error=&quot;skip&quot;&gt;\r\n		&lt;search position=&quot;replace&quot;&gt;&lt;![CDATA[\r\n            comment = ''&quot; . $this-&gt;db-&gt;escape(strip_tags($data[''comment''])) . &quot;'' ]]&gt;&lt;/search&gt;\r\n		&lt;add trim=&quot;true&quot;&gt;&lt;![CDATA[\r\n            comment = ''&quot; . $this-&gt;db-&gt;escape($data[''comment'']) . &quot;'' ]]&gt;&lt;/add&gt;\r\n	&lt;/operation&gt;\r\n    &lt;operation&gt;\r\n        &lt;search position=&quot;before&quot;&gt;&lt;![CDATA[\r\n            =&gt; $order_query-&gt;row[''payment_firstname''], ]]&gt;&lt;/search&gt;\r\n        &lt;add&gt;&lt;![CDATA[            	''invoice_filename'' 		   =&gt; $order_query-&gt;row[''invoice_filename''], ]]&gt;&lt;/add&gt;\r\n	&lt;/operation&gt;\r\n&lt;/file&gt;' 
 WHERE `emailtemplate_default` = 1 AND `emailtemplate_key` = 'admin.order_update';
 
UPDATE `{$p}emailtemplate`  
   SET `emailtemplate_vqmod` = '&lt;file name=&quot;admin/controller/sale/contact.php&quot;&gt;\r\n	&lt;operation&gt; \r\n		&lt;search position=&quot;after&quot;&gt;&lt;![CDATA[\r\n            $this-&gt;data[''entry_message''] = $this-&gt;language-&gt;get(''entry_message''); ]]&gt;&lt;/search&gt;\r\n		&lt;add&gt;&lt;![CDATA[\r\n		$this-&gt;data[''entry_template''] = $this-&gt;language-&gt;get(''entry_template'');\r\n		$this-&gt;data[''entry_campaign_name''] = $this-&gt;language-&gt;get(''entry_campaign_name'');\r\n		$this-&gt;data[''warning_template_content''] = $this-&gt;language-&gt;get(''warning_template_content'');\r\n		$this-&gt;data[''text_select''] = $this-&gt;language-&gt;get(''text_select'');\r\n\r\n		$this-&gt;load-&gt;model(''localisation/language'');\r\n		$this-&gt;load-&gt;model(''module/emailtemplate'');\r\n\r\n        $templates = $this-&gt;model_module_emailtemplate-&gt;getTemplates(array(\r\n			''emailtemplate_key'' =&gt; ''admin.newsletter''\r\n		));\r\n\r\n		$this-&gt;data[''templates_options''] = array();\r\n\r\n		foreach($templates as $row){\r\n			$label = $row[''emailtemplate_label''];\r\n\r\n			if($row[''emailtemplate_default'']){\r\n				$label = $this-&gt;language-&gt;get(''text_default'') . '' - '' . $label;\r\n			}\r\n\r\n			$this-&gt;data[''templates_options''][] = array(\r\n				''value'' =&gt; $row[''emailtemplate_id''],\r\n				''label'' =&gt; $label\r\n			);\r\n		}\r\n\r\n		$this-&gt;data[''languages''] = $this-&gt;model_localisation_language-&gt;getLanguages();		\r\n\r\n		$config = $this-&gt;model_module_emailtemplate-&gt;getConfig(1, true, true);\r\n        $this-&gt;data[''campaign_name''] = $config[''tracking_campaign_name''];    \r\n		 \r\n        $this-&gt;data[''templates_action''] = $this-&gt;url-&gt;link(''module/emailtemplate/get_template'', ''token=''.$this-&gt;session-&gt;data[''token''], ''SSL''); ]]&gt;&lt;/add&gt;\r\n	&lt;/operation&gt;\r\n	\r\n	&lt;operation info=&quot;Add extra info into email array&quot;&gt;\r\n		&lt;search position=&quot;replace&quot;&gt;&lt;![CDATA[\r\n			$emails[] = $customer_info[''email'']; ]]&gt;&lt;/search&gt;\r\n		&lt;add&gt;&lt;![CDATA[ $emails[] = array(\r\n				   ''customer'' =&gt; $customer_info,\r\n				   ''email'' =&gt; $customer_info[''email''],\r\n				   ''customer_id'' =&gt; $customer_info[''customer_id''],\r\n				   ''store_id'' =&gt; $customer_info[''store_id''],\r\n				   ''language_id'' =&gt; $customer_info[''language_id'']\r\n				  ); ]]&gt;&lt;/add&gt;\r\n	&lt;/operation&gt;\r\n	&lt;operation info=&quot;Add extra info into email array&quot;&gt;\r\n		&lt;search position=&quot;replace&quot;&gt;&lt;![CDATA[\r\n			$emails[$result[''customer_id'']] = $result[''email'']; ]]&gt;&lt;/search&gt;\r\n		&lt;add&gt;&lt;![CDATA[ $emails[$result[''customer_id'']] = array(\r\n				 ''email'' =&gt; $result[''email''],\r\n				 ''customer_id'' =&gt; $result[''customer_id''],\r\n				 ''store_id'' =&gt; $result[''store_id''],\r\n				 ''language_id'' =&gt; $result[''language_id'']\r\n				); ]]&gt;&lt;/add&gt;\r\n	&lt;/operation&gt;\r\n	&lt;operation info=&quot;affiliate_all&quot;&gt;\r\n		&lt;search position=&quot;replace&quot; index=&quot;3&quot;&gt;&lt;![CDATA[\r\n			$emails[] = $result[''email'']; ]]&gt;&lt;/search&gt;\r\n		&lt;add&gt;&lt;![CDATA[ $emails[$result[''affiliate_id'']] = array(\r\n				 ''email'' =&gt; $result[''email''],\r\n				 ''affiliate_id'' =&gt; $result[''affiliate_id'']\r\n				); ]]&gt;&lt;/add&gt;\r\n	&lt;/operation&gt;\r\n	&lt;operation info=&quot;affiliate&quot;&gt;\r\n		&lt;search position=&quot;replace&quot;&gt;&lt;![CDATA[\r\n			$emails[] = $affiliate_info[''email'']; ]]&gt;&lt;/search&gt;\r\n		&lt;add&gt;&lt;![CDATA[ $emails[$affiliate_info[''affiliate_id'']] = array(\r\n				   ''affiliate'' =&gt; $affiliate_info,\r\n				   ''email'' =&gt; $affiliate_info[''email''],\r\n				   ''affiliate_id'' =&gt; $affiliate_info[''affiliate_id'']\r\n				  ); ]]&gt;&lt;/add&gt;\r\n	&lt;/operation&gt;\r\n	&lt;operation info=&quot;newsletter, customer_all, product&quot;&gt;\r\n		&lt;search position=&quot;replace&quot;&gt;&lt;![CDATA[\r\n			$emails[] = $result[''email'']; ]]&gt;&lt;/search&gt;\r\n		&lt;add&gt;&lt;![CDATA[ $emails[$result[''customer_id'']] = array(\r\n				 ''email'' =&gt; $result[''email''],\r\n				 ''customer_id'' =&gt; $result[''customer_id''],\r\n				 ''store_id'' =&gt; $result[''store_id''],\r\n				 ''language_id'' =&gt; $result[''language_id'']\r\n				); ]]&gt;&lt;/add&gt;\r\n	&lt;/operation&gt;\r\n	\r\n	&lt;operation info=&quot;Move message into foreach&quot;&gt;\r\n		&lt;search position=&quot;replace&quot;&gt;&lt;![CDATA[\r\n            foreach ($emails as $email) { ]]&gt;&lt;/search&gt;\r\n		&lt;add&gt;&lt;/add&gt;\r\n	&lt;/operation&gt;  \r\n	&lt;operation&gt;\r\n		&lt;search position=&quot;before&quot;&gt;&lt;![CDATA[\r\n            $message  = ''&lt;html  ]]&gt;&lt;/search&gt;\r\n		&lt;add&gt;&lt;![CDATA[				foreach ($emails as $email) {\r\n					if(empty($email[''customer_id'']) &amp;&amp; empty($email[''affiliate_id''])) continue;\r\n\r\n					$template = new EmailTemplate($this-&gt;request, $this-&gt;registry);\r\n            \r\n					if(isset($email[''customer''])){\r\n						$template-&gt;addData($email[''customer'']);\r\n						unset($email[''customer'']);\r\n					} elseif(isset($email[''customer_id''])){\r\n						$customer_info = $this-&gt;model_sale_customer-&gt;getCustomer($email[''customer_id'']);\r\n						$template-&gt;addData($customer_info);\r\n					}\r\n\r\n					if(isset($email[''affiliate''])){\r\n						$template-&gt;addData($email[''affiliate'']);\r\n						unset($email[''affiliate'']);\r\n					} elseif(isset($email[''affiliate_id''])){\r\n						$affiliate_info = $this-&gt;model_sale_affiliate-&gt;getAffiliate($email[''affiliate_id'']);\r\n						$template-&gt;addData($affiliate_info);\r\n					}\r\n\r\n					if(isset($email[''language_id'']) &amp;&amp; $email[''language_id'']){\r\n						$language_id = $email[''language_id''];\r\n					} else {\r\n						$language_id = $this-&gt;config-&gt;get(''config_language_id'');\r\n					}\r\n			\r\n  					// Default store auto select from db\r\n					if($this-&gt;request-&gt;post[''store_id''] == 0 &amp;&amp; isset($email[''store_id''])){\r\n 						$store_id = $email[''store_id''];\r\n					} else {\r\n						$store_id = $this-&gt;request-&gt;post[''store_id''];\r\n					}\r\n\r\n					$template_data = array(\r\n						''key'' =&gt; ''admin.newsletter'',\r\n						''store_id'' =&gt; $store_id\r\n					);\r\n\r\n					$template-&gt;load($template_data);\r\n					\r\n					if(!empty($template-&gt;data[''emailtemplate''][''unsubscribe_text'']) &amp;&amp; in_array($this-&gt;request-&gt;post[''to''], array(''newsletter'', ''customer_all'', ''customer_group'', ''customer''))) {\r\n						$url = (isset($store_info[''url'']) ? $store_info[''url''] : HTTP_CATALOG) . ''index.php?route=account/newsletter/unsubscribe&amp;code=''.md5($email[''email'']);\r\n						$template-&gt;data[''unsubscribe''] = sprintf(html_entity_decode($template-&gt;data[''emailtemplate''][''unsubscribe_text''], ENT_QUOTES, ''UTF-8''), $url);\r\n				    }\r\n\r\n					if(!empty($this-&gt;request-&gt;post[''subject''][$language_id])){\r\n						$subject = $this-&gt;request-&gt;post[''subject''][$language_id];\r\n					} else {\r\n						$subject = $store_name;\r\n					}\r\n\r\n					$body = $this-&gt;request-&gt;post[''message''][$language_id];\r\n\r\n					$template-&gt;addData($email);\r\n\r\n					$template-&gt;set(''subject'', $subject);\r\n					\r\n					$template-&gt;data[''config''][''tracking_campaign_name''] = $this-&gt;request-&gt;post[''campaign_name''];\r\n		]]&gt;&lt;/add&gt;\r\n	&lt;/operation&gt;\r\n	&lt;operation&gt;\r\n		&lt;search position=&quot;replace&quot;&gt;&lt;![CDATA[\r\n            &lt;title&gt;'' . $this-&gt;request-&gt;post[''subject''] . ''&lt;/title&gt;'' ]]&gt;&lt;/search&gt;\r\n		&lt;add trim=&quot;true&quot;&gt;&lt;![CDATA[ \r\n			&lt;title&gt;'' . $subject . ''&lt;/title&gt;'' ]]&gt;&lt;/add&gt;\r\n	&lt;/operation&gt;\r\n	&lt;operation error=&quot;skip&quot;&gt;\r\n		&lt;search position=&quot;replace&quot;&gt;&lt;![CDATA[\r\n            $mail-&gt;setSubject(html_entity_decode($this-&gt;request-&gt;post[''subject''] ]]&gt;&lt;/search&gt;\r\n		&lt;add trim=&quot;true&quot;&gt;&lt;![CDATA[ \r\n			$mail-&gt;setSubject(html_entity_decode($subject ]]&gt;&lt;/add&gt;\r\n	&lt;/operation&gt;\r\n	&lt;operation error=&quot;skip&quot;&gt;\r\n		&lt;search position=&quot;replace&quot;&gt;&lt;![CDATA[\r\n            $mail-&gt;setSubject($this-&gt;request-&gt;post[''subject''] ]]&gt;&lt;/search&gt;\r\n		&lt;add trim=&quot;true&quot;&gt;&lt;![CDATA[ \r\n			$mail-&gt;setSubject($subject ]]&gt;&lt;/add&gt;\r\n	&lt;/operation&gt;\r\n	&lt;operation&gt;\r\n		&lt;search position=&quot;replace&quot;&gt;&lt;![CDATA[\r\n            html_entity_decode($this-&gt;request-&gt;post[''message'']  ]]&gt;&lt;/search&gt;\r\n		&lt;add trim=&quot;true&quot;&gt;&lt;![CDATA[ \r\n			html_entity_decode($message ]]&gt;&lt;/add&gt;\r\n	&lt;/operation&gt;\r\n	&lt;operation&gt;\r\n		&lt;search position=&quot;replace&quot;&gt;&lt;![CDATA[\r\n            $mail-&gt;setHtml($message); ]]&gt;&lt;/search&gt;\r\n		&lt;add&gt;&lt;![CDATA[$template-&gt;build();\r\n						$template-&gt;fetch(null, $body);			\r\n						$mail = $template-&gt;hook($mail); ]]&gt;&lt;/add&gt;\r\n	&lt;/operation&gt;\r\n	&lt;operation&gt;\r\n		&lt;search position=&quot;after&quot;&gt;&lt;![CDATA[\r\n            $mail-&gt;send(); ]]&gt;&lt;/search&gt;\r\n		&lt;add&gt;&lt;![CDATA[						$template-&gt;sent(); ]]&gt;&lt;/add&gt;\r\n	&lt;/operation&gt;\r\n	&lt;operation error=&quot;skip&quot;&gt;\r\n		&lt;search position=&quot;replace&quot;&gt;&lt;![CDATA[\r\n            $mail-&gt;addAttachment($attachment[''path''], $attachment[''filename'']); ]]&gt;&lt;/search&gt;\r\n		&lt;add&gt;&lt;/add&gt;\r\n	&lt;/operation&gt;        \r\n&lt;/file&gt;\r\n	\r\n&lt;file name=&quot;admin/view/template/sale/contact.tpl&quot;&gt;\r\n	&lt;operation info=&quot;Remove subject, add template&quot;&gt;\r\n		&lt;search position=&quot;replace&quot;&gt;&lt;![CDATA[\r\n            &lt;td&gt;&lt;span class=&quot;required&quot;&gt;*&lt;/span&gt; &lt;?php echo $entry_subject; ?&gt;&lt;/td&gt; ]]&gt;&lt;/search&gt;\r\n		&lt;add&gt;&lt;![CDATA[ \r\n		&lt;?php if(!empty($templates_options)){ ?&gt;\r\n            &lt;td&gt;&lt;?php echo $entry_template; ?&gt;&lt;/td&gt; ]]&gt;&lt;/add&gt;\r\n	&lt;/operation&gt;\r\n	&lt;operation&gt;\r\n		&lt;search regex=&quot;true&quot; position=&quot;replace&quot;&gt;&lt;![CDATA[~&lt;td&gt;&lt;input type=&quot;text&quot; name=&quot;subject&quot; value=&quot;.*?&quot; /&gt;&lt;/td&gt;~]]&gt;&lt;/search&gt;\r\n		&lt;add&gt;&lt;![CDATA[ \r\n			&lt;td&gt;\r\n            	&lt;select id=&quot;field_templates&quot; name=&quot;email_template&quot;&gt;\r\n					&lt;option value=''''&gt;&lt;?php echo $text_select; ?&gt;&lt;/option&gt;\r\n					&lt;?php foreach($templates_options as $item){ ?&gt;\r\n						&lt;option value=&quot;&lt;?php echo $item[''value'']; ?&gt;&quot;&gt;&lt;?php echo $item[''label'']; ?&gt;&lt;/option&gt;\r\n					&lt;?php } ?&gt;\r\n				&lt;/select&gt;\r\n			&lt;/td&gt;\r\n		  &lt;/tr&gt;\r\n		  &lt;tr&gt;\r\n		&lt;?php } ?&gt;           \r\n            &lt;td&gt;&lt;?php echo $entry_campaign_name; ?&gt;&lt;/td&gt;\r\n            &lt;td&gt;&lt;input value=&quot;&lt;?php echo $campaign_name; ?&gt;&quot; name=&quot;campaign_name&quot; type=&quot;text&quot; /&gt; ]]&gt;&lt;/add&gt;\r\n	&lt;/operation&gt;\r\n	&lt;operation info=&quot;Remove message&quot;&gt;\r\n		&lt;search position=&quot;replace&quot;&gt;&lt;![CDATA[\r\n            &lt;td&gt;&lt;span class=&quot;required&quot;&gt;*&lt;/span&gt; &lt;?php echo $entry_message; ?&gt;&lt;/td&gt; ]]&gt;&lt;/search&gt;\r\n		&lt;add&gt;&lt;/add&gt;\r\n	&lt;/operation&gt;\r\n	&lt;operation info=&quot;Remove message&quot;&gt;\r\n		&lt;search regex=&quot;true&quot; position=&quot;replace&quot;&gt;&lt;![CDATA[~&lt;td&gt;&lt;textarea name=&quot;message&quot;&gt;.*?&lt;/textarea&gt;~]]&gt;&lt;/search&gt;\r\n		&lt;add&gt;&lt;![CDATA[		\r\n		&lt;/tr&gt;\r\n   &lt;/table&gt;\r\n\r\n		&lt;div id=&quot;languages&quot; class=&quot;htabs&quot;&gt;\r\n			&lt;?php foreach ($languages as $language) { ?&gt;\r\n				&lt;a href=&quot;#language&lt;?php echo $language[''language_id'']; ?&gt;&quot;&gt;\r\n					&lt;img src=&quot;view/image/flags/&lt;?php echo $language[''image'']; ?&gt;&quot; title=&quot;&lt;?php echo $language[''name'']; ?&gt;&quot; /&gt; \r\n					&lt;?php echo $language[''name'']; ?&gt;\r\n				&lt;/a&gt;\r\n			&lt;?php } ?&gt;\r\n		&lt;/div&gt;\r\n\r\n		&lt;?php foreach ($languages as $language) { ?&gt;\r\n			&lt;div id=&quot;language&lt;?php echo $language[''language_id'']; ?&gt;&quot;&gt;\r\n				&lt;table class=&quot;form&quot;&gt;\r\n					&lt;tr&gt;\r\n						&lt;td&gt;&lt;span class=&quot;required&quot;&gt;*&lt;/span&gt; &lt;?php echo $entry_subject; ?&gt;&lt;/td&gt;\r\n                		&lt;td&gt;&lt;input type=&quot;text&quot; name=&quot;subject[&lt;?php echo $language[''language_id'']; ?&gt;]&quot; value=&quot;&quot; style=&quot;width:100%; max-width:500px&quot; /&gt;&lt;/td&gt;\r\n              		&lt;/tr&gt;\r\n              		&lt;tr&gt;\r\n                		&lt;td&gt;&lt;span class=&quot;required&quot;&gt;*&lt;/span&gt; &lt;?php echo $entry_message; ?&gt;&lt;/td&gt;\r\n                		&lt;td&gt;&lt;textarea name=&quot;message[&lt;?php echo $language[''language_id'']; ?&gt;]&quot; id=&quot;message_&lt;?php echo $language[''language_id'']; ?&gt;&quot;&gt;&lt;/textarea&gt;&lt;/td&gt;\r\n					&lt;/tr&gt;\r\n				&lt;/table&gt;\r\n			&lt;/div&gt;\r\n		&lt;?php } ?&gt;\r\n	&lt;table class=&quot;form&quot;&gt;\r\n		&lt;tr&gt;&lt;td&gt; ]]&gt;&lt;/add&gt;\r\n	&lt;/operation&gt;\r\n	&lt;operation info=&quot;Remove ckeditor so that we can add with languages&quot; error=&quot;skip&quot;&gt;\r\n		&lt;search position=&quot;replace&quot; offset=&quot;7&quot;&gt;&lt;![CDATA[\r\n            CKEDITOR.replace(''message'', { ]]&gt;&lt;/search&gt;\r\n		&lt;add&gt;&lt;/add&gt;\r\n	&lt;/operation&gt;\r\n	&lt;operation info=&quot;Remove ckeditor so that we can add with languages&quot; error=&quot;skip&quot;&gt;\r\n		&lt;search position=&quot;replace&quot; offset=&quot;7&quot;&gt;&lt;![CDATA[\r\n            $(''textarea[name=\\''message\\'']'').ckeditor({ ]]&gt;&lt;/search&gt;\r\n		&lt;add&gt;&lt;/add&gt;\r\n	&lt;/operation&gt;\r\n	&lt;operation error=&quot;skip&quot;&gt;\r\n    	&lt;search position=&quot;replace&quot;&gt;&lt;![CDATA[\r\n			$(''textarea[name=&quot;message&quot;]'').val(CKEDITOR.instances.message.getData()); ]]&gt;&lt;/search&gt;\r\n		&lt;add&gt;&lt;![CDATA[			if(typeof CKEDITOR !== &quot;undefined&quot;){\r\n				for(var instanceName in CKEDITOR.instances){\r\n					CKEDITOR.instances[instanceName].updateElement();\r\n				} \r\n			} ]]&gt;&lt;/add&gt;\r\n	&lt;/operation&gt;\r\n	&lt;operation error=&quot;skip&quot;&gt;\r\n		&lt;search position=&quot;before&quot;&gt;&lt;![CDATA[\r\n            function send(url) { ]]&gt;&lt;/search&gt;\r\n		&lt;add&gt;&lt;![CDATA[\r\n$(''#languages a'').tabs();\r\n \r\nif(typeof CKEDITOR !== &quot;undefined&quot;){\r\n	&lt;?php foreach ($languages as $language) { ?&gt;\r\n	CKEDITOR.replace(''message_&lt;?php echo $language[''language_id'']; ?&gt;'', {\r\n		filebrowserBrowseUrl: ''index.php?route=common/filemanager&amp;token=&lt;?php echo $token; ?&gt;'',\r\n		filebrowserImageBrowseUrl: ''index.php?route=common/filemanager&amp;token=&lt;?php echo $token; ?&gt;'',\r\n		filebrowserFlashBrowseUrl: ''index.php?route=common/filemanager&amp;token=&lt;?php echo $token; ?&gt;'',\r\n		filebrowserUploadUrl: ''index.php?route=common/filemanager&amp;token=&lt;?php echo $token; ?&gt;'',\r\n		filebrowserImageUploadUrl: ''index.php?route=common/filemanager&amp;token=&lt;?php echo $token; ?&gt;'',\r\n		filebrowserFlashUploadUrl: ''index.php?route=common/filemanager&amp;token=&lt;?php echo $token; ?&gt;''\r\n	});\r\n	&lt;?php } ?&gt;\r\n\r\n	// Output dimensions of images as width and height\r\n	CKEDITOR.on(''instanceReady'', function (ev) {\r\n		ev.editor.dataProcessor.htmlFilter.addRules({\r\n			elements: {\r\n				$: function(element){                \r\n					if (element.name == ''img'') {\r\n						var style = element.attributes.style;\r\n\r\n						if (style) {\r\n							// Get the width from the style.\r\n							var match = /(?:^|\\s)width\\s*:\\s*(\\d+)px/i.exec(style),\r\n								width = match &amp;&amp; match[1];\r\n\r\n							// Get the height from the style.\r\n							match = /(?:^|\\s)height\\s*:\\s*(\\d+)px/i.exec(style);\r\n							var height = match &amp;&amp; match[1];\r\n\r\n							if (width) {\r\n								element.attributes.style = element.attributes.style.replace(/(?:^|\\s)width\\s*:\\s*(\\d+)px;?/i, '''');\r\n								element.attributes.width = width;\r\n							}\r\n\r\n							if (height) {\r\n								element.attributes.style = element.attributes.style.replace(/(?:^|\\s)height\\s*:\\s*(\\d+)px;?/i, '''');\r\n								element.attributes.height = height;\r\n							}\r\n						}\r\n					}\r\n\r\n					if (!element.attributes.style) delete element.attributes.style;\r\n\r\n					return element;\r\n				}\r\n			}\r\n		});\r\n	});\r\n} // ckeditor\r\n\r\n(function($){			\r\n	$(document).ready(function() {\r\n				\r\n		$(''select#field_templates'').change(function(){\r\n			var val = $(this).val(), \r\n				language_id, \r\n				store_id = $(''select[name=store_id]'').val();\r\n\r\n			if(!val || !confirm(&quot;&lt;?php echo $warning_template_content; ?&gt;&quot;)) return;\r\n\r\n			$.ajax({ \r\n				url: ''&lt;?php echo html_entity_decode($templates_action); ?&gt;'',\r\n				type: ''get'',\r\n				data: ''id='' + val + ''&amp;store_id='' + store_id,\r\n				dataType: ''json'',\r\n				success: function(json) {\r\n					for(i in json) {\r\n 						language_id = json[i][''language_id''];\r\n						\r\n 						if(json[i][''emailtemplate''][''subject'']){\r\n							$(&quot;input[name=''subject[&quot; + language_id + &quot;]'']&quot;).val(json[i][''emailtemplate''][''subject'']);\r\n						}\r\n\r\n						$(&quot;#message_&quot; + language_id).val(json[i][''emailtemplate''][''comment'']);\r\n\r\n						if(typeof CKEDITOR !== &quot;undefined&quot;){\r\n							CKEDITOR.instances[&quot;message_&quot; + language_id].setData(json[i][''emailtemplate''][''comment'']);\r\n						}\r\n					}\r\n				},\r\n				error: function(xhr, ajaxOptions, thrownError) {\r\n                    console.log(thrownError + &quot;\\r\\n&quot; + xhr.statusText + &quot;\\r\\n&quot; + xhr.responseText);\r\n                    alert(''Error. More details in console.'');\r\n            	}\r\n			});	\r\n		});\r\n					\r\n });	// doc.ready\r\n})(jQuery); ]]&gt;&lt;/add&gt;\r\n	&lt;/operation&gt;\r\n&lt;/file&gt;' 
 WHERE `emailtemplate_default` = 1 AND `emailtemplate_key` = 'admin.newsletter';
 
UPDATE `{$p}emailtemplate`  
   SET `emailtemplate_vqmod` = '&lt;file name=&quot;admin/model/sale/voucher.php&quot;&gt;\r\n        &lt;operation&gt;\r\n            &lt;search position=&quot;replace&quot;&gt;&lt;![CDATA[\r\n            $template = new Template(); ]]&gt;&lt;/search&gt;\r\n            &lt;add&gt;&lt;![CDATA[\r\n            $template = new EmailTemplate($this-&gt;request, $this-&gt;registry);\r\n	 		$template-&gt;addData($voucher_info); ]]&gt;&lt;/add&gt;\r\n        &lt;/operation&gt;\r\n        &lt;operation error=&quot;skip&quot; info=&quot;OC:1.5.0.5&quot;&gt;\r\n            &lt;search position=&quot;replace&quot;&gt;&lt;![CDATA[\r\n            $template-&gt;data[''image''] = ''cid:'' . basename($voucher_theme_info[''image'']); ]]&gt;&lt;/search&gt;\r\n            &lt;add&gt;&lt;![CDATA[\r\n            $template-&gt;data[''image''] = HTTP_CATALOG . ''image/'' . $voucher_theme_info[''image'']; ]]&gt;&lt;/add&gt;\r\n        &lt;/operation&gt;\r\n        &lt;operation error=&quot;skip&quot; info=&quot;OC:1.5.1.3&quot;&gt;\r\n            &lt;search position=&quot;replace&quot;&gt;&lt;![CDATA[\r\n            $template-&gt;data[''image''] = ''cid:'' . md5(basename($voucher_theme_info[''image''])); ]]&gt;&lt;/search&gt;\r\n            &lt;add&gt;&lt;![CDATA[\r\n            $template-&gt;data[''image''] = HTTP_CATALOG . ''image/'' . $voucher_theme_info[''image'']; ]]&gt;&lt;/add&gt;\r\n        &lt;/operation&gt;\r\n        &lt;operation error=&quot;skip&quot;&gt;\r\n            &lt;search position=&quot;replace&quot;&gt;&lt;![CDATA[\r\n            $mail-&gt;addAttachment(DIR_IMAGE . $voucher_theme_info[''image''], md5(basename($voucher_theme_info[''image'']))); ]]&gt;&lt;/search&gt;\r\n            &lt;add&gt;&lt;/add&gt;\r\n        &lt;/operation&gt;\r\n        &lt;operation&gt;\r\n            &lt;search position=&quot;replace&quot;&gt;&lt;![CDATA[\r\n            $mail-&gt;setHtml($template-&gt;fetch(''mail/voucher.tpl'')); ]]&gt;&lt;/search&gt;\r\n			&lt;add/&gt;\r\n        &lt;/operation&gt;\r\n		&lt;operation&gt;\r\n            &lt;search position=&quot;replace&quot; index=&quot;1&quot;&gt;&lt;![CDATA[\r\n            $mail-&gt;send(); ]]&gt;&lt;/search&gt;\r\n            &lt;add&gt;&lt;![CDATA[\r\n            list($width, $height) = getimagesize(DIR_IMAGE . $voucher_theme_info[''image'']);\r\n           	$template-&gt;data[''image_width''] = $width;\r\n           	$template-&gt;data[''image_height''] = $height;\r\n			\r\n			$template-&gt;load(array(\r\n				''key'' =&gt; ''admin.voucher'',\r\n				''store_id'' =&gt; $order_info[''store_id''],\r\n				''language_id'' =&gt; $order_info[''language_id'']\r\n			));\r\n\r\n			$mail = $template-&gt;hook($mail); \r\n\r\n			$mail-&gt;send();\r\n\r\n			$template-&gt;sent(); ]]&gt;&lt;/add&gt;\r\n        &lt;/operation&gt;\r\n	&lt;/file&gt;' 
 WHERE `emailtemplate_default` = 1 AND `emailtemplate_key` = 'admin.voucher';
 
UPDATE `{$p}emailtemplate`  
   SET `emailtemplate_vqmod` = '&lt;file name=&quot;admin/model/sale/customer.php&quot;&gt;\r\n	&lt;operation&gt;\r\n		&lt;search position=&quot;before&quot; index=&quot;1&quot;&gt;&lt;![CDATA[\r\n			$this-&gt;language-&gt;get(''text_approve_welcome'') ]]&gt;&lt;/search&gt;\r\n		&lt;add&gt;&lt;![CDATA[\r\n 		if ($store_info) {\r\n			$store_url = ($this-&gt;config-&gt;get(''config_secure'') ? $store_info[''ssl''] : $store_info[''url'']);\r\n			$account_login = ($this-&gt;config-&gt;get(''config_secure'') ? $store_info[''ssl''] : $store_info[''url'']) . ''index.php?route=account/login'';\r\n		} else {\r\n			$store_url = ($this-&gt;config-&gt;get(''config_secure'') ? HTTPS_CATALOG : HTTP_CATALOG);\r\n			$account_login = ($this-&gt;config-&gt;get(''config_secure'') ? HTTPS_CATALOG : HTTP_CATALOG) . ''index.php?route=account/login'';\r\n		}\r\n		]]&gt;&lt;/add&gt;\r\n	&lt;/operation&gt;		\r\n	&lt;operation&gt;\r\n		&lt;search position=&quot;replace&quot;&gt;&lt;![CDATA[\r\n            $message .= $store_url . &quot;\\n\\n&quot;; ]]&gt;&lt;/search&gt;\r\n		&lt;add&gt;&lt;![CDATA[\r\n           	$message .= $account_login . &quot;\\n\\n&quot;; ]]&gt;&lt;/add&gt;\r\n	&lt;/operation&gt;\r\n	&lt;operation&gt;\r\n		&lt;search position=&quot;after&quot; index=&quot;1&quot;&gt;&lt;![CDATA[\r\n            $this-&gt;language-&gt;get(''text_approve_subject'') ]]&gt;&lt;/search&gt;\r\n		&lt;add&gt;&lt;![CDATA[                        \r\n            $template = new EmailTemplate($this-&gt;request, $this-&gt;registry);\r\n		\r\n			$template-&gt;addData($customer_info, ''customer'');\r\n			            \r\n			$template-&gt;data[''text_welcome''] = sprintf($this-&gt;language-&gt;get(''text_approve_welcome''), $store_name);\r\n\r\n			$template-&gt;data[''account_login''] = $account_login;\r\n			$template-&gt;data[''account_login_tracking''] = $template-&gt;getTracking($account_login); ]]&gt;&lt;/add&gt;\r\n        &lt;/operation&gt;\r\n		&lt;operation&gt;\r\n            &lt;search position=&quot;replace&quot; index=&quot;1&quot;&gt;&lt;![CDATA[\r\n            $mail-&gt;send(); ]]&gt;&lt;/search&gt;\r\n            &lt;add&gt;&lt;![CDATA[            $template_data = array(''key'' =&gt;''admin.customer_approve'');\r\n			if(isset($customer_info[''store_id''])){\r\n				$template_data[''store_id''] = $customer_info[''store_id''];\r\n			}\r\n			if(isset($customer_info[''language_id''])){\r\n				$template_data[''language_id''] = $customer_info[''language_id''];\r\n			}\r\n\r\n            $template-&gt;load($template_data);\r\n			\r\n			$mail = $template-&gt;hook($mail); \r\n\r\n			$mail-&gt;send();\r\n\r\n			$template-&gt;sent(); ]]&gt;&lt;/add&gt;\r\n        &lt;/operation&gt;\r\n&lt;/file&gt;' 
 WHERE `emailtemplate_default` = 1 AND `emailtemplate_key` = 'admin.customer_approve';
 
UPDATE `{$p}emailtemplate`  
   SET `emailtemplate_vqmod` = '&lt;file name=&quot;admin/model/sale/customer.php&quot;&gt;\r\n	&lt;operation info=&quot;method:addTransaction&quot;&gt;\r\n		&lt;search position=&quot;after&quot; index=&quot;1&quot;&gt;&lt;![CDATA[\r\n            $this-&gt;language-&gt;get(''text_transaction_subject'') ]]&gt;&lt;/search&gt;\r\n		&lt;add&gt;&lt;![CDATA[\r\n            $template = new EmailTemplate($this-&gt;request, $this-&gt;registry);\r\n		\r\n			$template-&gt;addData(''amount'', $amount);\r\n			$template-&gt;addData(''description'', $description);\r\n\r\n			$template-&gt;addData($customer_info, ''customer'');\r\n\r\n			if($order_id){\r\n				$this-&gt;load-&gt;model(''sale/order'');		\r\n				$order_info = $this-&gt;model_sale_order-&gt;getOrder($order_id);\r\n\r\n				$template-&gt;addData($order_info, ''order'');\r\n			}\r\n			\r\n			$template-&gt;data[''transaction_received''] = sprintf($this-&gt;language-&gt;get(''text_transaction_received''), $this-&gt;currency-&gt;format($amount, $this-&gt;config-&gt;get(''config_currency'')));\r\n			$template-&gt;data[''transaction_total''] = sprintf($this-&gt;language-&gt;get(''text_transaction_total''), $this-&gt;currency-&gt;format($this-&gt;getTransactionTotal($customer_id))); ]]&gt;&lt;/add&gt;\r\n	&lt;/operation&gt;\r\n	&lt;operation info=&quot;method:addTransaction&quot;&gt;\r\n		&lt;search position=&quot;replace&quot; index=&quot;2&quot;&gt;&lt;![CDATA[\r\n            $mail-&gt;send(); ]]&gt;&lt;/search&gt;\r\n		&lt;add&gt;&lt;![CDATA[\r\n            $template_data = array(''key'' =&gt;''admin.customer_transaction'');\r\n			if(isset($customer_info[''store_id''])){\r\n				$template_data[''store_id''] = $customer_info[''store_id''];\r\n			}\r\n			if(isset($customer_info[''language_id''])){\r\n				$template_data[''language_id''] = $customer_info[''language_id''];\r\n			}\r\n\r\n            $template-&gt;load($template_data);\r\n\r\n			$mail = $template-&gt;hook($mail); \r\n\r\n			$mail-&gt;send();\r\n\r\n			$template-&gt;sent(); ]]&gt;&lt;/add&gt;\r\n	&lt;/operation&gt;\r\n&lt;/file&gt;' 
 WHERE `emailtemplate_default` = 1 AND `emailtemplate_key` = 'admin.customer_transaction';
 
UPDATE `{$p}emailtemplate`  
   SET `emailtemplate_vqmod` = '&lt;file name=&quot;admin/model/sale/customer.php&quot;&gt;\r\n	&lt;operation info=&quot;method:addReward&quot;&gt;\r\n		&lt;search position=&quot;after&quot; index=&quot;1&quot;&gt;&lt;![CDATA[\r\n            $this-&gt;language-&gt;get(''text_reward_subject'') ]]&gt;&lt;/search&gt;\r\n		&lt;add&gt;&lt;![CDATA[\r\n            $template = new EmailTemplate($this-&gt;request, $this-&gt;registry);\r\n            		\r\n			$template-&gt;addData($customer_info, ''customer'');\r\n			\r\n			$template-&gt;data[''reward_received''] = sprintf($this-&gt;language-&gt;get(''text_reward_received''), $points);\r\n			$template-&gt;data[''reward_total''] = sprintf($this-&gt;language-&gt;get(''text_reward_total''), $this-&gt;getRewardTotal($customer_id));]]&gt;&lt;/add&gt;\r\n	&lt;/operation&gt;\r\n	&lt;operation info=&quot;method:addReward&quot;&gt;\r\n		&lt;search position=&quot;replace&quot; index=&quot;3&quot;&gt;&lt;![CDATA[\r\n            $mail-&gt;send(); ]]&gt;&lt;/search&gt;\r\n		&lt;add&gt;&lt;![CDATA[            $template_data = array(''key'' =&gt;''admin.customer_reward'');\r\n			if(isset($customer_info[''store_id''])){\r\n				$template_data[''store_id''] = $customer_info[''store_id''];\r\n			}\r\n			if(isset($customer_info[''language_id''])){\r\n				$template_data[''language_id''] = $customer_info[''language_id''];\r\n			}\r\n\r\n            $template-&gt;load($template_data);\r\n			\r\n			$mail = $template-&gt;hook($mail); \r\n\r\n			$mail-&gt;send();\r\n			\r\n			$template-&gt;sent(); ]]&gt;&lt;/add&gt;\r\n	&lt;/operation&gt;\r\n&lt;/file&gt;' 
 WHERE `emailtemplate_default` = 1 AND `emailtemplate_key` = 'admin.customer_reward';
 
UPDATE `{$p}emailtemplate`  
   SET `emailtemplate_vqmod` = '&lt;file name=&quot;admin/controller/sale/return.php&quot;&gt;\r\n	&lt;operation&gt;\r\n		&lt;search position=&quot;after&quot;&gt;&lt;![CDATA[\r\n            $this-&gt;data[''entry_notify''] = $this-&gt;language-&gt;get(''entry_notify''); ]]&gt;&lt;/search&gt;\r\n		&lt;add&gt;&lt;![CDATA[\r\n            $this-&gt;data[''entry_summary''] = $this-&gt;language-&gt;get(''entry_summary'');\r\n            $this-&gt;data[''entry_show_summary''] = $this-&gt;language-&gt;get(''entry_show_summary'');\r\n			$this-&gt;data[''entry_template''] = $this-&gt;language-&gt;get(''entry_template'');\r\n			$this-&gt;data[''text_select''] = $this-&gt;language-&gt;get(''text_select'');\r\n 			$this-&gt;data[''warning_template_content''] = $this-&gt;language-&gt;get(''warning_template_content'');\r\n \r\n			$this-&gt;load-&gt;model(''module/emailtemplate'');\r\n\r\n            $templates = $this-&gt;model_module_emailtemplate-&gt;getTemplates(array(\r\n				''emailtemplate_key'' =&gt; ''admin.order_update''\r\n			));\r\n\r\n			$this-&gt;data[''templates_options''] = array();\r\n\r\n			foreach($templates as $row){\r\n				$label = $row[''emailtemplate_label''];\r\n\r\n				if($row[''emailtemplate_default'']){\r\n					$label = $this-&gt;language-&gt;get(''text_default'') . '' - '' . $label;\r\n				}\r\n\r\n				$this-&gt;data[''templates_options''][] = array(\r\n					''value'' =&gt; $row[''emailtemplate_id''],\r\n					''label'' =&gt; $label\r\n				);\r\n			}\r\n\r\n            $this-&gt;data[''templates_action''] = $this-&gt;url-&gt;link(''module/emailtemplate/fetch_template'', ''output=comment&amp;token=''.$this-&gt;session-&gt;data[''token''], ''SSL''); ]]&gt;&lt;/add&gt;\r\n	&lt;/operation&gt;\r\n	&lt;operation error=&quot;skip&quot;&gt;\r\n		&lt;search position=&quot;replace&quot;&gt;&lt;![CDATA[\r\n            nl2br($result[''comment'']) ]]&gt;&lt;/search&gt;\r\n		&lt;add trim=&quot;true&quot;&gt;&lt;![CDATA[\r\n            (EmailTemplate::isHTML($result[''comment''])) ? html_entity_decode($result[''comment''], ENT_QUOTES, ''UTF-8'') : nl2br($result[''comment''], true) ]]&gt;&lt;/add&gt;\r\n	&lt;/operation&gt;\r\n&lt;/file&gt;\r\n    \r\n&lt;file name=&quot;admin/view/template/sale/return_info.tpl&quot;&gt;\r\n	&lt;operation info=&quot;Add return summary option&quot;&gt;\r\n		&lt;search position=&quot;after&quot;&gt;&lt;![CDATA[\r\n            &lt;td&gt;&lt;input type=&quot;checkbox&quot; name=&quot;notify&quot; value=&quot;1&quot; /&gt;&lt;/td&gt; ]]&gt;&lt;/search&gt;\r\n		&lt;add&gt;&lt;![CDATA[\r\n          &lt;/tr&gt;\r\n          &lt;tr id=&quot;summaryRow&quot; style=&quot;display: none&quot;&gt;\r\n            &lt;td&gt;&lt;?php echo $entry_summary; ?&gt;&lt;/td&gt;\r\n            &lt;td&gt;\r\n           		&lt;label&gt;&lt;input type=&quot;checkbox&quot; name=&quot;show_summary&quot; value=&quot;1&quot; style=&quot;vertical-align: middle;&quot; /&gt; &lt;?php echo $entry_show_summary; ?&gt;&lt;/label&gt;&lt;br /&gt;\r\n 		  &lt;?php if(!empty($templates_options)){ ?&gt;			\r\n		  &lt;/td&gt;\r\n		  &lt;/tr&gt;\r\n          &lt;tr class=&quot;emailOptions&quot; style=&quot;display: none&quot;&gt;\r\n            &lt;td&gt;&lt;?php echo $entry_template; ?&gt;&lt;/td&gt;\r\n            &lt;td&gt;\r\n            	&lt;select id=&quot;field_templates&quot; name=&quot;field_template&quot;&gt;\r\n	 				&lt;option value=''''&gt;&lt;?php echo $text_select; ?&gt;&lt;/option&gt;\r\n	            	&lt;?php foreach($templates_options as $item){ ?&gt;\r\n	            		&lt;option value=&quot;&lt;?php echo $item[''value'']; ?&gt;&quot;&gt;&lt;?php echo $item[''label'']; ?&gt;&lt;/option&gt;\r\n	            	&lt;?php } ?&gt;\r\n            	&lt;/select&gt;\r\n		  &lt;?php } ?&gt;]]&gt;&lt;/add&gt;\r\n	&lt;/operation&gt;\r\n    &lt;operation&gt;\r\n		&lt;search position=&quot;after&quot;&gt;&lt;![CDATA[\r\n            $(''.vtabs a'').tabs(); ]]&gt;&lt;/search&gt;\r\n		&lt;add&gt;&lt;![CDATA[//--&gt;&lt;/script&gt; 			\r\n            &lt;script type=&quot;text/javascript&quot; src=&quot;view/javascript/ckeditor/ckeditor.js&quot;&gt;&lt;/script&gt;\r\n			&lt;script type=&quot;text/javascript&quot;&gt;&lt;!--\r\n			// Order history show/hide summary options\r\n			(function($){\r\n				function showEmailOptions($row, $checkbox){\r\n					if($checkbox.is('':checked'')) { \r\n						$row.show(); \r\n					} else { \r\n						$row.hide(); \r\n					}\r\n				}	\r\n   \r\n				$(document).ready(function() {\r\n					$(''input[name=notify]'').eq(0).each(function(){\r\n						showEmailOptions($(''.emailOptions''), $(this));\r\n					}).change(function(){\r\n						showEmailOptions($(''.emailOptions''), $(this));\r\n					});\r\n\r\n					$(''select#field_templates'').change(function(){			\r\n						var val = $(this).val();\r\n						if (!val || !confirm(&quot;&lt;?php echo $warning_template_content; ?&gt;&quot;)) return;\r\n						$.ajax({\r\n							url: ''&lt;?php echo html_entity_decode($templates_action); ?&gt;'',\r\n							type: ''get'',\r\n							data: ''id='' + val + ''&amp;store_id=&lt;?php echo $store_id; ?&gt;'' + ''&amp;language_id=&lt;?php echo $language_id; ?&gt;'' + ''&amp;order_id=&lt;?php echo $order_id; ?&gt;'',\r\n							dataType: ''html'',\r\n							success: function(html) {\r\n								$(''textarea[name=comment]'').val(html);\r\n\r\n								if(typeof CKEDITOR !== &quot;undefined&quot;)\r\n									CKEDITOR.instances[''comment''].setData(html);\r\n							},\r\n							error: function(xhr, ajaxOptions, thrownError) {\r\n								console.log(thrownError + &quot;\\r\\n&quot; + xhr.statusText + &quot;\\r\\n&quot; + xhr.responseText);\r\n								alert(''Error. More details in console.'');\r\n							}\r\n						});	\r\n					});\r\n				});	\r\n			})(jQuery);		\r\n			\r\n			if(typeof CKEDITOR !== &quot;undefined&quot;){\r\n				CKEDITOR.replace(''comment'', {\r\n					filebrowserImageBrowseUrl: ''index.php?route=common/filemanager&amp;token=&lt;?php echo $token; ?&gt;'',\r\n					filebrowserUploadUrl: ''index.php?route=common/filemanager&amp;token=&lt;?php echo $token; ?&gt;'',\r\n					filebrowserImageUploadUrl: ''index.php?route=common/filemanager&amp;token=&lt;?php echo $token; ?&gt;''\r\n				}); \r\n\r\n				// Output dimensions of images as width and height\r\n				CKEDITOR.on(''instanceReady'', function (ev) {\r\n					ev.editor.dataProcessor.htmlFilter.addRules({\r\n						elements: {\r\n							$: function(element){                \r\n								if (element.name == ''img'') {\r\n									var style = element.attributes.style;\r\n\r\n									if (style) {\r\n										// Get the width from the style.\r\n										var match = /(?:^|\\s)width\\s*:\\s*(\\d+)px/i.exec(style),\r\n											width = match &amp;&amp; match[1];\r\n\r\n										// Get the height from the style.\r\n										match = /(?:^|\\s)height\\s*:\\s*(\\d+)px/i.exec(style);\r\n										var height = match &amp;&amp; match[1];\r\n\r\n										if (width) {\r\n											element.attributes.style = element.attributes.style.replace(/(?:^|\\s)width\\s*:\\s*(\\d+)px;?/i, '''');\r\n											element.attributes.width = width;\r\n										}\r\n\r\n										if (height) {\r\n											element.attributes.style = element.attributes.style.replace(/(?:^|\\s)height\\s*:\\s*(\\d+)px;?/i, '''');\r\n											element.attributes.height = height;\r\n										}\r\n									}\r\n								}\r\n\r\n								if (!element.attributes.style) delete element.attributes.style;\r\n\r\n								return element;\r\n							}\r\n						}\r\n					});\r\n				}); \r\n			} ]]&gt;&lt;/add&gt;\r\n	&lt;/operation&gt;\r\n	&lt;operation&gt;\r\n		&lt;search position=&quot;after&quot;&gt;&lt;![CDATA[\r\n            function history() { ]]&gt;&lt;/search&gt;\r\n		&lt;add&gt;&lt;![CDATA[\r\n            // Force CKEDITOR instance in the form to update their respective fields\r\n            if(typeof CKEDITOR !== &quot;undefined&quot;)\r\n				CKEDITOR.instances.comment.updateElement(); ]]&gt;&lt;/add&gt;\r\n	&lt;/operation&gt;\r\n	&lt;operation error=&quot;skip&quot;&gt;\r\n		&lt;search position=&quot;before&quot;&gt;&lt;![CDATA[\r\n            $(''textarea[name=\\''comment\\'']'').val(''''); ]]&gt;&lt;/search&gt;\r\n		&lt;add&gt;&lt;![CDATA[\r\n            // Clear CKEDITOR data\r\n			if(typeof CKEDITOR !== &quot;undefined&quot;)\r\n            	CKEDITOR.instances.comment.setData(''''); ]]&gt;&lt;/add&gt;\r\n	&lt;/operation&gt;\r\n    &lt;operation info=&quot;Add checkboxes into ajax post data&quot;&gt;\r\n		&lt;search position=&quot;replace&quot;&gt;&lt;![CDATA[\r\n            + ''&amp;notify='' ]]&gt;&lt;/search&gt;\r\n		&lt;add trim=&quot;true&quot;&gt;&lt;![CDATA[\r\n            + ''&amp;show_summary='' + encodeURIComponent($(''input[name=\\''show_summary\\'']'').attr(''checked'') ? 1 : 0) \r\n			+ ($(''select[name=\\''field_template\\'']'').val() ? ''&amp;field_template='' + $(''select[name=\\''field_template\\'']'').val() : '''')\r\n			+ ''&amp;notify='' ]]&gt;&lt;/add&gt;\r\n	&lt;/operation&gt;\r\n&lt;/file&gt;\r\n\r\n&lt;file name=&quot;admin/model/sale/return.php&quot;&gt;\r\n	&lt;operation&gt;\r\n		&lt;search position=&quot;after&quot; index=&quot;1&quot;&gt;&lt;![CDATA[\r\n            if ($return_query-&gt;num_rows) { ]]&gt;&lt;/search&gt;\r\n		&lt;add&gt;&lt;![CDATA[            \r\n			$this-&gt;load-&gt;model(''localisation/return_reason'');\r\n			$return_reason_info = $this-&gt;model_localisation_return_reason-&gt;getReturnReason($return_query-&gt;row[''return_reason_id'']); ]]&gt;&lt;/add&gt;\r\n	&lt;/operation&gt;\r\n	&lt;operation&gt;\r\n		&lt;search position=&quot;after&quot;&gt;&lt;![CDATA[\r\n            $message .= $this-&gt;language-&gt;get(''text_footer''); ]]&gt;&lt;/search&gt;\r\n		&lt;add&gt;&lt;![CDATA[            \r\n			$this-&gt;load-&gt;model(''sale/order'');\r\n			$order_info = $this-&gt;model_sale_order-&gt;getOrder($return_query-&gt;row[''order_id'']);\r\n			$store_id = $order_info[''store_id''];\r\n			\r\n			$template = new EmailTemplate($this-&gt;request, $this-&gt;registry);\r\n									\r\n			$template-&gt;addData($return_query-&gt;row);\r\n			$template-&gt;addData($data);\r\n			$template-&gt;addData($order_info, ''order'');\r\n\r\n			$template-&gt;data[''return_id''] = $return_id;\r\n			$template-&gt;data[''date_added''] = date($this-&gt;language-&gt;get(''date_format_short''), strtotime($return_query-&gt;row[''date_added'']));\r\n			$template-&gt;data[''status''] = $return_query-&gt;row[''status''];\r\n			$template-&gt;data[''comment''] = (isset($data[''comment''])) ? (strcmp($data[''comment''], strip_tags($html_str = html_entity_decode($data[''comment''], ENT_QUOTES, ''UTF-8''))) == 0) ? nl2br($data[''comment'']) : $html_str : '''';\r\n			$template-&gt;data[''reason''] = ($return_reason_info) ? $return_reason_info[''name''] : '''';\r\n			$template-&gt;data[''opened''] = $return_query-&gt;row[''opened''] ? $this-&gt;language-&gt;get(''text_yes'') : $this-&gt;language-&gt;get(''text_no'');\r\n			$template-&gt;data[''show_summary''] = isset($data[''show_summary'']) ? $data[''show_summary''] : 0; ]]&gt;&lt;/add&gt;\r\n	&lt;/operation&gt;\r\n	&lt;operation&gt;\r\n		&lt;search position=&quot;replace&quot; index=&quot;1&quot;&gt;&lt;![CDATA[\r\n            $mail-&gt;send(); ]]&gt;&lt;/search&gt;\r\n		&lt;add&gt;&lt;![CDATA[\r\n            $template_data = array(''key'' =&gt; ''admin.return_history'');\r\n			if(isset($order_info[''store_id''])){\r\n				$template_data[''store_id''] = $order_info[''store_id''];\r\n			}\r\n			if(isset($order_info[''language_id''])){\r\n				$template_data[''language_id''] = $order_info[''language_id''];\r\n			}\r\n\r\n            $template-&gt;load($template_data);\r\n		\r\n			$mail = $template-&gt;hook($mail);\r\n \r\n			$mail-&gt;send(); \r\n\r\n			$template-&gt;sent(); ]]&gt;&lt;/add&gt;\r\n	&lt;/operation&gt;\r\n	&lt;operation error=&quot;skip&quot;&gt;\r\n		&lt;search position=&quot;replace&quot;&gt;&lt;![CDATA[\r\n            comment = ''&quot; . $this-&gt;db-&gt;escape(strip_tags($data[''comment''])) . &quot;'' ]]&gt;&lt;/search&gt;\r\n		&lt;add trim=&quot;true&quot;&gt;&lt;![CDATA[\r\n            comment = ''&quot; . $this-&gt;db-&gt;escape($data[''comment'']) . &quot;'' ]]&gt;&lt;/add&gt;\r\n	&lt;/operation&gt;\r\n&lt;/file&gt;' 
 WHERE `emailtemplate_default` = 1 AND `emailtemplate_key` = 'admin.return_history';
 
UPDATE `{$p}emailtemplate`  
   SET `emailtemplate_vqmod` = '&lt;file name=&quot;admin/model/sale/affiliate.php&quot;&gt;\r\n	&lt;operation&gt;\r\n		&lt;search position=&quot;before&quot;&gt;&lt;![CDATA[\r\n            $message .= $this-&gt;config-&gt;get(''config_name''); ]]&gt;&lt;/search&gt;\r\n		&lt;add&gt;&lt;![CDATA[\r\n            $template = new EmailTemplate($this-&gt;request, $this-&gt;registry);\r\n            \r\n			$template-&gt;addData($affiliate_info);                       \r\n			$template-&gt;data[''text_welcome''] = sprintf($this-&gt;language-&gt;get(''text_approve_welcome''), $this-&gt;config-&gt;get(''config_name''));\r\n			$template-&gt;data[''affiliate_login''] = HTTP_CATALOG . ''index.php?route=affiliate/login'';\r\n			$template-&gt;data[''affiliate_login_tracking''] =  $template-&gt;getTracking($template-&gt;data[''affiliate_login'']);]]&gt;&lt;/add&gt;\r\n	&lt;/operation&gt;\r\n	&lt;operation&gt;\r\n		&lt;search position=&quot;replace&quot; index=&quot;1&quot;&gt;&lt;![CDATA[\r\n            $mail-&gt;send(); ]]&gt;&lt;/search&gt;\r\n		&lt;add&gt;&lt;![CDATA[            $template-&gt;load(array(\r\n				''key'' =&gt; ''admin.affiliate_approve''\r\n			));\r\n			\r\n			$mail = $template-&gt;hook($mail);\r\n\r\n 			$mail-&gt;send();\r\n\r\n			$template-&gt;sent(); ]]&gt;&lt;/add&gt;\r\n        &lt;/operation&gt;\r\n	&lt;/file&gt;' 
 WHERE `emailtemplate_default` = 1 AND `emailtemplate_key` = 'admin.affiliate_approve';
 
UPDATE `{$p}emailtemplate`  
   SET `emailtemplate_vqmod` = '&lt;file name=&quot;admin/model/sale/affiliate.php&quot;&gt;\r\n	&lt;operation&gt;\r\n		&lt;search position=&quot;after&quot; index=&quot;1&quot;&gt;&lt;![CDATA[\r\n			$this-&gt;language-&gt;get(''text_transaction_subject'') ]]&gt;&lt;/search&gt;\r\n		&lt;add&gt;&lt;![CDATA[\r\n            $template = new EmailTemplate($this-&gt;request, $this-&gt;registry);\r\n                        \r\n			$template-&gt;data[''text_received''] = sprintf($this-&gt;language-&gt;get(''text_transaction_received''), $this-&gt;currency-&gt;format($amount, $this-&gt;config-&gt;get(''config_currency'')));\r\n			$template-&gt;data[''text_total''] = sprintf($this-&gt;language-&gt;get(''text_transaction_total''), $this-&gt;currency-&gt;format($this-&gt;getTransactionTotal($affiliate_id), $this-&gt;config-&gt;get(''config_currency''))); ]]&gt;&lt;/add&gt;\r\n	&lt;/operation&gt;\r\n	&lt;operation&gt;\r\n		&lt;search position=&quot;replace&quot; index=&quot;2&quot;&gt;&lt;![CDATA[\r\n            $mail-&gt;send(); ]]&gt;&lt;/search&gt;\r\n		&lt;add&gt;&lt;![CDATA[            $template-&gt;load(''admin.affiliate_transaction'');\r\n			$mail = $template-&gt;hook($mail);\r\n 			$mail-&gt;send();\r\n			$template-&gt;sent(); ]]&gt;&lt;/add&gt;\r\n	&lt;/operation&gt;\r\n&lt;/file&gt;' 
 WHERE `emailtemplate_default` = 1 AND `emailtemplate_key` = 'admin.affiliate_transaction';
 
UPDATE `{$p}emailtemplate`  
   SET `emailtemplate_vqmod` = '&lt;file name=&quot;admin/view/template/sale/customer_form.tpl&quot;&gt;\r\n	&lt;operation&gt;\r\n		&lt;search position=&quot;before&quot; index=&quot;1&quot;&gt;&lt;![CDATA[\r\n           &lt;td&gt;&lt;?php echo $entry_status; ?&gt;&lt;/td&gt; ]]&gt;&lt;/search&gt;\r\n		&lt;add&gt;&lt;![CDATA[					\r\n                &lt;td&gt;&lt;?php echo $entry_notify; ?&gt;&lt;/td&gt;\r\n                &lt;td&gt;\r\n                    &lt;input type=&quot;checkbox&quot; name=&quot;notify&quot; value=&quot;1&quot;&lt;?php if ($notify) { ?&gt; selected=&quot;selected&quot; &lt;?php } ?&gt; /&gt;\r\n				&lt;/td&gt;\r\n            &lt;/tr&gt;\r\n			&lt;tr&gt;]]&gt;&lt;/add&gt;\r\n	&lt;/operation&gt;\r\n&lt;/file&gt;\r\n\r\n&lt;file name=&quot;admin/controller/sale/customer.php&quot;&gt;\r\n	&lt;operation&gt;\r\n		&lt;search position=&quot;before&quot; index=&quot;1&quot;&gt;&lt;![CDATA[\r\n           if (isset($this-&gt;request-&gt;post[''password''])) {  ]]&gt;&lt;/search&gt;\r\n		&lt;add&gt;&lt;![CDATA[\r\n		$this-&gt;data[''entry_notify''] = $this-&gt;language-&gt;get(''entry_notify'');\r\n\r\n        if (isset($this-&gt;request-&gt;post[''notify''])) { \r\n			$this-&gt;data[''notify''] = 1;\r\n		} else {\r\n			$this-&gt;data[''notify''] = 0;\r\n		}; ]]&gt;&lt;/add&gt;\r\n	&lt;/operation&gt;\r\n&lt;/file&gt;\r\n\r\n&lt;file name=&quot;admin/model/sale/customer.php&quot;&gt;\r\n	&lt;operation&gt;\r\n		&lt;search position=&quot;after&quot; index=&quot;1&quot; offset=&quot;3&quot;&gt;&lt;![CDATA[\r\n            $this-&gt;db-&gt;query(&quot;UPDATE &quot; . DB_PREFIX . &quot;customer SET address_id = '' ]]&gt;&lt;/search&gt;\r\n		&lt;add&gt;&lt;![CDATA[\r\n		if(isset($data[''notify''])){\r\n			$template = new EmailTemplate($this-&gt;request, $this-&gt;registry);\r\n			\r\n			$template-&gt;addData($data);\r\n\r\n			$template-&gt;data[''newsletter''] = $this-&gt;language-&gt;get((isset($data[''newsletter'']) &amp;&amp; $data[''newsletter''] == 1) ? ''text_yes'' : ''text_no'');\r\n\r\n			$template-&gt;data[''account_login''] = $this-&gt;url-&gt;link(''account/login'', ''email='' . $data[''email''], ''SSL'');\r\n			$template-&gt;data[''account_login_tracking''] = $template-&gt;getTracking($template-&gt;data[''account_login'']);\r\n\r\n			if(isset($data[''customer_group_id'']) &amp;&amp; $data[''customer_group_id'']){\r\n				$this-&gt;load-&gt;model(''sale/customer_group'');		\r\n				$customer_group_info = $this-&gt;model_sale_customer_group-&gt;getCustomerGroup($data[''customer_group_id'']);\r\n				$template-&gt;data[''customer_group''] = $customer_group_info[''name''];\r\n			}\r\n\r\n			if(isset($address_id)){\r\n				$address =  $this-&gt;getAddress($address_id);\r\n				$template-&gt;data[''address''] = EmailTemplate::FormatAddress($address, '''', $address[''address_format'']);\r\n			}\r\n\r\n			$template-&gt;load(''admin.customer_create'');\r\n\r\n			$template-&gt;send(); \r\n  		} // notify ]]&gt;&lt;/add&gt;\r\n	&lt;/operation&gt;\r\n&lt;/file&gt;' 
 WHERE `emailtemplate_default` = 1 AND `emailtemplate_key` = 'admin.customer_create';