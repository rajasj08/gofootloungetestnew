UPDATE `{$p}emailtemplate`  
   SET `emailtemplate_vqmod` = '&lt;file name=&quot;catalog/model/checkout/order.php&quot;&gt;\r\n	&lt;operation&gt;\r\n		&lt;search position=&quot;after&quot;&gt;&lt;![CDATA[ \r\n			''customer_id''             =&gt; $order_query-&gt;row[''customer_id''], ]]&gt;&lt;/search&gt;\r\n		&lt;ignoreif&gt;&lt;![CDATA[ \r\n			''customer_group_id'' =&gt; ]]&gt;&lt;/ignoreif&gt;\r\n		&lt;add&gt;&lt;![CDATA[				''customer_group_id'' =&gt; (isset($order_query-&gt;row[''customer_group_id''])) ? $order_query-&gt;row[''customer_group_id''] : '''',\r\n				''affiliate_id'' =&gt; (isset($order_query-&gt;row[''affiliate_id''])) ? $order_query-&gt;row[''affiliate_id''] : '''',]]&gt;&lt;/add&gt;\r\n	&lt;/operation&gt;\r\n	&lt;operation&gt;\r\n		&lt;search position=&quot;replace&quot;&gt;&lt;![CDATA[\r\n			$order_product_query = $this-&gt;db-&gt;query(&quot;SELECT * FROM &quot; . DB_PREFIX . &quot;order_product WHERE order_id = ''&quot; . (int)$order_id . &quot;''&quot;);]]&gt;&lt;/search&gt;\r\n		&lt;add&gt;&lt;![CDATA[\r\n            $this-&gt;load-&gt;model(''tool/image'');\r\n\r\n			$template = new EmailTemplate($this-&gt;request, $this-&gt;registry);\r\n						\r\n			$sql = &quot;SELECT op.*, p.image, p.sku, p.quantity AS stock_quantity\r\n				    FROM &quot; . DB_PREFIX . &quot;order_product op\r\n					LEFT JOIN &quot; . DB_PREFIX . &quot;product p ON (p.product_id = op.product_id)\r\n					WHERE order_id = ''&quot; . (int)$order_id . &quot;''&quot;;\r\n            $order_product_query = $this-&gt;db-&gt;query($sql);\r\n\r\n            // Load Customer Group - check file exists for old versions of opencart\r\n            if(isset($order_info[''customer_group_id'']) &amp;&amp; $order_info[''customer_group_id''] &amp;&amp; file_exists(DIR_APPLICATION . ''model/account/customer_group.php'')){\r\n            	$this-&gt;load-&gt;model(''account/customer_group'');\r\n				$customer_group_info = $this-&gt;model_account_customer_group-&gt;getCustomerGroup($order_info[''customer_group_id'']);\r\n            }\r\n\r\n            // Load affiliate data into email\r\n            if(isset($order_info[''affiliate_id'']) &amp;&amp; $order_info[''affiliate_id'']){\r\n            	$this-&gt;load-&gt;model(''affiliate/affiliate'');\r\n				$affiliate_info = $this-&gt;model_affiliate_affiliate-&gt;getAffiliate($order_info[''affiliate_id'']);\r\n            }]]&gt;&lt;/add&gt;\r\n	&lt;/operation&gt;\r\n	&lt;operation&gt;\r\n		&lt;search position=&quot;replace&quot; index=&quot;1&quot;&gt;&lt;![CDATA[ $template = new Template(); ]]&gt;&lt;/search&gt;\r\n		&lt;add&gt;&lt;![CDATA[			\r\n			$template-&gt;addData($order_info);\r\n\r\n			$template-&gt;data[''affiliate''] = (isset($affiliate_info)) ? $affiliate_info : '''';\r\n			$template-&gt;data[''customer_group''] = (isset($customer_group_info[''name''])) ? $customer_group_info[''name''] : '''';\r\n			$template-&gt;data[''new_order_status''] = $order_status;]]&gt;&lt;/add&gt;\r\n	&lt;/operation&gt;\r\n	&lt;operation&gt;\r\n		&lt;search position=&quot;after&quot; index=&quot;1&quot;&gt;&lt;![CDATA[ $template-&gt;data[''link''] = ]]&gt;&lt;/search&gt;\r\n		&lt;add&gt;&lt;![CDATA[			$template-&gt;data[''link_tracking''] = $template-&gt;getTracking($template-&gt;data[''link'']); ]]&gt;&lt;/add&gt;\r\n	&lt;/operation&gt;\r\n	&lt;operation&gt;\r\n		&lt;search position=&quot;after&quot; index=&quot;1&quot;&gt;&lt;![CDATA[ $template-&gt;data[''download''] = ]]&gt;&lt;/search&gt;\r\n		&lt;add&gt;&lt;![CDATA[			$template-&gt;data[''download_tracking''] = $template-&gt;getTracking($template-&gt;data[''download'']); ]]&gt;&lt;/add&gt;\r\n	&lt;/operation&gt;\r\n	&lt;operation&gt;\r\n		&lt;search position=&quot;replace&quot; index=&quot;1&quot;&gt;&lt;![CDATA[\r\n			$template-&gt;data[''products''][] = array( ]]&gt;&lt;/search&gt;\r\n		&lt;add&gt;&lt;![CDATA[if (isset($product[''image''])) {\r\n					$image = $this-&gt;model_tool_image-&gt;resize($product[''image''], 50, 50);\r\n				} else {\r\n					$image = '''';\r\n				}\r\n\r\n				$url = $this-&gt;url-&gt;link(''product/product'', ''product_id=''.$product[''product_id''], ''SSL'');\r\n\r\n				$template-&gt;data[''products''][] = array(\r\n					''url''     		=&gt; $url,\r\n					''url_tracking'' 	=&gt; $template-&gt;getTracking($url),\r\n					''image''     	=&gt; $image,\r\n					''order_product_id'' =&gt; $product[''order_product_id''],\r\n					''sku''			=&gt; $product[''sku''],\r\n					''stock_quantity''=&gt; ($product[''stock_quantity''] - $product[''quantity'']),]]&gt;&lt;/add&gt;\r\n	&lt;/operation&gt;\r\n	&lt;operation error=&quot;skip&quot; info=&quot;Remove logo, this gets handled via email template&quot;&gt;\r\n		&lt;search position=&quot;replace&quot; index=&quot;1&quot;&gt;&lt;![CDATA[\r\n			$template-&gt;data[''logo''] = $this-&gt;config-&gt;get(''config_url'') . ''image/'' . $this-&gt;config-&gt;get(''config_logo'');]]&gt;&lt;/search&gt;\r\n		&lt;add/&gt;\r\n	&lt;/operation&gt;\r\n	&lt;operation error=&quot;skip&quot;&gt;\r\n		&lt;search position=&quot;replace&quot; index=&quot;1&quot;&gt;&lt;![CDATA[\r\n			$template-&gt;data[''logo''] = HTTP_IMAGE . $this-&gt;config-&gt;get(''config_logo'');]]&gt;&lt;/search&gt;\r\n		&lt;add/&gt;\r\n	&lt;/operation&gt;\r\n	&lt;operation error=&quot;skip&quot;&gt;\r\n		&lt;search position=&quot;replace&quot; index=&quot;1&quot;&gt;&lt;![CDATA[\r\n			$template-&gt;data[''logo''] = $this-&gt;model_tool_image-&gt;get($this-&gt;config-&gt;get(''config_logo''));]]&gt;&lt;/search&gt;\r\n		&lt;add/&gt;\r\n	&lt;/operation&gt;\r\n	&lt;operation error=&quot;skip&quot; info=&quot;1.5.1.3.1&quot;&gt;\r\n		&lt;search position=&quot;replace&quot; index=&quot;1&quot;&gt;&lt;![CDATA[\r\n			$template-&gt;data[''logo''] = ''cid:'' . md5(basename($this-&gt;config-&gt;get(''config_logo'')));]]&gt;&lt;/search&gt;\r\n		&lt;add/&gt;\r\n	&lt;/operation&gt;\r\n	&lt;operation error=&quot;skip&quot; info=&quot;remove attachedment&quot;&gt;\r\n		&lt;search position=&quot;replace&quot;&gt;&lt;![CDATA[\r\n			$mail-&gt;addAttachment(DIR_IMAGE . $this-&gt;config-&gt;get(''config_logo''), md5(basename($this-&gt;config-&gt;get(''config_logo''))));]]&gt;&lt;/search&gt;\r\n		&lt;add/&gt;\r\n	&lt;/operation&gt;\r\n	&lt;operation error=&quot;skip&quot;&gt;\r\n		&lt;search position=&quot;replace&quot; offset=&quot;4&quot; index=&quot;1&quot;&gt;&lt;![CDATA[\r\n			if ($comment &amp;&amp; $notify) {]]&gt;&lt;/search&gt;\r\n		&lt;add&gt;&lt;![CDATA[\r\n            if ($order_info[''comment'']) {\r\n            	$template-&gt;data[''comment''] = str_replace(array(&quot;\\r\\n&quot;, &quot;\\r&quot;, &quot;\\n&quot;), &quot;&lt;br /&gt;&quot;, $order_info[''comment'']);\r\n            } else {\r\n            	$template-&gt;data[''comment''] = '''';\r\n            }\r\n\r\n            if ($comment &amp;&amp; $notify &amp;&amp; $template-&gt;data[''comment''] != $comment) {\r\n				$template-&gt;data[''instruction''] = str_replace(array(&quot;\\r\\n&quot;, &quot;\\r&quot;, &quot;\\n&quot;), &quot;&lt;br /&gt;&quot;, $comment);\r\n			} else {\r\n				$template-&gt;data[''instruction''] = '''';\r\n			}]]&gt;&lt;/add&gt;\r\n	&lt;/operation&gt;\r\n	&lt;operation info=&quot;offset causing too many issue with linebreaks&quot;&gt;\r\n		&lt;search position=&quot;replace&quot; index=&quot;1&quot;&gt;&lt;![CDATA[\r\n            $html = $template-&gt;fetch($this-&gt;config-&gt;get(''config_template'') . ''/template/mail/order.tpl'');]]&gt;&lt;/search&gt;\r\n		&lt;add/&gt;\r\n	&lt;/operation&gt;\r\n	&lt;operation&gt;\r\n    	&lt;search position=&quot;replace&quot; index=&quot;1&quot;&gt;&lt;![CDATA[\r\n            $html = $template-&gt;fetch(''default/template/mail/order.tpl'');]]&gt;&lt;/search&gt;\r\n		&lt;add/&gt;\r\n	&lt;/operation&gt;\r\n	&lt;operation&gt;\r\n		&lt;search position=&quot;after&quot;&gt;&lt;![CDATA[\r\n            $template-&gt;data[''customer_id''] = $order_info[''customer_id'']; ]]&gt;&lt;/search&gt;\r\n		&lt;add&gt;&lt;![CDATA[\r\n            $template-&gt;data[''customer_name''] = $order_info[''firstname''] . '' '' . $order_info[''lastname''];\r\n            $template-&gt;data[''customer_firstname''] = $order_info[''firstname''];\r\n            $template-&gt;data[''customer_lastname''] = $order_info[''lastname''];]]&gt;&lt;/add&gt;\r\n	&lt;/operation&gt;\r\n	&lt;operation&gt;\r\n		&lt;search position=&quot;replace&quot; index=&quot;1&quot;&gt;&lt;![CDATA[\r\n			$mail-&gt;setHtml($html);]]&gt;&lt;/search&gt;\r\n		&lt;add&gt;&lt;![CDATA[			$template-&gt;load(''order.customer'');\r\n			$mail = $template-&gt;hook($mail); \r\n\r\n			if($template-&gt;data[''emailtemplate''][''attach_invoice''] &amp;&amp; ($this-&gt;config-&gt;get(''config_complete_status_id'') == $order_status_id) &amp;&amp; $order_info &amp;&amp; !$order_info[''invoice_no'']) {\r\n				$query = $this-&gt;db-&gt;query(&quot;SELECT MAX(invoice_no) AS invoice_no FROM `&quot; . DB_PREFIX . &quot;order` WHERE invoice_prefix = ''&quot; . $this-&gt;db-&gt;escape($order_info[''invoice_prefix'']) . &quot;''&quot;);\r\n			\r\n				if ($query-&gt;row[''invoice_no'']) {\r\n					$invoice_no = $query-&gt;row[''invoice_no''] + 1;\r\n				} else {\r\n					$invoice_no = 1;\r\n				}\r\n				\r\n				$this-&gt;db-&gt;query(&quot;UPDATE `&quot; . DB_PREFIX . &quot;order` SET invoice_no = ''&quot; . (int)$invoice_no . &quot;'', invoice_prefix = ''&quot; . $this-&gt;db-&gt;escape($order_info[''invoice_prefix'']) . &quot;'' WHERE order_id = ''&quot; . (int)$order_id . &quot;''&quot;);\r\n					\r\n				$order_info[''invoice_no''] = $invoice_no;\r\n 			}]]&gt;&lt;/add&gt;\r\n	&lt;/operation&gt;\r\n	&lt;operation error=&quot;skip&quot; info=&quot;1.5.5.1&quot;&gt;\r\n        &lt;search position=&quot;replace&quot;&gt;&lt;![CDATA[\r\n            ''value'' =&gt; (strlen($value) &gt; 20 ? substr($value, 0, 20) . ''..'' : $value)]]&gt;&lt;/search&gt;\r\n		&lt;add trim=&quot;true&quot;&gt;&lt;![CDATA[\r\n            ''value'' =&gt; (strlen($value) &gt; 120 ? substr($value, 0, 120) . ''..'' : $value)]]&gt;&lt;/add&gt;\r\n	&lt;/operation&gt;\r\n	&lt;operation error=&quot;skip&quot;&gt;\r\n		&lt;search position=&quot;replace&quot;&gt;&lt;![CDATA[\r\n            ''value'' =&gt; (strlen($value) &gt; 20 ? substr($value, 0, 20) . ''..'' : $value)]]&gt;&lt;/search&gt;\r\n		&lt;add trim=&quot;true&quot;&gt;&lt;![CDATA[\r\n            ''value'' =&gt; (strlen($value) &gt; 120 ? substr($value, 0, 120) . ''..'' : $value)]]&gt;&lt;/add&gt;\r\n	&lt;/operation&gt;\r\n	&lt;operation error=&quot;skip&quot; info=&quot;1.5.1.3&quot;&gt;\r\n		&lt;search position=&quot;replace&quot;&gt;&lt;![CDATA[\r\n            ''value'' =&gt; (strlen($option[''value'']) &gt; 20 ? substr($option[''value''], 0, 20) . ''..'' : $option[''value''])]]&gt;&lt;/search&gt;\r\n		&lt;add trim=&quot;true&quot;&gt;&lt;![CDATA[\r\n            ''value'' =&gt; (strlen($option[''value'']) &gt; 120 ? substr($option[''value''], 0, 120) . ''..'' : $option[''value''])]]&gt;&lt;/add&gt;\r\n	&lt;/operation&gt;\r\n	&lt;operation info=&quot;Add product option price&quot;&gt;\r\n		&lt;search position=&quot;replace&quot; index=&quot;1&quot;&gt;&lt;![CDATA[\r\n            $order_option_query = $this-&gt;db-&gt;query(&quot;SELECT * FROM &quot; . DB_PREFIX . &quot;order_option WHERE order_id = ''&quot; . (int)$order_id . &quot;'' AND order_product_id = ''&quot; . (int)$product[''order_product_id''] . &quot;''&quot;);]]&gt;&lt;/search&gt;\r\n		&lt;add trim=&quot;true&quot;&gt;&lt;![CDATA[\r\n            $order_option_query = $this-&gt;db-&gt;query(&quot;SELECT oo.*, pov.* FROM &quot; . DB_PREFIX . &quot;order_option oo LEFT JOIN &quot; . DB_PREFIX . &quot;product_option_value pov ON (pov.product_option_value_id = oo.product_option_value_id) WHERE oo.order_id = ''&quot; . (int)$order_id . &quot;'' AND oo.order_product_id = ''&quot; . (int)$product[''order_product_id''] . &quot;''&quot;);]]&gt;&lt;/add&gt;\r\n	&lt;/operation&gt;\r\n	&lt;operation info=&quot;Add product option price&quot;&gt;\r\n		&lt;search position=&quot;before&quot; index=&quot;1&quot;&gt;&lt;![CDATA[\r\n            $option_data[] = array(]]&gt;&lt;/search&gt;\r\n		&lt;add&gt;&lt;![CDATA[					$price = false;\r\n					if ((float)$option[''price'']) {\r\n						$price = $this-&gt;currency-&gt;format($option[''price''], $this-&gt;config-&gt;get(''config_currency''));\r\n					}]]&gt;&lt;/add&gt;\r\n	&lt;/operation&gt;\r\n	&lt;operation info=&quot;Add product option price&quot;&gt;\r\n		&lt;search position=&quot;after&quot; index=&quot;1&quot;&gt;&lt;![CDATA[\r\n            ''name''  =&gt; $option[''name''],]]&gt;&lt;/search&gt;\r\n		&lt;add&gt;&lt;![CDATA[						''price''  =&gt; $price,\r\n						''price_prefix''  =&gt; $option[''price_prefix''],]]&gt;&lt;/add&gt;\r\n	&lt;/operation&gt;\r\n&lt;/file&gt;' 
 WHERE `emailtemplate_default` = 1 AND `emailtemplate_key` = 'order.customer';
 
UPDATE `{$p}emailtemplate`  
   SET `emailtemplate_vqmod` = '&lt;file name=&quot;admin/controller/sale/contact.php&quot;&gt;\r\n	&lt;operation&gt; \r\n		&lt;search position=&quot;after&quot;&gt;&lt;![CDATA[\r\n            $this-&gt;data[''entry_message''] = $this-&gt;language-&gt;get(''entry_message''); ]]&gt;&lt;/search&gt;\r\n		&lt;add&gt;&lt;![CDATA[\r\n		$this-&gt;data[''entry_template''] = $this-&gt;language-&gt;get(''entry_template'');\r\n		$this-&gt;data[''entry_campaign_name''] = $this-&gt;language-&gt;get(''entry_campaign_name'');\r\n		$this-&gt;data[''warning_template_content''] = $this-&gt;language-&gt;get(''warning_template_content'');\r\n		$this-&gt;data[''text_select''] = $this-&gt;language-&gt;get(''text_select'');\r\n           \r\n		$this-&gt;load-&gt;model(''localisation/language'');\r\n		$this-&gt;load-&gt;model(''module/emailtemplate'');\r\n\r\n        $templates = $this-&gt;model_module_emailtemplate-&gt;getTemplates(array(\r\n			''emailtemplate_key'' =&gt; ''admin.newsletter''\r\n		));\r\n\r\n		$this-&gt;data[''templates_options''] = array();\r\n\r\n		foreach($templates as $row){\r\n			$label = $row[''emailtemplate_label''];\r\n\r\n			if($row[''emailtemplate_default'']){\r\n				$label = $this-&gt;language-&gt;get(''text_default'') . '' - '' . $label;\r\n			}\r\n\r\n			$this-&gt;data[''templates_options''][] = array(\r\n				''value'' =&gt; $row[''emailtemplate_id''],\r\n				''label'' =&gt; $label\r\n			);\r\n		}\r\n\r\n		$this-&gt;data[''languages''] = $this-&gt;model_localisation_language-&gt;getLanguages();		\r\n\r\n		$config = $this-&gt;model_module_emailtemplate-&gt;getConfig(1, true, true);\r\n        $this-&gt;data[''campaign_name''] = $config[''tracking_campaign_name''];    \r\n		 \r\n        $this-&gt;data[''templates_action''] = $this-&gt;url-&gt;link(''module/emailtemplate/get_template'', ''parses=0&amp;token=''.$this-&gt;session-&gt;data[''token''], ''SSL''); ]]&gt;&lt;/add&gt;\r\n	&lt;/operation&gt;\r\n	\r\n	&lt;operation info=&quot;Add extra info into email array&quot;&gt;\r\n		&lt;search position=&quot;replace&quot;&gt;&lt;![CDATA[\r\n			$emails[] = $customer_info[''email'']; ]]&gt;&lt;/search&gt;\r\n		&lt;add&gt;&lt;![CDATA[ $emails[] = array(\r\n				   						''customer'' =&gt; $customer_info,\r\n				   						''email'' =&gt; $customer_info[''email''],\r\n				   						''customer_id'' =&gt; $customer_info[''customer_id''],\r\n				   						''store_id'' =&gt; $customer_info[''store_id''],\r\n				   						''language_id'' =&gt; $customer_info[''language_id'']\r\n				  					); ]]&gt;&lt;/add&gt;\r\n	&lt;/operation&gt;\r\n	&lt;operation info=&quot;Add extra info into email array&quot;&gt;\r\n		&lt;search position=&quot;replace&quot;&gt;&lt;![CDATA[\r\n			$emails[$result[''customer_id'']] = $result[''email'']; ]]&gt;&lt;/search&gt;\r\n		&lt;add&gt;&lt;![CDATA[ $emails[$result[''customer_id'']] = array(\r\n				 				''email'' =&gt; $result[''email''],\r\n				 				''customer_id'' =&gt; $result[''customer_id''],\r\n				 				''store_id'' =&gt; $result[''store_id''],\r\n				 				''language_id'' =&gt; $result[''language_id'']\r\n							); ]]&gt;&lt;/add&gt;\r\n	&lt;/operation&gt;\r\n	&lt;operation info=&quot;affiliate_all&quot;&gt;\r\n		&lt;search position=&quot;replace&quot; index=&quot;3&quot;&gt;&lt;![CDATA[\r\n			$emails[] = $result[''email'']; ]]&gt;&lt;/search&gt;\r\n		&lt;add&gt;&lt;![CDATA[ $emails[$result[''affiliate_id'']] = array(\r\n				 				''email'' =&gt; $result[''email''],\r\n				 				''affiliate_id'' =&gt; $result[''affiliate_id'']\r\n	   						); ]]&gt;&lt;/add&gt;\r\n	&lt;/operation&gt;\r\n	&lt;operation info=&quot;affiliate&quot;&gt;\r\n		&lt;search position=&quot;replace&quot;&gt;&lt;![CDATA[\r\n			$emails[] = $affiliate_info[''email'']; ]]&gt;&lt;/search&gt;\r\n		&lt;add&gt;&lt;![CDATA[ $emails[$affiliate_info[''affiliate_id'']] = array(\r\n				   					''affiliate'' =&gt; $affiliate_info,\r\n				   					''email'' =&gt; $affiliate_info[''email''],\r\n				   					''affiliate_id'' =&gt; $affiliate_info[''affiliate_id'']\r\n				  				); ]]&gt;&lt;/add&gt;\r\n	&lt;/operation&gt;\r\n	&lt;operation info=&quot;newsletter, customer_all, product&quot;&gt;\r\n		&lt;search position=&quot;replace&quot;&gt;&lt;![CDATA[\r\n			$emails[] = $result[''email'']; ]]&gt;&lt;/search&gt;\r\n		&lt;add&gt;&lt;![CDATA[ $emails[$result[''customer_id'']] = array(\r\n				 					''email'' =&gt; $result[''email''],\r\n				 					''customer_id'' =&gt; $result[''customer_id''],\r\n				 					''store_id'' =&gt; $result[''store_id''],\r\n				 					''language_id'' =&gt; $result[''language_id'']\r\n								); ]]&gt;&lt;/add&gt;\r\n	&lt;/operation&gt;\r\n	\r\n	&lt;operation info=&quot;Move message into foreach&quot;&gt;\r\n		&lt;search position=&quot;replace&quot;&gt;&lt;![CDATA[\r\n            foreach ($emails as $email) { ]]&gt;&lt;/search&gt;\r\n		&lt;add&gt;&lt;/add&gt;\r\n	&lt;/operation&gt;  \r\n	&lt;operation&gt;\r\n		&lt;search position=&quot;before&quot;&gt;&lt;![CDATA[\r\n            $message  = ''&lt;html  ]]&gt;&lt;/search&gt;\r\n		&lt;add&gt;&lt;![CDATA[				$template = new EmailTemplate($this-&gt;request, $this-&gt;registry);\r\n					\r\n				foreach ($emails as $email) {\r\n					if(empty($email[''customer_id'']) &amp;&amp; empty($email[''affiliate_id''])) continue;\r\n            \r\n					if(isset($email[''customer''])){\r\n						$template-&gt;addData($email[''customer'']);\r\n						unset($email[''customer'']);\r\n					} elseif(isset($email[''customer_id''])){\r\n						$customer_info = $this-&gt;model_sale_customer-&gt;getCustomer($email[''customer_id'']);\r\n						$template-&gt;addData($customer_info);\r\n					}\r\n\r\n					if(isset($email[''affiliate''])){\r\n						$template-&gt;addData($email[''affiliate'']);\r\n						unset($email[''affiliate'']);\r\n					} elseif(isset($email[''affiliate_id''])){\r\n						$affiliate_info = $this-&gt;model_sale_affiliate-&gt;getAffiliate($email[''affiliate_id'']);\r\n						$template-&gt;addData($affiliate_info);\r\n					}\r\n\r\n					if(isset($email[''language_id'']) &amp;&amp; $email[''language_id'']){\r\n						$language_id = $email[''language_id''];\r\n					} else {\r\n						$language_id = $this-&gt;config-&gt;get(''config_language_id'');\r\n					}\r\n			\r\n					if(isset($email[''store_id''])){\r\n						$store_id = $email[''store_id''];\r\n					} else {\r\n						$store_id = $this-&gt;config-&gt;get(''config_store_id'');\r\n					}\r\n\r\n					$subject = $this-&gt;request-&gt;post[''subject''][$language_id];\r\n					if(!$subject){\r\n						$subject = $store_name;\r\n					}\r\n					$template-&gt;set(''subject'', $subject);\r\n\r\n					$body = $this-&gt;request-&gt;post[''message''][$language_id];\r\n\r\n					$template-&gt;addData($email); ]]&gt;&lt;/add&gt;\r\n	&lt;/operation&gt;\r\n	&lt;operation error=&quot;skip&quot;&gt;\r\n		&lt;search position=&quot;replace&quot;&gt;&lt;![CDATA[\r\n            &lt;title&gt;'' . $this-&gt;request-&gt;post[''subject''] . ''&lt;/title&gt;'' ]]&gt;&lt;/search&gt;\r\n		&lt;add trim=&quot;true&quot;&gt;&lt;![CDATA[ \r\n			&lt;title&gt;'' . $subject . ''&lt;/title&gt;'' ]]&gt;&lt;/add&gt;\r\n	&lt;/operation&gt;\r\n	&lt;operation error=&quot;skip&quot;&gt;\r\n		&lt;search position=&quot;replace&quot;&gt;&lt;![CDATA[\r\n            $mail-&gt;setSubject(html_entity_decode($this-&gt;request-&gt;post[''subject''] ]]&gt;&lt;/search&gt;\r\n		&lt;add trim=&quot;true&quot;&gt;&lt;![CDATA[ \r\n			$mail-&gt;setSubject(html_entity_decode($subject ]]&gt;&lt;/add&gt;\r\n	&lt;/operation&gt;\r\n	&lt;operation error=&quot;skip&quot;&gt;\r\n		&lt;search position=&quot;replace&quot;&gt;&lt;![CDATA[\r\n            $mail-&gt;setSubject($this-&gt;request-&gt;post[''subject''] ]]&gt;&lt;/search&gt;\r\n		&lt;add trim=&quot;true&quot;&gt;&lt;![CDATA[ \r\n			$mail-&gt;setSubject($subject ]]&gt;&lt;/add&gt;\r\n	&lt;/operation&gt;\r\n	&lt;operation&gt;\r\n		&lt;search position=&quot;replace&quot;&gt;&lt;![CDATA[\r\n            html_entity_decode($this-&gt;request-&gt;post[''message'']  ]]&gt;&lt;/search&gt;\r\n		&lt;add trim=&quot;true&quot;&gt;&lt;![CDATA[ \r\n			html_entity_decode($message ]]&gt;&lt;/add&gt;\r\n	&lt;/operation&gt;\r\n	&lt;operation&gt;\r\n		&lt;search position=&quot;replace&quot;&gt;&lt;![CDATA[\r\n            $mail-&gt;setHtml($message); ]]&gt;&lt;/search&gt;\r\n		&lt;add&gt;&lt;![CDATA[						\r\n						$template_data = array(\r\n							''key'' =&gt; ''admin.newsletter'',\r\n							''store_id'' =&gt; $email[''store_id'']\r\n						);\r\n\r\n						$template-&gt;load($template_data);\r\n							\r\n						$template-&gt;build();\r\n\r\n						if($this-&gt;request-&gt;post[''campaign_name'']){\r\n							$template-&gt;data[''emailtemplate_config''][''utm_campaign''] = $this-&gt;request-&gt;post[''campaign_name''];\r\n						}\r\n\r\n						if(!empty($template-&gt;data[''emailtemplate''][''unsubscribe_text'']) &amp;&amp; in_array($this-&gt;request-&gt;post[''to''], array(''newsletter'', ''customer_all'', ''customer_group'', ''customer''))) {\r\n							$url = (isset($store_info[''url'']) ? $store_info[''url''] : HTTP_CATALOG) . ''index.php?route=account/newsletter/unsubscribe&amp;code=''.md5($email[''email'']);\r\n							$template-&gt;data[''unsubscribe''] = sprintf(html_entity_decode($template-&gt;data[''emailtemplate''][''unsubscribe_text''], ENT_QUOTES, ''UTF-8''), $url);\r\n					    }\r\n\r\n						$template-&gt;fetch(null, $body);\r\n			\r\n						$mail = $template-&gt;hook($mail); ]]&gt;&lt;/add&gt;\r\n	&lt;/operation&gt;\r\n	&lt;operation error=&quot;skip&quot;&gt;\r\n		&lt;search position=&quot;replace&quot;&gt;&lt;![CDATA[\r\n            $mail-&gt;addAttachment($attachment[''path''], $attachment[''filename'']); ]]&gt;&lt;/search&gt;\r\n		&lt;add&gt;&lt;/add&gt;\r\n	&lt;/operation&gt;        \r\n&lt;/file&gt;\r\n	\r\n&lt;file name=&quot;admin/view/template/sale/contact.tpl&quot;&gt;\r\n	&lt;operation info=&quot;Remove subject, add template&quot;&gt;\r\n		&lt;search position=&quot;replace&quot;&gt;&lt;![CDATA[\r\n            &lt;td&gt;&lt;span class=&quot;required&quot;&gt;*&lt;/span&gt; &lt;?php echo $entry_subject; ?&gt;&lt;/td&gt; ]]&gt;&lt;/search&gt;\r\n		&lt;add&gt;&lt;![CDATA[ \r\n		&lt;?php if(!empty($templates_options)){ ?&gt;\r\n            &lt;td&gt;&lt;?php echo $entry_template; ?&gt;&lt;/td&gt; ]]&gt;&lt;/add&gt;\r\n	&lt;/operation&gt;\r\n	&lt;operation&gt;\r\n		&lt;search regex=&quot;true&quot; position=&quot;replace&quot;&gt;&lt;![CDATA[~&lt;td&gt;&lt;input type=&quot;text&quot; name=&quot;subject&quot; value=&quot;.*?&quot; /&gt;&lt;/td&gt;~]]&gt;&lt;/search&gt;\r\n		&lt;add&gt;&lt;![CDATA[ \r\n			&lt;td&gt;\r\n            	&lt;select id=&quot;field_templates&quot; name=&quot;email_template&quot;&gt;\r\n					&lt;option value=''''&gt;&lt;?php echo $text_select; ?&gt;&lt;/option&gt;\r\n					&lt;?php foreach($templates_options as $item){ ?&gt;\r\n						&lt;option value=&quot;&lt;?php echo $item[''value'']; ?&gt;&quot;&gt;&lt;?php echo $item[''label'']; ?&gt;&lt;/option&gt;\r\n					&lt;?php } ?&gt;\r\n				&lt;/select&gt;\r\n			&lt;/td&gt;\r\n		  &lt;/tr&gt;\r\n		  &lt;tr&gt;\r\n		&lt;?php } ?&gt;           \r\n            &lt;td&gt;&lt;?php echo $entry_campaign_name; ?&gt;&lt;/td&gt;\r\n            &lt;td&gt;&lt;input value=&quot;&lt;?php echo $campaign_name; ?&gt;&quot; name=&quot;campaign_name&quot; type=&quot;text&quot; /&gt; ]]&gt;&lt;/add&gt;\r\n	&lt;/operation&gt;\r\n	&lt;operation info=&quot;Remove message&quot;&gt;\r\n		&lt;search position=&quot;replace&quot;&gt;&lt;![CDATA[\r\n            &lt;td&gt;&lt;span class=&quot;required&quot;&gt;*&lt;/span&gt; &lt;?php echo $entry_message; ?&gt;&lt;/td&gt; ]]&gt;&lt;/search&gt;\r\n		&lt;add&gt;&lt;/add&gt;\r\n	&lt;/operation&gt;\r\n	&lt;operation info=&quot;Remove message&quot;&gt;\r\n		&lt;search regex=&quot;true&quot; position=&quot;replace&quot;&gt;&lt;![CDATA[~&lt;td&gt;&lt;textarea name=&quot;message&quot;&gt;.*?&lt;/textarea&gt;~]]&gt;&lt;/search&gt;\r\n		&lt;search position=&quot;replace&quot;&gt;&lt;![CDATA[\r\n			 ]]&gt;&lt;/search&gt;\r\n		&lt;add&gt;&lt;![CDATA[		\r\n		&lt;/tr&gt;\r\n   &lt;/table&gt;\r\n\r\n		&lt;div id=&quot;languages&quot; class=&quot;htabs&quot;&gt;\r\n			&lt;?php foreach ($languages as $language) { ?&gt;\r\n				&lt;a href=&quot;#language&lt;?php echo $language[''language_id'']; ?&gt;&quot;&gt;\r\n					&lt;img src=&quot;view/image/flags/&lt;?php echo $language[''image'']; ?&gt;&quot; title=&quot;&lt;?php echo $language[''name'']; ?&gt;&quot; /&gt; \r\n					&lt;?php echo $language[''name'']; ?&gt;\r\n				&lt;/a&gt;\r\n			&lt;?php } ?&gt;\r\n		&lt;/div&gt;\r\n\r\n		&lt;?php foreach ($languages as $language) { ?&gt;\r\n			&lt;div id=&quot;language&lt;?php echo $language[''language_id'']; ?&gt;&quot;&gt;\r\n				&lt;table class=&quot;form&quot;&gt;\r\n					&lt;tr&gt;\r\n						&lt;td&gt;&lt;span class=&quot;required&quot;&gt;*&lt;/span&gt; &lt;?php echo $entry_subject; ?&gt;&lt;/td&gt;\r\n                		&lt;td&gt;&lt;input type=&quot;text&quot; name=&quot;subject[&lt;?php echo $language[''language_id'']; ?&gt;]&quot; value=&quot;&quot; style=&quot;width:100%; max-width:500px&quot; /&gt;&lt;/td&gt;\r\n              		&lt;/tr&gt;\r\n              		&lt;tr&gt;\r\n                		&lt;td&gt;&lt;span class=&quot;required&quot;&gt;*&lt;/span&gt; &lt;?php echo $entry_message; ?&gt;&lt;/td&gt;\r\n                		&lt;td&gt;&lt;textarea name=&quot;message[&lt;?php echo $language[''language_id'']; ?&gt;]&quot; id=&quot;message_&lt;?php echo $language[''language_id'']; ?&gt;&quot;&gt;&lt;/textarea&gt;&lt;/td&gt;\r\n					&lt;/tr&gt;\r\n				&lt;/table&gt;\r\n			&lt;/div&gt;\r\n		&lt;?php } ?&gt;\r\n	&lt;table class=&quot;form&quot;&gt;\r\n		&lt;tr&gt;&lt;td&gt; ]]&gt;&lt;/add&gt;\r\n	&lt;/operation&gt;\r\n	&lt;operation info=&quot;Remove ckeditor so that we can add with languages&quot; error=&quot;skip&quot;&gt;\r\n		&lt;search position=&quot;replace&quot; offset=&quot;7&quot;&gt;&lt;![CDATA[\r\n            CKEDITOR.replace(''message'', { ]]&gt;&lt;/search&gt;\r\n		&lt;add&gt;&lt;/add&gt;\r\n	&lt;/operation&gt;\r\n	&lt;operation info=&quot;Remove ckeditor so that we can add with languages&quot; error=&quot;skip&quot;&gt;\r\n		&lt;search position=&quot;replace&quot; offset=&quot;7&quot;&gt;&lt;![CDATA[\r\n            $(''textarea[name=\\''message\\'']'').ckeditor({ ]]&gt;&lt;/search&gt;\r\n		&lt;add&gt;&lt;/add&gt;\r\n	&lt;/operation&gt;\r\n	&lt;operation error=&quot;skip&quot;&gt;\r\n    	&lt;search position=&quot;replace&quot;&gt;&lt;![CDATA[\r\n			$(''textarea[name=&quot;message&quot;]'').val(CKEDITOR.instances.message.getData()); ]]&gt;&lt;/search&gt;\r\n		&lt;add&gt;&lt;![CDATA[\r\n			for(var instanceName in CKEDITOR.instances){\r\n				CKEDITOR.instances[instanceName].updateElement();\r\n			} ]]&gt;&lt;/add&gt;\r\n	&lt;/operation&gt;\r\n	&lt;operation error=&quot;skip&quot;&gt;\r\n		&lt;search position=&quot;before&quot;&gt;&lt;![CDATA[\r\n            function send(url) { ]]&gt;&lt;/search&gt;\r\n		&lt;add&gt;&lt;![CDATA[\r\n$(''#languages a'').tabs();\r\n \r\n&lt;?php foreach ($languages as $language) { ?&gt;\r\nCKEDITOR.replace(''message_&lt;?php echo $language[''language_id'']; ?&gt;'', {\r\n	filebrowserBrowseUrl: ''index.php?route=common/filemanager&amp;token=&lt;?php echo $token; ?&gt;'',\r\n	filebrowserImageBrowseUrl: ''index.php?route=common/filemanager&amp;token=&lt;?php echo $token; ?&gt;'',\r\n	filebrowserFlashBrowseUrl: ''index.php?route=common/filemanager&amp;token=&lt;?php echo $token; ?&gt;'',\r\n	filebrowserUploadUrl: ''index.php?route=common/filemanager&amp;token=&lt;?php echo $token; ?&gt;'',\r\n	filebrowserImageUploadUrl: ''index.php?route=common/filemanager&amp;token=&lt;?php echo $token; ?&gt;'',\r\n	filebrowserFlashUploadUrl: ''index.php?route=common/filemanager&amp;token=&lt;?php echo $token; ?&gt;''\r\n});\r\n&lt;?php } ?&gt;\r\n\r\n// Output dimensions of images as width and height\r\nCKEDITOR.on(''instanceReady'', function (ev) {\r\n	ev.editor.dataProcessor.htmlFilter.addRules({\r\n        elements: {\r\n            $: function(element){                \r\n                if (element.name == ''img'') {\r\n                    var style = element.attributes.style;\r\n\r\n                    if (style) {\r\n                        // Get the width from the style.\r\n                        var match = /(?:^|\\s)width\\s*:\\s*(\\d+)px/i.exec(style),\r\n                            width = match &amp;&amp; match[1];\r\n\r\n                        // Get the height from the style.\r\n                        match = /(?:^|\\s)height\\s*:\\s*(\\d+)px/i.exec(style);\r\n                        var height = match &amp;&amp; match[1];\r\n\r\n                        if (width) {\r\n                            element.attributes.style = element.attributes.style.replace(/(?:^|\\s)width\\s*:\\s*(\\d+)px;?/i, '''');\r\n                            element.attributes.width = width;\r\n                        }\r\n\r\n                        if (height) {\r\n                            element.attributes.style = element.attributes.style.replace(/(?:^|\\s)height\\s*:\\s*(\\d+)px;?/i, '''');\r\n                            element.attributes.height = height;\r\n                        }\r\n                    }\r\n                }\r\n\r\n                if (!element.attributes.style) delete element.attributes.style;\r\n\r\n                return element;\r\n            }\r\n        }\r\n    });\r\n});\r\n\r\n(function($){			\r\n	$(document).ready(function() {\r\n				\r\n		$(''select#field_templates'').change(function(){\r\n			var val = $(this).val(), \r\n				language_id, \r\n				store_id = $(''select[name=store_id]'').val();\r\n\r\n			if(!val || !confirm(&quot;&lt;?php echo $warning_template_content; ?&gt;&quot;)) return;\r\n\r\n			$.ajax({ \r\n				url: ''&lt;?php echo html_entity_decode($templates_action); ?&gt;'',\r\n				type: ''get'',\r\n				data: ''id='' + val + ''&amp;store_id='' + store_id,\r\n				dataType: ''json'',\r\n				success: function(json) {\r\n					for(i in json) {\r\n 						language_id = json[i][''language_id''];\r\n						\r\n 						if(json[i][''emailtemplate''][''subject'']){\r\n							$(&quot;input[name=''subject[&quot; + language_id + &quot;]'']&quot;).val(json[i][''emailtemplate''][''subject'']);\r\n						}\r\n\r\n						editor = CKEDITOR.instances[&quot;message_&quot; + language_id];\r\n						editor.setData(json[i][''emailtemplate''][''comment'']);\r\n					}\r\n				},\r\n				error: function(xhr, ajaxOptions, thrownError) {\r\n                    console.log(thrownError + &quot;\\r\\n&quot; + xhr.statusText + &quot;\\r\\n&quot; + xhr.responseText);\r\n                    alert(''Error. More details in console.'');\r\n            	}\r\n			});	\r\n		});\r\n					\r\n });	// doc.ready\r\n})(jQuery); ]]&gt;&lt;/add&gt;\r\n	&lt;/operation&gt;\r\n&lt;/file&gt;' 
 WHERE `emailtemplate_default` = 1 AND `emailtemplate_key` = 'admin.newsletter';
 